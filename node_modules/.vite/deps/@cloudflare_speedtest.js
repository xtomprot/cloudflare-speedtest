import {
  __commonJS,
  __esm,
  __export,
  __toCommonJS,
  __toESM
} from "./chunk-V4OQ3NZ2.js";

// node_modules/whatwg-fetch/fetch.js
var fetch_exports = {};
__export(fetch_exports, {
  DOMException: () => DOMException,
  Headers: () => Headers,
  Request: () => Request,
  Response: () => Response,
  fetch: () => fetch2
});
function isDataView(obj) {
  return obj && DataView.prototype.isPrototypeOf(obj);
}
function normalizeName(name) {
  if (typeof name !== "string") {
    name = String(name);
  }
  if (/[^a-z0-9\-#$%&'*+.^_`|~!]/i.test(name) || name === "") {
    throw new TypeError('Invalid character in header field name: "' + name + '"');
  }
  return name.toLowerCase();
}
function normalizeValue(value) {
  if (typeof value !== "string") {
    value = String(value);
  }
  return value;
}
function iteratorFor(items) {
  var iterator = {
    next: function() {
      var value = items.shift();
      return { done: value === void 0, value };
    }
  };
  if (support.iterable) {
    iterator[Symbol.iterator] = function() {
      return iterator;
    };
  }
  return iterator;
}
function Headers(headers) {
  this.map = {};
  if (headers instanceof Headers) {
    headers.forEach(function(value, name) {
      this.append(name, value);
    }, this);
  } else if (Array.isArray(headers)) {
    headers.forEach(function(header) {
      if (header.length != 2) {
        throw new TypeError("Headers constructor: expected name/value pair to be length 2, found" + header.length);
      }
      this.append(header[0], header[1]);
    }, this);
  } else if (headers) {
    Object.getOwnPropertyNames(headers).forEach(function(name) {
      this.append(name, headers[name]);
    }, this);
  }
}
function consumed(body) {
  if (body._noBody) return;
  if (body.bodyUsed) {
    return Promise.reject(new TypeError("Already read"));
  }
  body.bodyUsed = true;
}
function fileReaderReady(reader) {
  return new Promise(function(resolve, reject) {
    reader.onload = function() {
      resolve(reader.result);
    };
    reader.onerror = function() {
      reject(reader.error);
    };
  });
}
function readBlobAsArrayBuffer(blob) {
  var reader = new FileReader();
  var promise = fileReaderReady(reader);
  reader.readAsArrayBuffer(blob);
  return promise;
}
function readBlobAsText(blob) {
  var reader = new FileReader();
  var promise = fileReaderReady(reader);
  var match = /charset=([A-Za-z0-9_-]+)/.exec(blob.type);
  var encoding = match ? match[1] : "utf-8";
  reader.readAsText(blob, encoding);
  return promise;
}
function readArrayBufferAsText(buf) {
  var view = new Uint8Array(buf);
  var chars = new Array(view.length);
  for (var i = 0; i < view.length; i++) {
    chars[i] = String.fromCharCode(view[i]);
  }
  return chars.join("");
}
function bufferClone(buf) {
  if (buf.slice) {
    return buf.slice(0);
  } else {
    var view = new Uint8Array(buf.byteLength);
    view.set(new Uint8Array(buf));
    return view.buffer;
  }
}
function Body() {
  this.bodyUsed = false;
  this._initBody = function(body) {
    this.bodyUsed = this.bodyUsed;
    this._bodyInit = body;
    if (!body) {
      this._noBody = true;
      this._bodyText = "";
    } else if (typeof body === "string") {
      this._bodyText = body;
    } else if (support.blob && Blob.prototype.isPrototypeOf(body)) {
      this._bodyBlob = body;
    } else if (support.formData && FormData.prototype.isPrototypeOf(body)) {
      this._bodyFormData = body;
    } else if (support.searchParams && URLSearchParams.prototype.isPrototypeOf(body)) {
      this._bodyText = body.toString();
    } else if (support.arrayBuffer && support.blob && isDataView(body)) {
      this._bodyArrayBuffer = bufferClone(body.buffer);
      this._bodyInit = new Blob([this._bodyArrayBuffer]);
    } else if (support.arrayBuffer && (ArrayBuffer.prototype.isPrototypeOf(body) || isArrayBufferView(body))) {
      this._bodyArrayBuffer = bufferClone(body);
    } else {
      this._bodyText = body = Object.prototype.toString.call(body);
    }
    if (!this.headers.get("content-type")) {
      if (typeof body === "string") {
        this.headers.set("content-type", "text/plain;charset=UTF-8");
      } else if (this._bodyBlob && this._bodyBlob.type) {
        this.headers.set("content-type", this._bodyBlob.type);
      } else if (support.searchParams && URLSearchParams.prototype.isPrototypeOf(body)) {
        this.headers.set("content-type", "application/x-www-form-urlencoded;charset=UTF-8");
      }
    }
  };
  if (support.blob) {
    this.blob = function() {
      var rejected = consumed(this);
      if (rejected) {
        return rejected;
      }
      if (this._bodyBlob) {
        return Promise.resolve(this._bodyBlob);
      } else if (this._bodyArrayBuffer) {
        return Promise.resolve(new Blob([this._bodyArrayBuffer]));
      } else if (this._bodyFormData) {
        throw new Error("could not read FormData body as blob");
      } else {
        return Promise.resolve(new Blob([this._bodyText]));
      }
    };
  }
  this.arrayBuffer = function() {
    if (this._bodyArrayBuffer) {
      var isConsumed = consumed(this);
      if (isConsumed) {
        return isConsumed;
      } else if (ArrayBuffer.isView(this._bodyArrayBuffer)) {
        return Promise.resolve(
          this._bodyArrayBuffer.buffer.slice(
            this._bodyArrayBuffer.byteOffset,
            this._bodyArrayBuffer.byteOffset + this._bodyArrayBuffer.byteLength
          )
        );
      } else {
        return Promise.resolve(this._bodyArrayBuffer);
      }
    } else if (support.blob) {
      return this.blob().then(readBlobAsArrayBuffer);
    } else {
      throw new Error("could not read as ArrayBuffer");
    }
  };
  this.text = function() {
    var rejected = consumed(this);
    if (rejected) {
      return rejected;
    }
    if (this._bodyBlob) {
      return readBlobAsText(this._bodyBlob);
    } else if (this._bodyArrayBuffer) {
      return Promise.resolve(readArrayBufferAsText(this._bodyArrayBuffer));
    } else if (this._bodyFormData) {
      throw new Error("could not read FormData body as text");
    } else {
      return Promise.resolve(this._bodyText);
    }
  };
  if (support.formData) {
    this.formData = function() {
      return this.text().then(decode);
    };
  }
  this.json = function() {
    return this.text().then(JSON.parse);
  };
  return this;
}
function normalizeMethod(method) {
  var upcased = method.toUpperCase();
  return methods.indexOf(upcased) > -1 ? upcased : method;
}
function Request(input, options) {
  if (!(this instanceof Request)) {
    throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');
  }
  options = options || {};
  var body = options.body;
  if (input instanceof Request) {
    if (input.bodyUsed) {
      throw new TypeError("Already read");
    }
    this.url = input.url;
    this.credentials = input.credentials;
    if (!options.headers) {
      this.headers = new Headers(input.headers);
    }
    this.method = input.method;
    this.mode = input.mode;
    this.signal = input.signal;
    if (!body && input._bodyInit != null) {
      body = input._bodyInit;
      input.bodyUsed = true;
    }
  } else {
    this.url = String(input);
  }
  this.credentials = options.credentials || this.credentials || "same-origin";
  if (options.headers || !this.headers) {
    this.headers = new Headers(options.headers);
  }
  this.method = normalizeMethod(options.method || this.method || "GET");
  this.mode = options.mode || this.mode || null;
  this.signal = options.signal || this.signal || (function() {
    if ("AbortController" in g) {
      var ctrl = new AbortController();
      return ctrl.signal;
    }
  })();
  this.referrer = null;
  if ((this.method === "GET" || this.method === "HEAD") && body) {
    throw new TypeError("Body not allowed for GET or HEAD requests");
  }
  this._initBody(body);
  if (this.method === "GET" || this.method === "HEAD") {
    if (options.cache === "no-store" || options.cache === "no-cache") {
      var reParamSearch = /([?&])_=[^&]*/;
      if (reParamSearch.test(this.url)) {
        this.url = this.url.replace(reParamSearch, "$1_=" + (/* @__PURE__ */ new Date()).getTime());
      } else {
        var reQueryString = /\?/;
        this.url += (reQueryString.test(this.url) ? "&" : "?") + "_=" + (/* @__PURE__ */ new Date()).getTime();
      }
    }
  }
}
function decode(body) {
  var form = new FormData();
  body.trim().split("&").forEach(function(bytes) {
    if (bytes) {
      var split = bytes.split("=");
      var name = split.shift().replace(/\+/g, " ");
      var value = split.join("=").replace(/\+/g, " ");
      form.append(decodeURIComponent(name), decodeURIComponent(value));
    }
  });
  return form;
}
function parseHeaders(rawHeaders) {
  var headers = new Headers();
  var preProcessedHeaders = rawHeaders.replace(/\r?\n[\t ]+/g, " ");
  preProcessedHeaders.split("\r").map(function(header) {
    return header.indexOf("\n") === 0 ? header.substr(1, header.length) : header;
  }).forEach(function(line) {
    var parts = line.split(":");
    var key = parts.shift().trim();
    if (key) {
      var value = parts.join(":").trim();
      try {
        headers.append(key, value);
      } catch (error) {
        console.warn("Response " + error.message);
      }
    }
  });
  return headers;
}
function Response(bodyInit, options) {
  if (!(this instanceof Response)) {
    throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');
  }
  if (!options) {
    options = {};
  }
  this.type = "default";
  this.status = options.status === void 0 ? 200 : options.status;
  if (this.status < 200 || this.status > 599) {
    throw new RangeError("Failed to construct 'Response': The status provided (0) is outside the range [200, 599].");
  }
  this.ok = this.status >= 200 && this.status < 300;
  this.statusText = options.statusText === void 0 ? "" : "" + options.statusText;
  this.headers = new Headers(options.headers);
  this.url = options.url || "";
  this._initBody(bodyInit);
}
function fetch2(input, init) {
  return new Promise(function(resolve, reject) {
    var request = new Request(input, init);
    if (request.signal && request.signal.aborted) {
      return reject(new DOMException("Aborted", "AbortError"));
    }
    var xhr = new XMLHttpRequest();
    function abortXhr() {
      xhr.abort();
    }
    xhr.onload = function() {
      var options = {
        statusText: xhr.statusText,
        headers: parseHeaders(xhr.getAllResponseHeaders() || "")
      };
      if (request.url.indexOf("file://") === 0 && (xhr.status < 200 || xhr.status > 599)) {
        options.status = 200;
      } else {
        options.status = xhr.status;
      }
      options.url = "responseURL" in xhr ? xhr.responseURL : options.headers.get("X-Request-URL");
      var body = "response" in xhr ? xhr.response : xhr.responseText;
      setTimeout(function() {
        resolve(new Response(body, options));
      }, 0);
    };
    xhr.onerror = function() {
      setTimeout(function() {
        reject(new TypeError("Network request failed"));
      }, 0);
    };
    xhr.ontimeout = function() {
      setTimeout(function() {
        reject(new TypeError("Network request timed out"));
      }, 0);
    };
    xhr.onabort = function() {
      setTimeout(function() {
        reject(new DOMException("Aborted", "AbortError"));
      }, 0);
    };
    function fixUrl(url) {
      try {
        return url === "" && g.location.href ? g.location.href : url;
      } catch (e) {
        return url;
      }
    }
    xhr.open(request.method, fixUrl(request.url), true);
    if (request.credentials === "include") {
      xhr.withCredentials = true;
    } else if (request.credentials === "omit") {
      xhr.withCredentials = false;
    }
    if ("responseType" in xhr) {
      if (support.blob) {
        xhr.responseType = "blob";
      } else if (support.arrayBuffer) {
        xhr.responseType = "arraybuffer";
      }
    }
    if (init && typeof init.headers === "object" && !(init.headers instanceof Headers || g.Headers && init.headers instanceof g.Headers)) {
      var names = [];
      Object.getOwnPropertyNames(init.headers).forEach(function(name) {
        names.push(normalizeName(name));
        xhr.setRequestHeader(name, normalizeValue(init.headers[name]));
      });
      request.headers.forEach(function(value, name) {
        if (names.indexOf(name) === -1) {
          xhr.setRequestHeader(name, value);
        }
      });
    } else {
      request.headers.forEach(function(value, name) {
        xhr.setRequestHeader(name, value);
      });
    }
    if (request.signal) {
      request.signal.addEventListener("abort", abortXhr);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          request.signal.removeEventListener("abort", abortXhr);
        }
      };
    }
    xhr.send(typeof request._bodyInit === "undefined" ? null : request._bodyInit);
  });
}
var g, support, viewClasses, isArrayBufferView, methods, redirectStatuses, DOMException;
var init_fetch = __esm({
  "node_modules/whatwg-fetch/fetch.js"() {
    g = typeof globalThis !== "undefined" && globalThis || typeof self !== "undefined" && self || // eslint-disable-next-line no-undef
    typeof global !== "undefined" && global || {};
    support = {
      searchParams: "URLSearchParams" in g,
      iterable: "Symbol" in g && "iterator" in Symbol,
      blob: "FileReader" in g && "Blob" in g && (function() {
        try {
          new Blob();
          return true;
        } catch (e) {
          return false;
        }
      })(),
      formData: "FormData" in g,
      arrayBuffer: "ArrayBuffer" in g
    };
    if (support.arrayBuffer) {
      viewClasses = [
        "[object Int8Array]",
        "[object Uint8Array]",
        "[object Uint8ClampedArray]",
        "[object Int16Array]",
        "[object Uint16Array]",
        "[object Int32Array]",
        "[object Uint32Array]",
        "[object Float32Array]",
        "[object Float64Array]"
      ];
      isArrayBufferView = ArrayBuffer.isView || function(obj) {
        return obj && viewClasses.indexOf(Object.prototype.toString.call(obj)) > -1;
      };
    }
    Headers.prototype.append = function(name, value) {
      name = normalizeName(name);
      value = normalizeValue(value);
      var oldValue = this.map[name];
      this.map[name] = oldValue ? oldValue + ", " + value : value;
    };
    Headers.prototype["delete"] = function(name) {
      delete this.map[normalizeName(name)];
    };
    Headers.prototype.get = function(name) {
      name = normalizeName(name);
      return this.has(name) ? this.map[name] : null;
    };
    Headers.prototype.has = function(name) {
      return this.map.hasOwnProperty(normalizeName(name));
    };
    Headers.prototype.set = function(name, value) {
      this.map[normalizeName(name)] = normalizeValue(value);
    };
    Headers.prototype.forEach = function(callback, thisArg) {
      for (var name in this.map) {
        if (this.map.hasOwnProperty(name)) {
          callback.call(thisArg, this.map[name], name, this);
        }
      }
    };
    Headers.prototype.keys = function() {
      var items = [];
      this.forEach(function(value, name) {
        items.push(name);
      });
      return iteratorFor(items);
    };
    Headers.prototype.values = function() {
      var items = [];
      this.forEach(function(value) {
        items.push(value);
      });
      return iteratorFor(items);
    };
    Headers.prototype.entries = function() {
      var items = [];
      this.forEach(function(value, name) {
        items.push([name, value]);
      });
      return iteratorFor(items);
    };
    if (support.iterable) {
      Headers.prototype[Symbol.iterator] = Headers.prototype.entries;
    }
    methods = ["CONNECT", "DELETE", "GET", "HEAD", "OPTIONS", "PATCH", "POST", "PUT", "TRACE"];
    Request.prototype.clone = function() {
      return new Request(this, { body: this._bodyInit });
    };
    Body.call(Request.prototype);
    Body.call(Response.prototype);
    Response.prototype.clone = function() {
      return new Response(this._bodyInit, {
        status: this.status,
        statusText: this.statusText,
        headers: new Headers(this.headers),
        url: this.url
      });
    };
    Response.error = function() {
      var response = new Response(null, { status: 200, statusText: "" });
      response.ok = false;
      response.status = 0;
      response.type = "error";
      return response;
    };
    redirectStatuses = [301, 302, 303, 307, 308];
    Response.redirect = function(url, status) {
      if (redirectStatuses.indexOf(status) === -1) {
        throw new RangeError("Invalid status code");
      }
      return new Response(null, { status, headers: { location: url } });
    };
    DOMException = g.DOMException;
    try {
      new DOMException();
    } catch (err) {
      DOMException = function(message, name) {
        this.message = message;
        this.name = name;
        var error = Error(message);
        this.stack = error.stack;
      };
      DOMException.prototype = Object.create(Error.prototype);
      DOMException.prototype.constructor = DOMException;
    }
    fetch2.polyfill = true;
    if (!g.fetch) {
      g.fetch = fetch2;
      g.Headers = Headers;
      g.Request = Request;
      g.Response = Response;
    }
  }
});

// node_modules/isomorphic-fetch/fetch-npm-browserify.js
var require_fetch_npm_browserify = __commonJS({
  "node_modules/isomorphic-fetch/fetch-npm-browserify.js"(exports, module) {
    init_fetch();
    module.exports = self.fetch.bind(self);
  }
});

// node_modules/lodash.memoize/index.js
var require_lodash = __commonJS({
  "node_modules/lodash.memoize/index.js"(exports, module) {
    var FUNC_ERROR_TEXT = "Expected a function";
    var HASH_UNDEFINED = "__lodash_hash_undefined__";
    var funcTag = "[object Function]";
    var genTag = "[object GeneratorFunction]";
    var reRegExpChar = /[\\^$.*+?()[\]{}|]/g;
    var reIsHostCtor = /^\[object .+?Constructor\]$/;
    var freeGlobal = typeof global == "object" && global && global.Object === Object && global;
    var freeSelf = typeof self == "object" && self && self.Object === Object && self;
    var root = freeGlobal || freeSelf || Function("return this")();
    function getValue(object, key) {
      return object == null ? void 0 : object[key];
    }
    function isHostObject(value) {
      var result = false;
      if (value != null && typeof value.toString != "function") {
        try {
          result = !!(value + "");
        } catch (e) {
        }
      }
      return result;
    }
    var arrayProto = Array.prototype;
    var funcProto = Function.prototype;
    var objectProto = Object.prototype;
    var coreJsData = root["__core-js_shared__"];
    var maskSrcKey = (function() {
      var uid = /[^.]+$/.exec(coreJsData && coreJsData.keys && coreJsData.keys.IE_PROTO || "");
      return uid ? "Symbol(src)_1." + uid : "";
    })();
    var funcToString = funcProto.toString;
    var hasOwnProperty = objectProto.hasOwnProperty;
    var objectToString = objectProto.toString;
    var reIsNative = RegExp(
      "^" + funcToString.call(hasOwnProperty).replace(reRegExpChar, "\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g, "$1.*?") + "$"
    );
    var splice = arrayProto.splice;
    var Map2 = getNative(root, "Map");
    var nativeCreate = getNative(Object, "create");
    function Hash(entries) {
      var index2 = -1, length = entries ? entries.length : 0;
      this.clear();
      while (++index2 < length) {
        var entry = entries[index2];
        this.set(entry[0], entry[1]);
      }
    }
    function hashClear() {
      this.__data__ = nativeCreate ? nativeCreate(null) : {};
    }
    function hashDelete(key) {
      return this.has(key) && delete this.__data__[key];
    }
    function hashGet(key) {
      var data = this.__data__;
      if (nativeCreate) {
        var result = data[key];
        return result === HASH_UNDEFINED ? void 0 : result;
      }
      return hasOwnProperty.call(data, key) ? data[key] : void 0;
    }
    function hashHas(key) {
      var data = this.__data__;
      return nativeCreate ? data[key] !== void 0 : hasOwnProperty.call(data, key);
    }
    function hashSet(key, value) {
      var data = this.__data__;
      data[key] = nativeCreate && value === void 0 ? HASH_UNDEFINED : value;
      return this;
    }
    Hash.prototype.clear = hashClear;
    Hash.prototype["delete"] = hashDelete;
    Hash.prototype.get = hashGet;
    Hash.prototype.has = hashHas;
    Hash.prototype.set = hashSet;
    function ListCache(entries) {
      var index2 = -1, length = entries ? entries.length : 0;
      this.clear();
      while (++index2 < length) {
        var entry = entries[index2];
        this.set(entry[0], entry[1]);
      }
    }
    function listCacheClear() {
      this.__data__ = [];
    }
    function listCacheDelete(key) {
      var data = this.__data__, index2 = assocIndexOf(data, key);
      if (index2 < 0) {
        return false;
      }
      var lastIndex = data.length - 1;
      if (index2 == lastIndex) {
        data.pop();
      } else {
        splice.call(data, index2, 1);
      }
      return true;
    }
    function listCacheGet(key) {
      var data = this.__data__, index2 = assocIndexOf(data, key);
      return index2 < 0 ? void 0 : data[index2][1];
    }
    function listCacheHas(key) {
      return assocIndexOf(this.__data__, key) > -1;
    }
    function listCacheSet(key, value) {
      var data = this.__data__, index2 = assocIndexOf(data, key);
      if (index2 < 0) {
        data.push([key, value]);
      } else {
        data[index2][1] = value;
      }
      return this;
    }
    ListCache.prototype.clear = listCacheClear;
    ListCache.prototype["delete"] = listCacheDelete;
    ListCache.prototype.get = listCacheGet;
    ListCache.prototype.has = listCacheHas;
    ListCache.prototype.set = listCacheSet;
    function MapCache(entries) {
      var index2 = -1, length = entries ? entries.length : 0;
      this.clear();
      while (++index2 < length) {
        var entry = entries[index2];
        this.set(entry[0], entry[1]);
      }
    }
    function mapCacheClear() {
      this.__data__ = {
        "hash": new Hash(),
        "map": new (Map2 || ListCache)(),
        "string": new Hash()
      };
    }
    function mapCacheDelete(key) {
      return getMapData(this, key)["delete"](key);
    }
    function mapCacheGet(key) {
      return getMapData(this, key).get(key);
    }
    function mapCacheHas(key) {
      return getMapData(this, key).has(key);
    }
    function mapCacheSet(key, value) {
      getMapData(this, key).set(key, value);
      return this;
    }
    MapCache.prototype.clear = mapCacheClear;
    MapCache.prototype["delete"] = mapCacheDelete;
    MapCache.prototype.get = mapCacheGet;
    MapCache.prototype.has = mapCacheHas;
    MapCache.prototype.set = mapCacheSet;
    function assocIndexOf(array2, key) {
      var length = array2.length;
      while (length--) {
        if (eq(array2[length][0], key)) {
          return length;
        }
      }
      return -1;
    }
    function baseIsNative(value) {
      if (!isObject(value) || isMasked(value)) {
        return false;
      }
      var pattern = isFunction(value) || isHostObject(value) ? reIsNative : reIsHostCtor;
      return pattern.test(toSource(value));
    }
    function getMapData(map4, key) {
      var data = map4.__data__;
      return isKeyable(key) ? data[typeof key == "string" ? "string" : "hash"] : data.map;
    }
    function getNative(object, key) {
      var value = getValue(object, key);
      return baseIsNative(value) ? value : void 0;
    }
    function isKeyable(value) {
      var type = typeof value;
      return type == "string" || type == "number" || type == "symbol" || type == "boolean" ? value !== "__proto__" : value === null;
    }
    function isMasked(func) {
      return !!maskSrcKey && maskSrcKey in func;
    }
    function toSource(func) {
      if (func != null) {
        try {
          return funcToString.call(func);
        } catch (e) {
        }
        try {
          return func + "";
        } catch (e) {
        }
      }
      return "";
    }
    function memoize2(func, resolver) {
      if (typeof func != "function" || resolver && typeof resolver != "function") {
        throw new TypeError(FUNC_ERROR_TEXT);
      }
      var memoized = function() {
        var args = arguments, key = resolver ? resolver.apply(this, args) : args[0], cache = memoized.cache;
        if (cache.has(key)) {
          return cache.get(key);
        }
        var result = func.apply(this, args);
        memoized.cache = cache.set(key, result);
        return result;
      };
      memoized.cache = new (memoize2.Cache || MapCache)();
      return memoized;
    }
    memoize2.Cache = MapCache;
    function eq(value, other) {
      return value === other || value !== value && other !== other;
    }
    function isFunction(value) {
      var tag = isObject(value) ? objectToString.call(value) : "";
      return tag == funcTag || tag == genTag;
    }
    function isObject(value) {
      var type = typeof value;
      return !!value && (type == "object" || type == "function");
    }
    module.exports = memoize2;
  }
});

// node_modules/@cloudflare/speedtest/dist/speedtest.js
var import_isomorphic_fetch = __toESM(require_fetch_npm_browserify());
var import_lodash = __toESM(require_lodash());

// node_modules/d3-array/src/ascending.js
function ascending(a, b) {
  return a == null || b == null ? NaN : a < b ? -1 : a > b ? 1 : a >= b ? 0 : NaN;
}

// node_modules/d3-array/src/descending.js
function descending(a, b) {
  return a == null || b == null ? NaN : b < a ? -1 : b > a ? 1 : b >= a ? 0 : NaN;
}

// node_modules/d3-array/src/bisector.js
function bisector(f) {
  let compare1, compare2, delta;
  if (f.length !== 2) {
    compare1 = ascending;
    compare2 = (d, x) => ascending(f(d), x);
    delta = (d, x) => f(d) - x;
  } else {
    compare1 = f === ascending || f === descending ? f : zero;
    compare2 = f;
    delta = f;
  }
  function left(a, x, lo = 0, hi = a.length) {
    if (lo < hi) {
      if (compare1(x, x) !== 0) return hi;
      do {
        const mid = lo + hi >>> 1;
        if (compare2(a[mid], x) < 0) lo = mid + 1;
        else hi = mid;
      } while (lo < hi);
    }
    return lo;
  }
  function right(a, x, lo = 0, hi = a.length) {
    if (lo < hi) {
      if (compare1(x, x) !== 0) return hi;
      do {
        const mid = lo + hi >>> 1;
        if (compare2(a[mid], x) <= 0) lo = mid + 1;
        else hi = mid;
      } while (lo < hi);
    }
    return lo;
  }
  function center(a, x, lo = 0, hi = a.length) {
    const i = left(a, x, lo, hi - 1);
    return i > lo && delta(a[i - 1], x) > -delta(a[i], x) ? i - 1 : i;
  }
  return { left, center, right };
}
function zero() {
  return 0;
}

// node_modules/d3-array/src/number.js
function number(x) {
  return x === null ? NaN : +x;
}

// node_modules/d3-array/src/bisect.js
var ascendingBisect = bisector(ascending);
var bisectRight = ascendingBisect.right;
var bisectLeft = ascendingBisect.left;
var bisectCenter = bisector(number).center;
var bisect_default = bisectRight;

// node_modules/d3-array/src/blur.js
var blur2 = Blur2(blurf);
var blurImage = Blur2(blurfImage);
function Blur2(blur3) {
  return function(data, rx, ry = rx) {
    if (!((rx = +rx) >= 0)) throw new RangeError("invalid rx");
    if (!((ry = +ry) >= 0)) throw new RangeError("invalid ry");
    let { data: values, width, height } = data;
    if (!((width = Math.floor(width)) >= 0)) throw new RangeError("invalid width");
    if (!((height = Math.floor(height !== void 0 ? height : values.length / width)) >= 0)) throw new RangeError("invalid height");
    if (!width || !height || !rx && !ry) return data;
    const blurx = rx && blur3(rx);
    const blury = ry && blur3(ry);
    const temp = values.slice();
    if (blurx && blury) {
      blurh(blurx, temp, values, width, height);
      blurh(blurx, values, temp, width, height);
      blurh(blurx, temp, values, width, height);
      blurv(blury, values, temp, width, height);
      blurv(blury, temp, values, width, height);
      blurv(blury, values, temp, width, height);
    } else if (blurx) {
      blurh(blurx, values, temp, width, height);
      blurh(blurx, temp, values, width, height);
      blurh(blurx, values, temp, width, height);
    } else if (blury) {
      blurv(blury, values, temp, width, height);
      blurv(blury, temp, values, width, height);
      blurv(blury, values, temp, width, height);
    }
    return data;
  };
}
function blurh(blur3, T, S, w, h) {
  for (let y = 0, n = w * h; y < n; ) {
    blur3(T, S, y, y += w, 1);
  }
}
function blurv(blur3, T, S, w, h) {
  for (let x = 0, n = w * h; x < w; ++x) {
    blur3(T, S, x, x + n, w);
  }
}
function blurfImage(radius) {
  const blur3 = blurf(radius);
  return (T, S, start, stop, step) => {
    start <<= 2, stop <<= 2, step <<= 2;
    blur3(T, S, start + 0, stop + 0, step);
    blur3(T, S, start + 1, stop + 1, step);
    blur3(T, S, start + 2, stop + 2, step);
    blur3(T, S, start + 3, stop + 3, step);
  };
}
function blurf(radius) {
  const radius0 = Math.floor(radius);
  if (radius0 === radius) return bluri(radius);
  const t = radius - radius0;
  const w = 2 * radius + 1;
  return (T, S, start, stop, step) => {
    if (!((stop -= step) >= start)) return;
    let sum4 = radius0 * S[start];
    const s0 = step * radius0;
    const s1 = s0 + step;
    for (let i = start, j = start + s0; i < j; i += step) {
      sum4 += S[Math.min(stop, i)];
    }
    for (let i = start, j = stop; i <= j; i += step) {
      sum4 += S[Math.min(stop, i + s0)];
      T[i] = (sum4 + t * (S[Math.max(start, i - s1)] + S[Math.min(stop, i + s1)])) / w;
      sum4 -= S[Math.max(start, i - s0)];
    }
  };
}
function bluri(radius) {
  const w = 2 * radius + 1;
  return (T, S, start, stop, step) => {
    if (!((stop -= step) >= start)) return;
    let sum4 = radius * S[start];
    const s = step * radius;
    for (let i = start, j = start + s; i < j; i += step) {
      sum4 += S[Math.min(stop, i)];
    }
    for (let i = start, j = stop; i <= j; i += step) {
      sum4 += S[Math.min(stop, i + s)];
      T[i] = sum4 / w;
      sum4 -= S[Math.max(start, i - s)];
    }
  };
}

// node_modules/d3-array/src/array.js
var array = Array.prototype;
var slice = array.slice;
var map = array.map;

// node_modules/d3-array/src/ticks.js
var e10 = Math.sqrt(50);
var e5 = Math.sqrt(10);
var e2 = Math.sqrt(2);
function tickSpec(start, stop, count2) {
  const step = (stop - start) / Math.max(0, count2), power = Math.floor(Math.log10(step)), error = step / Math.pow(10, power), factor = error >= e10 ? 10 : error >= e5 ? 5 : error >= e2 ? 2 : 1;
  let i1, i2, inc;
  if (power < 0) {
    inc = Math.pow(10, -power) / factor;
    i1 = Math.round(start * inc);
    i2 = Math.round(stop * inc);
    if (i1 / inc < start) ++i1;
    if (i2 / inc > stop) --i2;
    inc = -inc;
  } else {
    inc = Math.pow(10, power) * factor;
    i1 = Math.round(start / inc);
    i2 = Math.round(stop / inc);
    if (i1 * inc < start) ++i1;
    if (i2 * inc > stop) --i2;
  }
  if (i2 < i1 && 0.5 <= count2 && count2 < 2) return tickSpec(start, stop, count2 * 2);
  return [i1, i2, inc];
}
function tickIncrement(start, stop, count2) {
  stop = +stop, start = +start, count2 = +count2;
  return tickSpec(start, stop, count2)[2];
}
function tickStep(start, stop, count2) {
  stop = +stop, start = +start, count2 = +count2;
  const reverse2 = stop < start, inc = reverse2 ? tickIncrement(stop, start, count2) : tickIncrement(start, stop, count2);
  return (reverse2 ? -1 : 1) * (inc < 0 ? 1 / -inc : inc);
}

// node_modules/d3-array/src/shuffle.js
var shuffle_default = shuffler(Math.random);
function shuffler(random) {
  return function shuffle(array2, i0 = 0, i1 = array2.length) {
    let m = i1 - (i0 = +i0);
    while (m) {
      const i = random() * m-- | 0, t = array2[m + i0];
      array2[m + i0] = array2[i + i0];
      array2[i + i0] = t;
    }
    return array2;
  };
}

// node_modules/d3-scale/src/init.js
function initRange(domain, range2) {
  switch (arguments.length) {
    case 0:
      break;
    case 1:
      this.range(domain);
      break;
    default:
      this.range(range2).domain(domain);
      break;
  }
  return this;
}

// node_modules/d3-scale/src/ordinal.js
var implicit = Symbol("implicit");

// node_modules/d3-color/src/define.js
function define_default(constructor, factory, prototype) {
  constructor.prototype = factory.prototype = prototype;
  prototype.constructor = constructor;
}
function extend(parent, definition) {
  var prototype = Object.create(parent.prototype);
  for (var key in definition) prototype[key] = definition[key];
  return prototype;
}

// node_modules/d3-color/src/color.js
function Color() {
}
var darker = 0.7;
var brighter = 1 / darker;
var reI = "\\s*([+-]?\\d+)\\s*";
var reN = "\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*";
var reP = "\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*";
var reHex = /^#([0-9a-f]{3,8})$/;
var reRgbInteger = new RegExp(`^rgb\\(${reI},${reI},${reI}\\)$`);
var reRgbPercent = new RegExp(`^rgb\\(${reP},${reP},${reP}\\)$`);
var reRgbaInteger = new RegExp(`^rgba\\(${reI},${reI},${reI},${reN}\\)$`);
var reRgbaPercent = new RegExp(`^rgba\\(${reP},${reP},${reP},${reN}\\)$`);
var reHslPercent = new RegExp(`^hsl\\(${reN},${reP},${reP}\\)$`);
var reHslaPercent = new RegExp(`^hsla\\(${reN},${reP},${reP},${reN}\\)$`);
var named = {
  aliceblue: 15792383,
  antiquewhite: 16444375,
  aqua: 65535,
  aquamarine: 8388564,
  azure: 15794175,
  beige: 16119260,
  bisque: 16770244,
  black: 0,
  blanchedalmond: 16772045,
  blue: 255,
  blueviolet: 9055202,
  brown: 10824234,
  burlywood: 14596231,
  cadetblue: 6266528,
  chartreuse: 8388352,
  chocolate: 13789470,
  coral: 16744272,
  cornflowerblue: 6591981,
  cornsilk: 16775388,
  crimson: 14423100,
  cyan: 65535,
  darkblue: 139,
  darkcyan: 35723,
  darkgoldenrod: 12092939,
  darkgray: 11119017,
  darkgreen: 25600,
  darkgrey: 11119017,
  darkkhaki: 12433259,
  darkmagenta: 9109643,
  darkolivegreen: 5597999,
  darkorange: 16747520,
  darkorchid: 10040012,
  darkred: 9109504,
  darksalmon: 15308410,
  darkseagreen: 9419919,
  darkslateblue: 4734347,
  darkslategray: 3100495,
  darkslategrey: 3100495,
  darkturquoise: 52945,
  darkviolet: 9699539,
  deeppink: 16716947,
  deepskyblue: 49151,
  dimgray: 6908265,
  dimgrey: 6908265,
  dodgerblue: 2003199,
  firebrick: 11674146,
  floralwhite: 16775920,
  forestgreen: 2263842,
  fuchsia: 16711935,
  gainsboro: 14474460,
  ghostwhite: 16316671,
  gold: 16766720,
  goldenrod: 14329120,
  gray: 8421504,
  green: 32768,
  greenyellow: 11403055,
  grey: 8421504,
  honeydew: 15794160,
  hotpink: 16738740,
  indianred: 13458524,
  indigo: 4915330,
  ivory: 16777200,
  khaki: 15787660,
  lavender: 15132410,
  lavenderblush: 16773365,
  lawngreen: 8190976,
  lemonchiffon: 16775885,
  lightblue: 11393254,
  lightcoral: 15761536,
  lightcyan: 14745599,
  lightgoldenrodyellow: 16448210,
  lightgray: 13882323,
  lightgreen: 9498256,
  lightgrey: 13882323,
  lightpink: 16758465,
  lightsalmon: 16752762,
  lightseagreen: 2142890,
  lightskyblue: 8900346,
  lightslategray: 7833753,
  lightslategrey: 7833753,
  lightsteelblue: 11584734,
  lightyellow: 16777184,
  lime: 65280,
  limegreen: 3329330,
  linen: 16445670,
  magenta: 16711935,
  maroon: 8388608,
  mediumaquamarine: 6737322,
  mediumblue: 205,
  mediumorchid: 12211667,
  mediumpurple: 9662683,
  mediumseagreen: 3978097,
  mediumslateblue: 8087790,
  mediumspringgreen: 64154,
  mediumturquoise: 4772300,
  mediumvioletred: 13047173,
  midnightblue: 1644912,
  mintcream: 16121850,
  mistyrose: 16770273,
  moccasin: 16770229,
  navajowhite: 16768685,
  navy: 128,
  oldlace: 16643558,
  olive: 8421376,
  olivedrab: 7048739,
  orange: 16753920,
  orangered: 16729344,
  orchid: 14315734,
  palegoldenrod: 15657130,
  palegreen: 10025880,
  paleturquoise: 11529966,
  palevioletred: 14381203,
  papayawhip: 16773077,
  peachpuff: 16767673,
  peru: 13468991,
  pink: 16761035,
  plum: 14524637,
  powderblue: 11591910,
  purple: 8388736,
  rebeccapurple: 6697881,
  red: 16711680,
  rosybrown: 12357519,
  royalblue: 4286945,
  saddlebrown: 9127187,
  salmon: 16416882,
  sandybrown: 16032864,
  seagreen: 3050327,
  seashell: 16774638,
  sienna: 10506797,
  silver: 12632256,
  skyblue: 8900331,
  slateblue: 6970061,
  slategray: 7372944,
  slategrey: 7372944,
  snow: 16775930,
  springgreen: 65407,
  steelblue: 4620980,
  tan: 13808780,
  teal: 32896,
  thistle: 14204888,
  tomato: 16737095,
  turquoise: 4251856,
  violet: 15631086,
  wheat: 16113331,
  white: 16777215,
  whitesmoke: 16119285,
  yellow: 16776960,
  yellowgreen: 10145074
};
define_default(Color, color, {
  copy(channels) {
    return Object.assign(new this.constructor(), this, channels);
  },
  displayable() {
    return this.rgb().displayable();
  },
  hex: color_formatHex,
  // Deprecated! Use color.formatHex.
  formatHex: color_formatHex,
  formatHex8: color_formatHex8,
  formatHsl: color_formatHsl,
  formatRgb: color_formatRgb,
  toString: color_formatRgb
});
function color_formatHex() {
  return this.rgb().formatHex();
}
function color_formatHex8() {
  return this.rgb().formatHex8();
}
function color_formatHsl() {
  return hslConvert(this).formatHsl();
}
function color_formatRgb() {
  return this.rgb().formatRgb();
}
function color(format2) {
  var m, l;
  format2 = (format2 + "").trim().toLowerCase();
  return (m = reHex.exec(format2)) ? (l = m[1].length, m = parseInt(m[1], 16), l === 6 ? rgbn(m) : l === 3 ? new Rgb(m >> 8 & 15 | m >> 4 & 240, m >> 4 & 15 | m & 240, (m & 15) << 4 | m & 15, 1) : l === 8 ? rgba(m >> 24 & 255, m >> 16 & 255, m >> 8 & 255, (m & 255) / 255) : l === 4 ? rgba(m >> 12 & 15 | m >> 8 & 240, m >> 8 & 15 | m >> 4 & 240, m >> 4 & 15 | m & 240, ((m & 15) << 4 | m & 15) / 255) : null) : (m = reRgbInteger.exec(format2)) ? new Rgb(m[1], m[2], m[3], 1) : (m = reRgbPercent.exec(format2)) ? new Rgb(m[1] * 255 / 100, m[2] * 255 / 100, m[3] * 255 / 100, 1) : (m = reRgbaInteger.exec(format2)) ? rgba(m[1], m[2], m[3], m[4]) : (m = reRgbaPercent.exec(format2)) ? rgba(m[1] * 255 / 100, m[2] * 255 / 100, m[3] * 255 / 100, m[4]) : (m = reHslPercent.exec(format2)) ? hsla(m[1], m[2] / 100, m[3] / 100, 1) : (m = reHslaPercent.exec(format2)) ? hsla(m[1], m[2] / 100, m[3] / 100, m[4]) : named.hasOwnProperty(format2) ? rgbn(named[format2]) : format2 === "transparent" ? new Rgb(NaN, NaN, NaN, 0) : null;
}
function rgbn(n) {
  return new Rgb(n >> 16 & 255, n >> 8 & 255, n & 255, 1);
}
function rgba(r, g2, b, a) {
  if (a <= 0) r = g2 = b = NaN;
  return new Rgb(r, g2, b, a);
}
function rgbConvert(o) {
  if (!(o instanceof Color)) o = color(o);
  if (!o) return new Rgb();
  o = o.rgb();
  return new Rgb(o.r, o.g, o.b, o.opacity);
}
function rgb(r, g2, b, opacity) {
  return arguments.length === 1 ? rgbConvert(r) : new Rgb(r, g2, b, opacity == null ? 1 : opacity);
}
function Rgb(r, g2, b, opacity) {
  this.r = +r;
  this.g = +g2;
  this.b = +b;
  this.opacity = +opacity;
}
define_default(Rgb, rgb, extend(Color, {
  brighter(k) {
    k = k == null ? brighter : Math.pow(brighter, k);
    return new Rgb(this.r * k, this.g * k, this.b * k, this.opacity);
  },
  darker(k) {
    k = k == null ? darker : Math.pow(darker, k);
    return new Rgb(this.r * k, this.g * k, this.b * k, this.opacity);
  },
  rgb() {
    return this;
  },
  clamp() {
    return new Rgb(clampi(this.r), clampi(this.g), clampi(this.b), clampa(this.opacity));
  },
  displayable() {
    return -0.5 <= this.r && this.r < 255.5 && (-0.5 <= this.g && this.g < 255.5) && (-0.5 <= this.b && this.b < 255.5) && (0 <= this.opacity && this.opacity <= 1);
  },
  hex: rgb_formatHex,
  // Deprecated! Use color.formatHex.
  formatHex: rgb_formatHex,
  formatHex8: rgb_formatHex8,
  formatRgb: rgb_formatRgb,
  toString: rgb_formatRgb
}));
function rgb_formatHex() {
  return `#${hex(this.r)}${hex(this.g)}${hex(this.b)}`;
}
function rgb_formatHex8() {
  return `#${hex(this.r)}${hex(this.g)}${hex(this.b)}${hex((isNaN(this.opacity) ? 1 : this.opacity) * 255)}`;
}
function rgb_formatRgb() {
  const a = clampa(this.opacity);
  return `${a === 1 ? "rgb(" : "rgba("}${clampi(this.r)}, ${clampi(this.g)}, ${clampi(this.b)}${a === 1 ? ")" : `, ${a})`}`;
}
function clampa(opacity) {
  return isNaN(opacity) ? 1 : Math.max(0, Math.min(1, opacity));
}
function clampi(value) {
  return Math.max(0, Math.min(255, Math.round(value) || 0));
}
function hex(value) {
  value = clampi(value);
  return (value < 16 ? "0" : "") + value.toString(16);
}
function hsla(h, s, l, a) {
  if (a <= 0) h = s = l = NaN;
  else if (l <= 0 || l >= 1) h = s = NaN;
  else if (s <= 0) h = NaN;
  return new Hsl(h, s, l, a);
}
function hslConvert(o) {
  if (o instanceof Hsl) return new Hsl(o.h, o.s, o.l, o.opacity);
  if (!(o instanceof Color)) o = color(o);
  if (!o) return new Hsl();
  if (o instanceof Hsl) return o;
  o = o.rgb();
  var r = o.r / 255, g2 = o.g / 255, b = o.b / 255, min2 = Math.min(r, g2, b), max2 = Math.max(r, g2, b), h = NaN, s = max2 - min2, l = (max2 + min2) / 2;
  if (s) {
    if (r === max2) h = (g2 - b) / s + (g2 < b) * 6;
    else if (g2 === max2) h = (b - r) / s + 2;
    else h = (r - g2) / s + 4;
    s /= l < 0.5 ? max2 + min2 : 2 - max2 - min2;
    h *= 60;
  } else {
    s = l > 0 && l < 1 ? 0 : h;
  }
  return new Hsl(h, s, l, o.opacity);
}
function hsl(h, s, l, opacity) {
  return arguments.length === 1 ? hslConvert(h) : new Hsl(h, s, l, opacity == null ? 1 : opacity);
}
function Hsl(h, s, l, opacity) {
  this.h = +h;
  this.s = +s;
  this.l = +l;
  this.opacity = +opacity;
}
define_default(Hsl, hsl, extend(Color, {
  brighter(k) {
    k = k == null ? brighter : Math.pow(brighter, k);
    return new Hsl(this.h, this.s, this.l * k, this.opacity);
  },
  darker(k) {
    k = k == null ? darker : Math.pow(darker, k);
    return new Hsl(this.h, this.s, this.l * k, this.opacity);
  },
  rgb() {
    var h = this.h % 360 + (this.h < 0) * 360, s = isNaN(h) || isNaN(this.s) ? 0 : this.s, l = this.l, m2 = l + (l < 0.5 ? l : 1 - l) * s, m1 = 2 * l - m2;
    return new Rgb(
      hsl2rgb(h >= 240 ? h - 240 : h + 120, m1, m2),
      hsl2rgb(h, m1, m2),
      hsl2rgb(h < 120 ? h + 240 : h - 120, m1, m2),
      this.opacity
    );
  },
  clamp() {
    return new Hsl(clamph(this.h), clampt(this.s), clampt(this.l), clampa(this.opacity));
  },
  displayable() {
    return (0 <= this.s && this.s <= 1 || isNaN(this.s)) && (0 <= this.l && this.l <= 1) && (0 <= this.opacity && this.opacity <= 1);
  },
  formatHsl() {
    const a = clampa(this.opacity);
    return `${a === 1 ? "hsl(" : "hsla("}${clamph(this.h)}, ${clampt(this.s) * 100}%, ${clampt(this.l) * 100}%${a === 1 ? ")" : `, ${a})`}`;
  }
}));
function clamph(value) {
  value = (value || 0) % 360;
  return value < 0 ? value + 360 : value;
}
function clampt(value) {
  return Math.max(0, Math.min(1, value || 0));
}
function hsl2rgb(h, m1, m2) {
  return (h < 60 ? m1 + (m2 - m1) * h / 60 : h < 180 ? m2 : h < 240 ? m1 + (m2 - m1) * (240 - h) / 60 : m1) * 255;
}

// node_modules/d3-color/src/math.js
var radians = Math.PI / 180;
var degrees = 180 / Math.PI;

// node_modules/d3-color/src/lab.js
var K = 18;
var Xn = 0.96422;
var Yn = 1;
var Zn = 0.82521;
var t0 = 4 / 29;
var t1 = 6 / 29;
var t2 = 3 * t1 * t1;
var t3 = t1 * t1 * t1;
function labConvert(o) {
  if (o instanceof Lab) return new Lab(o.l, o.a, o.b, o.opacity);
  if (o instanceof Hcl) return hcl2lab(o);
  if (!(o instanceof Rgb)) o = rgbConvert(o);
  var r = rgb2lrgb(o.r), g2 = rgb2lrgb(o.g), b = rgb2lrgb(o.b), y = xyz2lab((0.2225045 * r + 0.7168786 * g2 + 0.0606169 * b) / Yn), x, z;
  if (r === g2 && g2 === b) x = z = y;
  else {
    x = xyz2lab((0.4360747 * r + 0.3850649 * g2 + 0.1430804 * b) / Xn);
    z = xyz2lab((0.0139322 * r + 0.0971045 * g2 + 0.7141733 * b) / Zn);
  }
  return new Lab(116 * y - 16, 500 * (x - y), 200 * (y - z), o.opacity);
}
function lab(l, a, b, opacity) {
  return arguments.length === 1 ? labConvert(l) : new Lab(l, a, b, opacity == null ? 1 : opacity);
}
function Lab(l, a, b, opacity) {
  this.l = +l;
  this.a = +a;
  this.b = +b;
  this.opacity = +opacity;
}
define_default(Lab, lab, extend(Color, {
  brighter(k) {
    return new Lab(this.l + K * (k == null ? 1 : k), this.a, this.b, this.opacity);
  },
  darker(k) {
    return new Lab(this.l - K * (k == null ? 1 : k), this.a, this.b, this.opacity);
  },
  rgb() {
    var y = (this.l + 16) / 116, x = isNaN(this.a) ? y : y + this.a / 500, z = isNaN(this.b) ? y : y - this.b / 200;
    x = Xn * lab2xyz(x);
    y = Yn * lab2xyz(y);
    z = Zn * lab2xyz(z);
    return new Rgb(
      lrgb2rgb(3.1338561 * x - 1.6168667 * y - 0.4906146 * z),
      lrgb2rgb(-0.9787684 * x + 1.9161415 * y + 0.033454 * z),
      lrgb2rgb(0.0719453 * x - 0.2289914 * y + 1.4052427 * z),
      this.opacity
    );
  }
}));
function xyz2lab(t) {
  return t > t3 ? Math.pow(t, 1 / 3) : t / t2 + t0;
}
function lab2xyz(t) {
  return t > t1 ? t * t * t : t2 * (t - t0);
}
function lrgb2rgb(x) {
  return 255 * (x <= 31308e-7 ? 12.92 * x : 1.055 * Math.pow(x, 1 / 2.4) - 0.055);
}
function rgb2lrgb(x) {
  return (x /= 255) <= 0.04045 ? x / 12.92 : Math.pow((x + 0.055) / 1.055, 2.4);
}
function hclConvert(o) {
  if (o instanceof Hcl) return new Hcl(o.h, o.c, o.l, o.opacity);
  if (!(o instanceof Lab)) o = labConvert(o);
  if (o.a === 0 && o.b === 0) return new Hcl(NaN, 0 < o.l && o.l < 100 ? 0 : NaN, o.l, o.opacity);
  var h = Math.atan2(o.b, o.a) * degrees;
  return new Hcl(h < 0 ? h + 360 : h, Math.sqrt(o.a * o.a + o.b * o.b), o.l, o.opacity);
}
function hcl(h, c, l, opacity) {
  return arguments.length === 1 ? hclConvert(h) : new Hcl(h, c, l, opacity == null ? 1 : opacity);
}
function Hcl(h, c, l, opacity) {
  this.h = +h;
  this.c = +c;
  this.l = +l;
  this.opacity = +opacity;
}
function hcl2lab(o) {
  if (isNaN(o.h)) return new Lab(o.l, 0, 0, o.opacity);
  var h = o.h * radians;
  return new Lab(o.l, Math.cos(h) * o.c, Math.sin(h) * o.c, o.opacity);
}
define_default(Hcl, hcl, extend(Color, {
  brighter(k) {
    return new Hcl(this.h, this.c, this.l + K * (k == null ? 1 : k), this.opacity);
  },
  darker(k) {
    return new Hcl(this.h, this.c, this.l - K * (k == null ? 1 : k), this.opacity);
  },
  rgb() {
    return hcl2lab(this).rgb();
  }
}));

// node_modules/d3-color/src/cubehelix.js
var A = -0.14861;
var B = 1.78277;
var C = -0.29227;
var D = -0.90649;
var E = 1.97294;
var ED = E * D;
var EB = E * B;
var BC_DA = B * C - D * A;
function cubehelixConvert(o) {
  if (o instanceof Cubehelix) return new Cubehelix(o.h, o.s, o.l, o.opacity);
  if (!(o instanceof Rgb)) o = rgbConvert(o);
  var r = o.r / 255, g2 = o.g / 255, b = o.b / 255, l = (BC_DA * b + ED * r - EB * g2) / (BC_DA + ED - EB), bl = b - l, k = (E * (g2 - l) - C * bl) / D, s = Math.sqrt(k * k + bl * bl) / (E * l * (1 - l)), h = s ? Math.atan2(k, bl) * degrees - 120 : NaN;
  return new Cubehelix(h < 0 ? h + 360 : h, s, l, o.opacity);
}
function cubehelix(h, s, l, opacity) {
  return arguments.length === 1 ? cubehelixConvert(h) : new Cubehelix(h, s, l, opacity == null ? 1 : opacity);
}
function Cubehelix(h, s, l, opacity) {
  this.h = +h;
  this.s = +s;
  this.l = +l;
  this.opacity = +opacity;
}
define_default(Cubehelix, cubehelix, extend(Color, {
  brighter(k) {
    k = k == null ? brighter : Math.pow(brighter, k);
    return new Cubehelix(this.h, this.s, this.l * k, this.opacity);
  },
  darker(k) {
    k = k == null ? darker : Math.pow(darker, k);
    return new Cubehelix(this.h, this.s, this.l * k, this.opacity);
  },
  rgb() {
    var h = isNaN(this.h) ? 0 : (this.h + 120) * radians, l = +this.l, a = isNaN(this.s) ? 0 : this.s * l * (1 - l), cosh2 = Math.cos(h), sinh2 = Math.sin(h);
    return new Rgb(
      255 * (l + a * (A * cosh2 + B * sinh2)),
      255 * (l + a * (C * cosh2 + D * sinh2)),
      255 * (l + a * (E * cosh2)),
      this.opacity
    );
  }
}));

// node_modules/d3-interpolate/src/basis.js
function basis(t13, v0, v1, v2, v3) {
  var t22 = t13 * t13, t32 = t22 * t13;
  return ((1 - 3 * t13 + 3 * t22 - t32) * v0 + (4 - 6 * t22 + 3 * t32) * v1 + (1 + 3 * t13 + 3 * t22 - 3 * t32) * v2 + t32 * v3) / 6;
}
function basis_default(values) {
  var n = values.length - 1;
  return function(t) {
    var i = t <= 0 ? t = 0 : t >= 1 ? (t = 1, n - 1) : Math.floor(t * n), v1 = values[i], v2 = values[i + 1], v0 = i > 0 ? values[i - 1] : 2 * v1 - v2, v3 = i < n - 1 ? values[i + 2] : 2 * v2 - v1;
    return basis((t - i / n) * n, v0, v1, v2, v3);
  };
}

// node_modules/d3-interpolate/src/basisClosed.js
function basisClosed_default(values) {
  var n = values.length;
  return function(t) {
    var i = Math.floor(((t %= 1) < 0 ? ++t : t) * n), v0 = values[(i + n - 1) % n], v1 = values[i % n], v2 = values[(i + 1) % n], v3 = values[(i + 2) % n];
    return basis((t - i / n) * n, v0, v1, v2, v3);
  };
}

// node_modules/d3-interpolate/src/constant.js
var constant_default = (x) => () => x;

// node_modules/d3-interpolate/src/color.js
function linear(a, d) {
  return function(t) {
    return a + t * d;
  };
}
function exponential(a, b, y) {
  return a = Math.pow(a, y), b = Math.pow(b, y) - a, y = 1 / y, function(t) {
    return Math.pow(a + t * b, y);
  };
}
function hue(a, b) {
  var d = b - a;
  return d ? linear(a, d > 180 || d < -180 ? d - 360 * Math.round(d / 360) : d) : constant_default(isNaN(a) ? b : a);
}
function gamma(y) {
  return (y = +y) === 1 ? nogamma : function(a, b) {
    return b - a ? exponential(a, b, y) : constant_default(isNaN(a) ? b : a);
  };
}
function nogamma(a, b) {
  var d = b - a;
  return d ? linear(a, d) : constant_default(isNaN(a) ? b : a);
}

// node_modules/d3-interpolate/src/rgb.js
var rgb_default = (function rgbGamma(y) {
  var color2 = gamma(y);
  function rgb2(start, end) {
    var r = color2((start = rgb(start)).r, (end = rgb(end)).r), g2 = color2(start.g, end.g), b = color2(start.b, end.b), opacity = nogamma(start.opacity, end.opacity);
    return function(t) {
      start.r = r(t);
      start.g = g2(t);
      start.b = b(t);
      start.opacity = opacity(t);
      return start + "";
    };
  }
  rgb2.gamma = rgbGamma;
  return rgb2;
})(1);
function rgbSpline(spline) {
  return function(colors) {
    var n = colors.length, r = new Array(n), g2 = new Array(n), b = new Array(n), i, color2;
    for (i = 0; i < n; ++i) {
      color2 = rgb(colors[i]);
      r[i] = color2.r || 0;
      g2[i] = color2.g || 0;
      b[i] = color2.b || 0;
    }
    r = spline(r);
    g2 = spline(g2);
    b = spline(b);
    color2.opacity = 1;
    return function(t) {
      color2.r = r(t);
      color2.g = g2(t);
      color2.b = b(t);
      return color2 + "";
    };
  };
}
var rgbBasis = rgbSpline(basis_default);
var rgbBasisClosed = rgbSpline(basisClosed_default);

// node_modules/d3-interpolate/src/number.js
function number_default(a, b) {
  return a = +a, b = +b, function(t) {
    return a * (1 - t) + b * t;
  };
}

// node_modules/d3-interpolate/src/string.js
var reA = /[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g;
var reB = new RegExp(reA.source, "g");

// node_modules/d3-interpolate/src/transform/decompose.js
var degrees2 = 180 / Math.PI;
var identity2 = {
  translateX: 0,
  translateY: 0,
  rotate: 0,
  skewX: 0,
  scaleX: 1,
  scaleY: 1
};
function decompose_default(a, b, c, d, e, f) {
  var scaleX, scaleY, skewX;
  if (scaleX = Math.sqrt(a * a + b * b)) a /= scaleX, b /= scaleX;
  if (skewX = a * c + b * d) c -= a * skewX, d -= b * skewX;
  if (scaleY = Math.sqrt(c * c + d * d)) c /= scaleY, d /= scaleY, skewX /= scaleY;
  if (a * d < b * c) a = -a, b = -b, skewX = -skewX, scaleX = -scaleX;
  return {
    translateX: e,
    translateY: f,
    rotate: Math.atan2(b, a) * degrees2,
    skewX: Math.atan(skewX) * degrees2,
    scaleX,
    scaleY
  };
}

// node_modules/d3-interpolate/src/transform/parse.js
var svgNode;
function parseCss(value) {
  const m = new (typeof DOMMatrix === "function" ? DOMMatrix : WebKitCSSMatrix)(value + "");
  return m.isIdentity ? identity2 : decompose_default(m.a, m.b, m.c, m.d, m.e, m.f);
}
function parseSvg(value) {
  if (value == null) return identity2;
  if (!svgNode) svgNode = document.createElementNS("http://www.w3.org/2000/svg", "g");
  svgNode.setAttribute("transform", value);
  if (!(value = svgNode.transform.baseVal.consolidate())) return identity2;
  value = value.matrix;
  return decompose_default(value.a, value.b, value.c, value.d, value.e, value.f);
}

// node_modules/d3-interpolate/src/transform/index.js
function interpolateTransform(parse, pxComma, pxParen, degParen) {
  function pop(s) {
    return s.length ? s.pop() + " " : "";
  }
  function translate(xa, ya, xb, yb, s, q) {
    if (xa !== xb || ya !== yb) {
      var i = s.push("translate(", null, pxComma, null, pxParen);
      q.push({ i: i - 4, x: number_default(xa, xb) }, { i: i - 2, x: number_default(ya, yb) });
    } else if (xb || yb) {
      s.push("translate(" + xb + pxComma + yb + pxParen);
    }
  }
  function rotate(a, b, s, q) {
    if (a !== b) {
      if (a - b > 180) b += 360;
      else if (b - a > 180) a += 360;
      q.push({ i: s.push(pop(s) + "rotate(", null, degParen) - 2, x: number_default(a, b) });
    } else if (b) {
      s.push(pop(s) + "rotate(" + b + degParen);
    }
  }
  function skewX(a, b, s, q) {
    if (a !== b) {
      q.push({ i: s.push(pop(s) + "skewX(", null, degParen) - 2, x: number_default(a, b) });
    } else if (b) {
      s.push(pop(s) + "skewX(" + b + degParen);
    }
  }
  function scale(xa, ya, xb, yb, s, q) {
    if (xa !== xb || ya !== yb) {
      var i = s.push(pop(s) + "scale(", null, ",", null, ")");
      q.push({ i: i - 4, x: number_default(xa, xb) }, { i: i - 2, x: number_default(ya, yb) });
    } else if (xb !== 1 || yb !== 1) {
      s.push(pop(s) + "scale(" + xb + "," + yb + ")");
    }
  }
  return function(a, b) {
    var s = [], q = [];
    a = parse(a), b = parse(b);
    translate(a.translateX, a.translateY, b.translateX, b.translateY, s, q);
    rotate(a.rotate, b.rotate, s, q);
    skewX(a.skewX, b.skewX, s, q);
    scale(a.scaleX, a.scaleY, b.scaleX, b.scaleY, s, q);
    a = b = null;
    return function(t) {
      var i = -1, n = q.length, o;
      while (++i < n) s[(o = q[i]).i] = o.x(t);
      return s.join("");
    };
  };
}
var interpolateTransformCss = interpolateTransform(parseCss, "px, ", "px)", "deg)");
var interpolateTransformSvg = interpolateTransform(parseSvg, ", ", ")", ")");

// node_modules/d3-interpolate/src/zoom.js
var epsilon2 = 1e-12;
function cosh(x) {
  return ((x = Math.exp(x)) + 1 / x) / 2;
}
function sinh(x) {
  return ((x = Math.exp(x)) - 1 / x) / 2;
}
function tanh(x) {
  return ((x = Math.exp(2 * x)) - 1) / (x + 1);
}
var zoom_default = (function zoomRho(rho, rho2, rho4) {
  function zoom(p0, p1) {
    var ux0 = p0[0], uy0 = p0[1], w0 = p0[2], ux1 = p1[0], uy1 = p1[1], w1 = p1[2], dx = ux1 - ux0, dy = uy1 - uy0, d2 = dx * dx + dy * dy, i, S;
    if (d2 < epsilon2) {
      S = Math.log(w1 / w0) / rho;
      i = function(t) {
        return [
          ux0 + t * dx,
          uy0 + t * dy,
          w0 * Math.exp(rho * t * S)
        ];
      };
    } else {
      var d1 = Math.sqrt(d2), b0 = (w1 * w1 - w0 * w0 + rho4 * d2) / (2 * w0 * rho2 * d1), b1 = (w1 * w1 - w0 * w0 - rho4 * d2) / (2 * w1 * rho2 * d1), r0 = Math.log(Math.sqrt(b0 * b0 + 1) - b0), r1 = Math.log(Math.sqrt(b1 * b1 + 1) - b1);
      S = (r1 - r0) / rho;
      i = function(t) {
        var s = t * S, coshr0 = cosh(r0), u = w0 / (rho2 * d1) * (coshr0 * tanh(rho * s + r0) - sinh(r0));
        return [
          ux0 + u * dx,
          uy0 + u * dy,
          w0 * coshr0 / cosh(rho * s + r0)
        ];
      };
    }
    i.duration = S * 1e3 * rho / Math.SQRT2;
    return i;
  }
  zoom.rho = function(_) {
    var _1 = Math.max(1e-3, +_), _2 = _1 * _1, _4 = _2 * _2;
    return zoomRho(_1, _2, _4);
  };
  return zoom;
})(Math.SQRT2, 2, 4);

// node_modules/d3-interpolate/src/hsl.js
function hsl2(hue2) {
  return function(start, end) {
    var h = hue2((start = hsl(start)).h, (end = hsl(end)).h), s = nogamma(start.s, end.s), l = nogamma(start.l, end.l), opacity = nogamma(start.opacity, end.opacity);
    return function(t) {
      start.h = h(t);
      start.s = s(t);
      start.l = l(t);
      start.opacity = opacity(t);
      return start + "";
    };
  };
}
var hsl_default = hsl2(hue);
var hslLong = hsl2(nogamma);

// node_modules/d3-interpolate/src/hcl.js
function hcl2(hue2) {
  return function(start, end) {
    var h = hue2((start = hcl(start)).h, (end = hcl(end)).h), c = nogamma(start.c, end.c), l = nogamma(start.l, end.l), opacity = nogamma(start.opacity, end.opacity);
    return function(t) {
      start.h = h(t);
      start.c = c(t);
      start.l = l(t);
      start.opacity = opacity(t);
      return start + "";
    };
  };
}
var hcl_default = hcl2(hue);
var hclLong = hcl2(nogamma);

// node_modules/d3-interpolate/src/cubehelix.js
function cubehelix2(hue2) {
  return (function cubehelixGamma(y) {
    y = +y;
    function cubehelix3(start, end) {
      var h = hue2((start = cubehelix(start)).h, (end = cubehelix(end)).h), s = nogamma(start.s, end.s), l = nogamma(start.l, end.l), opacity = nogamma(start.opacity, end.opacity);
      return function(t) {
        start.h = h(t);
        start.s = s(t);
        start.l = l(Math.pow(t, y));
        start.opacity = opacity(t);
        return start + "";
      };
    }
    cubehelix3.gamma = cubehelixGamma;
    return cubehelix3;
  })(1);
}
var cubehelix_default = cubehelix2(hue);
var cubehelixLong = cubehelix2(nogamma);

// node_modules/d3-format/src/formatDecimal.js
function formatDecimal_default(x) {
  return Math.abs(x = Math.round(x)) >= 1e21 ? x.toLocaleString("en").replace(/,/g, "") : x.toString(10);
}
function formatDecimalParts(x, p) {
  if (!isFinite(x) || x === 0) return null;
  var i = (x = p ? x.toExponential(p - 1) : x.toExponential()).indexOf("e"), coefficient = x.slice(0, i);
  return [
    coefficient.length > 1 ? coefficient[0] + coefficient.slice(2) : coefficient,
    +x.slice(i + 1)
  ];
}

// node_modules/d3-format/src/exponent.js
function exponent_default(x) {
  return x = formatDecimalParts(Math.abs(x)), x ? x[1] : NaN;
}

// node_modules/d3-format/src/formatGroup.js
function formatGroup_default(grouping, thousands) {
  return function(value, width) {
    var i = value.length, t = [], j = 0, g2 = grouping[0], length = 0;
    while (i > 0 && g2 > 0) {
      if (length + g2 + 1 > width) g2 = Math.max(1, width - length);
      t.push(value.substring(i -= g2, i + g2));
      if ((length += g2 + 1) > width) break;
      g2 = grouping[j = (j + 1) % grouping.length];
    }
    return t.reverse().join(thousands);
  };
}

// node_modules/d3-format/src/formatNumerals.js
function formatNumerals_default(numerals) {
  return function(value) {
    return value.replace(/[0-9]/g, function(i) {
      return numerals[+i];
    });
  };
}

// node_modules/d3-format/src/formatSpecifier.js
var re = /^(?:(.)?([<>=^]))?([+\-( ])?([$#])?(0)?(\d+)?(,)?(\.\d+)?(~)?([a-z%])?$/i;
function formatSpecifier(specifier) {
  if (!(match = re.exec(specifier))) throw new Error("invalid format: " + specifier);
  var match;
  return new FormatSpecifier({
    fill: match[1],
    align: match[2],
    sign: match[3],
    symbol: match[4],
    zero: match[5],
    width: match[6],
    comma: match[7],
    precision: match[8] && match[8].slice(1),
    trim: match[9],
    type: match[10]
  });
}
formatSpecifier.prototype = FormatSpecifier.prototype;
function FormatSpecifier(specifier) {
  this.fill = specifier.fill === void 0 ? " " : specifier.fill + "";
  this.align = specifier.align === void 0 ? ">" : specifier.align + "";
  this.sign = specifier.sign === void 0 ? "-" : specifier.sign + "";
  this.symbol = specifier.symbol === void 0 ? "" : specifier.symbol + "";
  this.zero = !!specifier.zero;
  this.width = specifier.width === void 0 ? void 0 : +specifier.width;
  this.comma = !!specifier.comma;
  this.precision = specifier.precision === void 0 ? void 0 : +specifier.precision;
  this.trim = !!specifier.trim;
  this.type = specifier.type === void 0 ? "" : specifier.type + "";
}
FormatSpecifier.prototype.toString = function() {
  return this.fill + this.align + this.sign + this.symbol + (this.zero ? "0" : "") + (this.width === void 0 ? "" : Math.max(1, this.width | 0)) + (this.comma ? "," : "") + (this.precision === void 0 ? "" : "." + Math.max(0, this.precision | 0)) + (this.trim ? "~" : "") + this.type;
};

// node_modules/d3-format/src/formatTrim.js
function formatTrim_default(s) {
  out: for (var n = s.length, i = 1, i0 = -1, i1; i < n; ++i) {
    switch (s[i]) {
      case ".":
        i0 = i1 = i;
        break;
      case "0":
        if (i0 === 0) i0 = i;
        i1 = i;
        break;
      default:
        if (!+s[i]) break out;
        if (i0 > 0) i0 = 0;
        break;
    }
  }
  return i0 > 0 ? s.slice(0, i0) + s.slice(i1 + 1) : s;
}

// node_modules/d3-format/src/formatPrefixAuto.js
var prefixExponent;
function formatPrefixAuto_default(x, p) {
  var d = formatDecimalParts(x, p);
  if (!d) return prefixExponent = void 0, x.toPrecision(p);
  var coefficient = d[0], exponent = d[1], i = exponent - (prefixExponent = Math.max(-8, Math.min(8, Math.floor(exponent / 3))) * 3) + 1, n = coefficient.length;
  return i === n ? coefficient : i > n ? coefficient + new Array(i - n + 1).join("0") : i > 0 ? coefficient.slice(0, i) + "." + coefficient.slice(i) : "0." + new Array(1 - i).join("0") + formatDecimalParts(x, Math.max(0, p + i - 1))[0];
}

// node_modules/d3-format/src/formatRounded.js
function formatRounded_default(x, p) {
  var d = formatDecimalParts(x, p);
  if (!d) return x + "";
  var coefficient = d[0], exponent = d[1];
  return exponent < 0 ? "0." + new Array(-exponent).join("0") + coefficient : coefficient.length > exponent + 1 ? coefficient.slice(0, exponent + 1) + "." + coefficient.slice(exponent + 1) : coefficient + new Array(exponent - coefficient.length + 2).join("0");
}

// node_modules/d3-format/src/formatTypes.js
var formatTypes_default = {
  "%": (x, p) => (x * 100).toFixed(p),
  "b": (x) => Math.round(x).toString(2),
  "c": (x) => x + "",
  "d": formatDecimal_default,
  "e": (x, p) => x.toExponential(p),
  "f": (x, p) => x.toFixed(p),
  "g": (x, p) => x.toPrecision(p),
  "o": (x) => Math.round(x).toString(8),
  "p": (x, p) => formatRounded_default(x * 100, p),
  "r": formatRounded_default,
  "s": formatPrefixAuto_default,
  "X": (x) => Math.round(x).toString(16).toUpperCase(),
  "x": (x) => Math.round(x).toString(16)
};

// node_modules/d3-format/src/identity.js
function identity_default(x) {
  return x;
}

// node_modules/d3-format/src/locale.js
var map3 = Array.prototype.map;
var prefixes = ["y", "z", "a", "f", "p", "n", "", "m", "", "k", "M", "G", "T", "P", "E", "Z", "Y"];
function locale_default(locale3) {
  var group2 = locale3.grouping === void 0 || locale3.thousands === void 0 ? identity_default : formatGroup_default(map3.call(locale3.grouping, Number), locale3.thousands + ""), currencyPrefix = locale3.currency === void 0 ? "" : locale3.currency[0] + "", currencySuffix = locale3.currency === void 0 ? "" : locale3.currency[1] + "", decimal = locale3.decimal === void 0 ? "." : locale3.decimal + "", numerals = locale3.numerals === void 0 ? identity_default : formatNumerals_default(map3.call(locale3.numerals, String)), percent = locale3.percent === void 0 ? "%" : locale3.percent + "", minus = locale3.minus === void 0 ? "" : locale3.minus + "", nan = locale3.nan === void 0 ? "NaN" : locale3.nan + "";
  function newFormat(specifier, options) {
    specifier = formatSpecifier(specifier);
    var fill = specifier.fill, align = specifier.align, sign = specifier.sign, symbol = specifier.symbol, zero2 = specifier.zero, width = specifier.width, comma = specifier.comma, precision = specifier.precision, trim = specifier.trim, type = specifier.type;
    if (type === "n") comma = true, type = "g";
    else if (!formatTypes_default[type]) precision === void 0 && (precision = 12), trim = true, type = "g";
    if (zero2 || fill === "0" && align === "=") zero2 = true, fill = "0", align = "=";
    var prefix = (options && options.prefix !== void 0 ? options.prefix : "") + (symbol === "$" ? currencyPrefix : symbol === "#" && /[boxX]/.test(type) ? "0" + type.toLowerCase() : ""), suffix = (symbol === "$" ? currencySuffix : /[%p]/.test(type) ? percent : "") + (options && options.suffix !== void 0 ? options.suffix : "");
    var formatType = formatTypes_default[type], maybeSuffix = /[defgprs%]/.test(type);
    precision = precision === void 0 ? 6 : /[gprs]/.test(type) ? Math.max(1, Math.min(21, precision)) : Math.max(0, Math.min(20, precision));
    function format2(value) {
      var valuePrefix = prefix, valueSuffix = suffix, i, n, c;
      if (type === "c") {
        valueSuffix = formatType(value) + valueSuffix;
        value = "";
      } else {
        value = +value;
        var valueNegative = value < 0 || 1 / value < 0;
        value = isNaN(value) ? nan : formatType(Math.abs(value), precision);
        if (trim) value = formatTrim_default(value);
        if (valueNegative && +value === 0 && sign !== "+") valueNegative = false;
        valuePrefix = (valueNegative ? sign === "(" ? sign : minus : sign === "-" || sign === "(" ? "" : sign) + valuePrefix;
        valueSuffix = (type === "s" && !isNaN(value) && prefixExponent !== void 0 ? prefixes[8 + prefixExponent / 3] : "") + valueSuffix + (valueNegative && sign === "(" ? ")" : "");
        if (maybeSuffix) {
          i = -1, n = value.length;
          while (++i < n) {
            if (c = value.charCodeAt(i), 48 > c || c > 57) {
              valueSuffix = (c === 46 ? decimal + value.slice(i + 1) : value.slice(i)) + valueSuffix;
              value = value.slice(0, i);
              break;
            }
          }
        }
      }
      if (comma && !zero2) value = group2(value, Infinity);
      var length = valuePrefix.length + value.length + valueSuffix.length, padding = length < width ? new Array(width - length + 1).join(fill) : "";
      if (comma && zero2) value = group2(padding + value, padding.length ? width - valueSuffix.length : Infinity), padding = "";
      switch (align) {
        case "<":
          value = valuePrefix + value + valueSuffix + padding;
          break;
        case "=":
          value = valuePrefix + padding + value + valueSuffix;
          break;
        case "^":
          value = padding.slice(0, length = padding.length >> 1) + valuePrefix + value + valueSuffix + padding.slice(length);
          break;
        default:
          value = padding + valuePrefix + value + valueSuffix;
          break;
      }
      return numerals(value);
    }
    format2.toString = function() {
      return specifier + "";
    };
    return format2;
  }
  function formatPrefix2(specifier, value) {
    var e = Math.max(-8, Math.min(8, Math.floor(exponent_default(value) / 3))) * 3, k = Math.pow(10, -e), f = newFormat((specifier = formatSpecifier(specifier), specifier.type = "f", specifier), { suffix: prefixes[8 + e / 3] });
    return function(value2) {
      return f(k * value2);
    };
  }
  return {
    format: newFormat,
    formatPrefix: formatPrefix2
  };
}

// node_modules/d3-format/src/defaultLocale.js
var locale;
var format;
var formatPrefix;
defaultLocale({
  thousands: ",",
  grouping: [3],
  currency: ["$", ""]
});
function defaultLocale(definition) {
  locale = locale_default(definition);
  format = locale.format;
  formatPrefix = locale.formatPrefix;
  return locale;
}

// node_modules/d3-scale/src/threshold.js
function threshold() {
  var domain = [0.5], range2 = [0, 1], unknown, n = 1;
  function scale(x) {
    return x != null && x <= x ? range2[bisect_default(domain, x, 0, n)] : unknown;
  }
  scale.domain = function(_) {
    return arguments.length ? (domain = Array.from(_), n = Math.min(domain.length, range2.length - 1), scale) : domain.slice();
  };
  scale.range = function(_) {
    return arguments.length ? (range2 = Array.from(_), n = Math.min(domain.length, range2.length - 1), scale) : range2.slice();
  };
  scale.invertExtent = function(y) {
    var i = range2.indexOf(y);
    return [domain[i - 1], domain[i]];
  };
  scale.unknown = function(_) {
    return arguments.length ? (unknown = _, scale) : unknown;
  };
  scale.copy = function() {
    return threshold().domain(domain).range(range2).unknown(unknown);
  };
  return initRange.apply(scale, arguments);
}

// node_modules/d3-time/src/interval.js
var t02 = /* @__PURE__ */ new Date();
var t12 = /* @__PURE__ */ new Date();
function timeInterval(floori, offseti, count2, field) {
  function interval(date) {
    return floori(date = arguments.length === 0 ? /* @__PURE__ */ new Date() : /* @__PURE__ */ new Date(+date)), date;
  }
  interval.floor = (date) => {
    return floori(date = /* @__PURE__ */ new Date(+date)), date;
  };
  interval.ceil = (date) => {
    return floori(date = new Date(date - 1)), offseti(date, 1), floori(date), date;
  };
  interval.round = (date) => {
    const d0 = interval(date), d1 = interval.ceil(date);
    return date - d0 < d1 - date ? d0 : d1;
  };
  interval.offset = (date, step) => {
    return offseti(date = /* @__PURE__ */ new Date(+date), step == null ? 1 : Math.floor(step)), date;
  };
  interval.range = (start, stop, step) => {
    const range2 = [];
    start = interval.ceil(start);
    step = step == null ? 1 : Math.floor(step);
    if (!(start < stop) || !(step > 0)) return range2;
    let previous;
    do
      range2.push(previous = /* @__PURE__ */ new Date(+start)), offseti(start, step), floori(start);
    while (previous < start && start < stop);
    return range2;
  };
  interval.filter = (test) => {
    return timeInterval((date) => {
      if (date >= date) while (floori(date), !test(date)) date.setTime(date - 1);
    }, (date, step) => {
      if (date >= date) {
        if (step < 0) while (++step <= 0) {
          while (offseti(date, -1), !test(date)) {
          }
        }
        else while (--step >= 0) {
          while (offseti(date, 1), !test(date)) {
          }
        }
      }
    });
  };
  if (count2) {
    interval.count = (start, end) => {
      t02.setTime(+start), t12.setTime(+end);
      floori(t02), floori(t12);
      return Math.floor(count2(t02, t12));
    };
    interval.every = (step) => {
      step = Math.floor(step);
      return !isFinite(step) || !(step > 0) ? null : !(step > 1) ? interval : interval.filter(field ? (d) => field(d) % step === 0 : (d) => interval.count(0, d) % step === 0);
    };
  }
  return interval;
}

// node_modules/d3-time/src/millisecond.js
var millisecond = timeInterval(() => {
}, (date, step) => {
  date.setTime(+date + step);
}, (start, end) => {
  return end - start;
});
millisecond.every = (k) => {
  k = Math.floor(k);
  if (!isFinite(k) || !(k > 0)) return null;
  if (!(k > 1)) return millisecond;
  return timeInterval((date) => {
    date.setTime(Math.floor(date / k) * k);
  }, (date, step) => {
    date.setTime(+date + step * k);
  }, (start, end) => {
    return (end - start) / k;
  });
};
var milliseconds = millisecond.range;

// node_modules/d3-time/src/duration.js
var durationSecond = 1e3;
var durationMinute = durationSecond * 60;
var durationHour = durationMinute * 60;
var durationDay = durationHour * 24;
var durationWeek = durationDay * 7;
var durationMonth = durationDay * 30;
var durationYear = durationDay * 365;

// node_modules/d3-time/src/second.js
var second = timeInterval((date) => {
  date.setTime(date - date.getMilliseconds());
}, (date, step) => {
  date.setTime(+date + step * durationSecond);
}, (start, end) => {
  return (end - start) / durationSecond;
}, (date) => {
  return date.getUTCSeconds();
});
var seconds = second.range;

// node_modules/d3-time/src/minute.js
var timeMinute = timeInterval((date) => {
  date.setTime(date - date.getMilliseconds() - date.getSeconds() * durationSecond);
}, (date, step) => {
  date.setTime(+date + step * durationMinute);
}, (start, end) => {
  return (end - start) / durationMinute;
}, (date) => {
  return date.getMinutes();
});
var timeMinutes = timeMinute.range;
var utcMinute = timeInterval((date) => {
  date.setUTCSeconds(0, 0);
}, (date, step) => {
  date.setTime(+date + step * durationMinute);
}, (start, end) => {
  return (end - start) / durationMinute;
}, (date) => {
  return date.getUTCMinutes();
});
var utcMinutes = utcMinute.range;

// node_modules/d3-time/src/hour.js
var timeHour = timeInterval((date) => {
  date.setTime(date - date.getMilliseconds() - date.getSeconds() * durationSecond - date.getMinutes() * durationMinute);
}, (date, step) => {
  date.setTime(+date + step * durationHour);
}, (start, end) => {
  return (end - start) / durationHour;
}, (date) => {
  return date.getHours();
});
var timeHours = timeHour.range;
var utcHour = timeInterval((date) => {
  date.setUTCMinutes(0, 0, 0);
}, (date, step) => {
  date.setTime(+date + step * durationHour);
}, (start, end) => {
  return (end - start) / durationHour;
}, (date) => {
  return date.getUTCHours();
});
var utcHours = utcHour.range;

// node_modules/d3-time/src/day.js
var timeDay = timeInterval(
  (date) => date.setHours(0, 0, 0, 0),
  (date, step) => date.setDate(date.getDate() + step),
  (start, end) => (end - start - (end.getTimezoneOffset() - start.getTimezoneOffset()) * durationMinute) / durationDay,
  (date) => date.getDate() - 1
);
var timeDays = timeDay.range;
var utcDay = timeInterval((date) => {
  date.setUTCHours(0, 0, 0, 0);
}, (date, step) => {
  date.setUTCDate(date.getUTCDate() + step);
}, (start, end) => {
  return (end - start) / durationDay;
}, (date) => {
  return date.getUTCDate() - 1;
});
var utcDays = utcDay.range;
var unixDay = timeInterval((date) => {
  date.setUTCHours(0, 0, 0, 0);
}, (date, step) => {
  date.setUTCDate(date.getUTCDate() + step);
}, (start, end) => {
  return (end - start) / durationDay;
}, (date) => {
  return Math.floor(date / durationDay);
});
var unixDays = unixDay.range;

// node_modules/d3-time/src/week.js
function timeWeekday(i) {
  return timeInterval((date) => {
    date.setDate(date.getDate() - (date.getDay() + 7 - i) % 7);
    date.setHours(0, 0, 0, 0);
  }, (date, step) => {
    date.setDate(date.getDate() + step * 7);
  }, (start, end) => {
    return (end - start - (end.getTimezoneOffset() - start.getTimezoneOffset()) * durationMinute) / durationWeek;
  });
}
var timeSunday = timeWeekday(0);
var timeMonday = timeWeekday(1);
var timeTuesday = timeWeekday(2);
var timeWednesday = timeWeekday(3);
var timeThursday = timeWeekday(4);
var timeFriday = timeWeekday(5);
var timeSaturday = timeWeekday(6);
var timeSundays = timeSunday.range;
var timeMondays = timeMonday.range;
var timeTuesdays = timeTuesday.range;
var timeWednesdays = timeWednesday.range;
var timeThursdays = timeThursday.range;
var timeFridays = timeFriday.range;
var timeSaturdays = timeSaturday.range;
function utcWeekday(i) {
  return timeInterval((date) => {
    date.setUTCDate(date.getUTCDate() - (date.getUTCDay() + 7 - i) % 7);
    date.setUTCHours(0, 0, 0, 0);
  }, (date, step) => {
    date.setUTCDate(date.getUTCDate() + step * 7);
  }, (start, end) => {
    return (end - start) / durationWeek;
  });
}
var utcSunday = utcWeekday(0);
var utcMonday = utcWeekday(1);
var utcTuesday = utcWeekday(2);
var utcWednesday = utcWeekday(3);
var utcThursday = utcWeekday(4);
var utcFriday = utcWeekday(5);
var utcSaturday = utcWeekday(6);
var utcSundays = utcSunday.range;
var utcMondays = utcMonday.range;
var utcTuesdays = utcTuesday.range;
var utcWednesdays = utcWednesday.range;
var utcThursdays = utcThursday.range;
var utcFridays = utcFriday.range;
var utcSaturdays = utcSaturday.range;

// node_modules/d3-time/src/month.js
var timeMonth = timeInterval((date) => {
  date.setDate(1);
  date.setHours(0, 0, 0, 0);
}, (date, step) => {
  date.setMonth(date.getMonth() + step);
}, (start, end) => {
  return end.getMonth() - start.getMonth() + (end.getFullYear() - start.getFullYear()) * 12;
}, (date) => {
  return date.getMonth();
});
var timeMonths = timeMonth.range;
var utcMonth = timeInterval((date) => {
  date.setUTCDate(1);
  date.setUTCHours(0, 0, 0, 0);
}, (date, step) => {
  date.setUTCMonth(date.getUTCMonth() + step);
}, (start, end) => {
  return end.getUTCMonth() - start.getUTCMonth() + (end.getUTCFullYear() - start.getUTCFullYear()) * 12;
}, (date) => {
  return date.getUTCMonth();
});
var utcMonths = utcMonth.range;

// node_modules/d3-time/src/year.js
var timeYear = timeInterval((date) => {
  date.setMonth(0, 1);
  date.setHours(0, 0, 0, 0);
}, (date, step) => {
  date.setFullYear(date.getFullYear() + step);
}, (start, end) => {
  return end.getFullYear() - start.getFullYear();
}, (date) => {
  return date.getFullYear();
});
timeYear.every = (k) => {
  return !isFinite(k = Math.floor(k)) || !(k > 0) ? null : timeInterval((date) => {
    date.setFullYear(Math.floor(date.getFullYear() / k) * k);
    date.setMonth(0, 1);
    date.setHours(0, 0, 0, 0);
  }, (date, step) => {
    date.setFullYear(date.getFullYear() + step * k);
  });
};
var timeYears = timeYear.range;
var utcYear = timeInterval((date) => {
  date.setUTCMonth(0, 1);
  date.setUTCHours(0, 0, 0, 0);
}, (date, step) => {
  date.setUTCFullYear(date.getUTCFullYear() + step);
}, (start, end) => {
  return end.getUTCFullYear() - start.getUTCFullYear();
}, (date) => {
  return date.getUTCFullYear();
});
utcYear.every = (k) => {
  return !isFinite(k = Math.floor(k)) || !(k > 0) ? null : timeInterval((date) => {
    date.setUTCFullYear(Math.floor(date.getUTCFullYear() / k) * k);
    date.setUTCMonth(0, 1);
    date.setUTCHours(0, 0, 0, 0);
  }, (date, step) => {
    date.setUTCFullYear(date.getUTCFullYear() + step * k);
  });
};
var utcYears = utcYear.range;

// node_modules/d3-time/src/ticks.js
function ticker(year, month, week, day, hour, minute) {
  const tickIntervals = [
    [second, 1, durationSecond],
    [second, 5, 5 * durationSecond],
    [second, 15, 15 * durationSecond],
    [second, 30, 30 * durationSecond],
    [minute, 1, durationMinute],
    [minute, 5, 5 * durationMinute],
    [minute, 15, 15 * durationMinute],
    [minute, 30, 30 * durationMinute],
    [hour, 1, durationHour],
    [hour, 3, 3 * durationHour],
    [hour, 6, 6 * durationHour],
    [hour, 12, 12 * durationHour],
    [day, 1, durationDay],
    [day, 2, 2 * durationDay],
    [week, 1, durationWeek],
    [month, 1, durationMonth],
    [month, 3, 3 * durationMonth],
    [year, 1, durationYear]
  ];
  function ticks2(start, stop, count2) {
    const reverse2 = stop < start;
    if (reverse2) [start, stop] = [stop, start];
    const interval = count2 && typeof count2.range === "function" ? count2 : tickInterval(start, stop, count2);
    const ticks3 = interval ? interval.range(start, +stop + 1) : [];
    return reverse2 ? ticks3.reverse() : ticks3;
  }
  function tickInterval(start, stop, count2) {
    const target = Math.abs(stop - start) / count2;
    const i = bisector(([, , step2]) => step2).right(tickIntervals, target);
    if (i === tickIntervals.length) return year.every(tickStep(start / durationYear, stop / durationYear, count2));
    if (i === 0) return millisecond.every(Math.max(tickStep(start, stop, count2), 1));
    const [t, step] = tickIntervals[target / tickIntervals[i - 1][2] < tickIntervals[i][2] / target ? i - 1 : i];
    return t.every(step);
  }
  return [ticks2, tickInterval];
}
var [utcTicks, utcTickInterval] = ticker(utcYear, utcMonth, utcSunday, unixDay, utcHour, utcMinute);
var [timeTicks, timeTickInterval] = ticker(timeYear, timeMonth, timeSunday, timeDay, timeHour, timeMinute);

// node_modules/d3-time-format/src/locale.js
function localDate(d) {
  if (0 <= d.y && d.y < 100) {
    var date = new Date(-1, d.m, d.d, d.H, d.M, d.S, d.L);
    date.setFullYear(d.y);
    return date;
  }
  return new Date(d.y, d.m, d.d, d.H, d.M, d.S, d.L);
}
function utcDate(d) {
  if (0 <= d.y && d.y < 100) {
    var date = new Date(Date.UTC(-1, d.m, d.d, d.H, d.M, d.S, d.L));
    date.setUTCFullYear(d.y);
    return date;
  }
  return new Date(Date.UTC(d.y, d.m, d.d, d.H, d.M, d.S, d.L));
}
function newDate(y, m, d) {
  return { y, m, d, H: 0, M: 0, S: 0, L: 0 };
}
function formatLocale(locale3) {
  var locale_dateTime = locale3.dateTime, locale_date = locale3.date, locale_time = locale3.time, locale_periods = locale3.periods, locale_weekdays = locale3.days, locale_shortWeekdays = locale3.shortDays, locale_months = locale3.months, locale_shortMonths = locale3.shortMonths;
  var periodRe = formatRe(locale_periods), periodLookup = formatLookup(locale_periods), weekdayRe = formatRe(locale_weekdays), weekdayLookup = formatLookup(locale_weekdays), shortWeekdayRe = formatRe(locale_shortWeekdays), shortWeekdayLookup = formatLookup(locale_shortWeekdays), monthRe = formatRe(locale_months), monthLookup = formatLookup(locale_months), shortMonthRe = formatRe(locale_shortMonths), shortMonthLookup = formatLookup(locale_shortMonths);
  var formats = {
    "a": formatShortWeekday,
    "A": formatWeekday,
    "b": formatShortMonth,
    "B": formatMonth,
    "c": null,
    "d": formatDayOfMonth,
    "e": formatDayOfMonth,
    "f": formatMicroseconds,
    "g": formatYearISO,
    "G": formatFullYearISO,
    "H": formatHour24,
    "I": formatHour12,
    "j": formatDayOfYear,
    "L": formatMilliseconds,
    "m": formatMonthNumber,
    "M": formatMinutes,
    "p": formatPeriod,
    "q": formatQuarter,
    "Q": formatUnixTimestamp,
    "s": formatUnixTimestampSeconds,
    "S": formatSeconds,
    "u": formatWeekdayNumberMonday,
    "U": formatWeekNumberSunday,
    "V": formatWeekNumberISO,
    "w": formatWeekdayNumberSunday,
    "W": formatWeekNumberMonday,
    "x": null,
    "X": null,
    "y": formatYear,
    "Y": formatFullYear,
    "Z": formatZone,
    "%": formatLiteralPercent
  };
  var utcFormats = {
    "a": formatUTCShortWeekday,
    "A": formatUTCWeekday,
    "b": formatUTCShortMonth,
    "B": formatUTCMonth,
    "c": null,
    "d": formatUTCDayOfMonth,
    "e": formatUTCDayOfMonth,
    "f": formatUTCMicroseconds,
    "g": formatUTCYearISO,
    "G": formatUTCFullYearISO,
    "H": formatUTCHour24,
    "I": formatUTCHour12,
    "j": formatUTCDayOfYear,
    "L": formatUTCMilliseconds,
    "m": formatUTCMonthNumber,
    "M": formatUTCMinutes,
    "p": formatUTCPeriod,
    "q": formatUTCQuarter,
    "Q": formatUnixTimestamp,
    "s": formatUnixTimestampSeconds,
    "S": formatUTCSeconds,
    "u": formatUTCWeekdayNumberMonday,
    "U": formatUTCWeekNumberSunday,
    "V": formatUTCWeekNumberISO,
    "w": formatUTCWeekdayNumberSunday,
    "W": formatUTCWeekNumberMonday,
    "x": null,
    "X": null,
    "y": formatUTCYear,
    "Y": formatUTCFullYear,
    "Z": formatUTCZone,
    "%": formatLiteralPercent
  };
  var parses = {
    "a": parseShortWeekday,
    "A": parseWeekday,
    "b": parseShortMonth,
    "B": parseMonth,
    "c": parseLocaleDateTime,
    "d": parseDayOfMonth,
    "e": parseDayOfMonth,
    "f": parseMicroseconds,
    "g": parseYear,
    "G": parseFullYear,
    "H": parseHour24,
    "I": parseHour24,
    "j": parseDayOfYear,
    "L": parseMilliseconds,
    "m": parseMonthNumber,
    "M": parseMinutes,
    "p": parsePeriod,
    "q": parseQuarter,
    "Q": parseUnixTimestamp,
    "s": parseUnixTimestampSeconds,
    "S": parseSeconds,
    "u": parseWeekdayNumberMonday,
    "U": parseWeekNumberSunday,
    "V": parseWeekNumberISO,
    "w": parseWeekdayNumberSunday,
    "W": parseWeekNumberMonday,
    "x": parseLocaleDate,
    "X": parseLocaleTime,
    "y": parseYear,
    "Y": parseFullYear,
    "Z": parseZone,
    "%": parseLiteralPercent
  };
  formats.x = newFormat(locale_date, formats);
  formats.X = newFormat(locale_time, formats);
  formats.c = newFormat(locale_dateTime, formats);
  utcFormats.x = newFormat(locale_date, utcFormats);
  utcFormats.X = newFormat(locale_time, utcFormats);
  utcFormats.c = newFormat(locale_dateTime, utcFormats);
  function newFormat(specifier, formats2) {
    return function(date) {
      var string = [], i = -1, j = 0, n = specifier.length, c, pad2, format2;
      if (!(date instanceof Date)) date = /* @__PURE__ */ new Date(+date);
      while (++i < n) {
        if (specifier.charCodeAt(i) === 37) {
          string.push(specifier.slice(j, i));
          if ((pad2 = pads[c = specifier.charAt(++i)]) != null) c = specifier.charAt(++i);
          else pad2 = c === "e" ? " " : "0";
          if (format2 = formats2[c]) c = format2(date, pad2);
          string.push(c);
          j = i + 1;
        }
      }
      string.push(specifier.slice(j, i));
      return string.join("");
    };
  }
  function newParse(specifier, Z) {
    return function(string) {
      var d = newDate(1900, void 0, 1), i = parseSpecifier(d, specifier, string += "", 0), week, day;
      if (i != string.length) return null;
      if ("Q" in d) return new Date(d.Q);
      if ("s" in d) return new Date(d.s * 1e3 + ("L" in d ? d.L : 0));
      if (Z && !("Z" in d)) d.Z = 0;
      if ("p" in d) d.H = d.H % 12 + d.p * 12;
      if (d.m === void 0) d.m = "q" in d ? d.q : 0;
      if ("V" in d) {
        if (d.V < 1 || d.V > 53) return null;
        if (!("w" in d)) d.w = 1;
        if ("Z" in d) {
          week = utcDate(newDate(d.y, 0, 1)), day = week.getUTCDay();
          week = day > 4 || day === 0 ? utcMonday.ceil(week) : utcMonday(week);
          week = utcDay.offset(week, (d.V - 1) * 7);
          d.y = week.getUTCFullYear();
          d.m = week.getUTCMonth();
          d.d = week.getUTCDate() + (d.w + 6) % 7;
        } else {
          week = localDate(newDate(d.y, 0, 1)), day = week.getDay();
          week = day > 4 || day === 0 ? timeMonday.ceil(week) : timeMonday(week);
          week = timeDay.offset(week, (d.V - 1) * 7);
          d.y = week.getFullYear();
          d.m = week.getMonth();
          d.d = week.getDate() + (d.w + 6) % 7;
        }
      } else if ("W" in d || "U" in d) {
        if (!("w" in d)) d.w = "u" in d ? d.u % 7 : "W" in d ? 1 : 0;
        day = "Z" in d ? utcDate(newDate(d.y, 0, 1)).getUTCDay() : localDate(newDate(d.y, 0, 1)).getDay();
        d.m = 0;
        d.d = "W" in d ? (d.w + 6) % 7 + d.W * 7 - (day + 5) % 7 : d.w + d.U * 7 - (day + 6) % 7;
      }
      if ("Z" in d) {
        d.H += d.Z / 100 | 0;
        d.M += d.Z % 100;
        return utcDate(d);
      }
      return localDate(d);
    };
  }
  function parseSpecifier(d, specifier, string, j) {
    var i = 0, n = specifier.length, m = string.length, c, parse;
    while (i < n) {
      if (j >= m) return -1;
      c = specifier.charCodeAt(i++);
      if (c === 37) {
        c = specifier.charAt(i++);
        parse = parses[c in pads ? specifier.charAt(i++) : c];
        if (!parse || (j = parse(d, string, j)) < 0) return -1;
      } else if (c != string.charCodeAt(j++)) {
        return -1;
      }
    }
    return j;
  }
  function parsePeriod(d, string, i) {
    var n = periodRe.exec(string.slice(i));
    return n ? (d.p = periodLookup.get(n[0].toLowerCase()), i + n[0].length) : -1;
  }
  function parseShortWeekday(d, string, i) {
    var n = shortWeekdayRe.exec(string.slice(i));
    return n ? (d.w = shortWeekdayLookup.get(n[0].toLowerCase()), i + n[0].length) : -1;
  }
  function parseWeekday(d, string, i) {
    var n = weekdayRe.exec(string.slice(i));
    return n ? (d.w = weekdayLookup.get(n[0].toLowerCase()), i + n[0].length) : -1;
  }
  function parseShortMonth(d, string, i) {
    var n = shortMonthRe.exec(string.slice(i));
    return n ? (d.m = shortMonthLookup.get(n[0].toLowerCase()), i + n[0].length) : -1;
  }
  function parseMonth(d, string, i) {
    var n = monthRe.exec(string.slice(i));
    return n ? (d.m = monthLookup.get(n[0].toLowerCase()), i + n[0].length) : -1;
  }
  function parseLocaleDateTime(d, string, i) {
    return parseSpecifier(d, locale_dateTime, string, i);
  }
  function parseLocaleDate(d, string, i) {
    return parseSpecifier(d, locale_date, string, i);
  }
  function parseLocaleTime(d, string, i) {
    return parseSpecifier(d, locale_time, string, i);
  }
  function formatShortWeekday(d) {
    return locale_shortWeekdays[d.getDay()];
  }
  function formatWeekday(d) {
    return locale_weekdays[d.getDay()];
  }
  function formatShortMonth(d) {
    return locale_shortMonths[d.getMonth()];
  }
  function formatMonth(d) {
    return locale_months[d.getMonth()];
  }
  function formatPeriod(d) {
    return locale_periods[+(d.getHours() >= 12)];
  }
  function formatQuarter(d) {
    return 1 + ~~(d.getMonth() / 3);
  }
  function formatUTCShortWeekday(d) {
    return locale_shortWeekdays[d.getUTCDay()];
  }
  function formatUTCWeekday(d) {
    return locale_weekdays[d.getUTCDay()];
  }
  function formatUTCShortMonth(d) {
    return locale_shortMonths[d.getUTCMonth()];
  }
  function formatUTCMonth(d) {
    return locale_months[d.getUTCMonth()];
  }
  function formatUTCPeriod(d) {
    return locale_periods[+(d.getUTCHours() >= 12)];
  }
  function formatUTCQuarter(d) {
    return 1 + ~~(d.getUTCMonth() / 3);
  }
  return {
    format: function(specifier) {
      var f = newFormat(specifier += "", formats);
      f.toString = function() {
        return specifier;
      };
      return f;
    },
    parse: function(specifier) {
      var p = newParse(specifier += "", false);
      p.toString = function() {
        return specifier;
      };
      return p;
    },
    utcFormat: function(specifier) {
      var f = newFormat(specifier += "", utcFormats);
      f.toString = function() {
        return specifier;
      };
      return f;
    },
    utcParse: function(specifier) {
      var p = newParse(specifier += "", true);
      p.toString = function() {
        return specifier;
      };
      return p;
    }
  };
}
var pads = { "-": "", "_": " ", "0": "0" };
var numberRe = /^\s*\d+/;
var percentRe = /^%/;
var requoteRe = /[\\^$*+?|[\]().{}]/g;
function pad(value, fill, width) {
  var sign = value < 0 ? "-" : "", string = (sign ? -value : value) + "", length = string.length;
  return sign + (length < width ? new Array(width - length + 1).join(fill) + string : string);
}
function requote(s) {
  return s.replace(requoteRe, "\\$&");
}
function formatRe(names) {
  return new RegExp("^(?:" + names.map(requote).join("|") + ")", "i");
}
function formatLookup(names) {
  return new Map(names.map((name, i) => [name.toLowerCase(), i]));
}
function parseWeekdayNumberSunday(d, string, i) {
  var n = numberRe.exec(string.slice(i, i + 1));
  return n ? (d.w = +n[0], i + n[0].length) : -1;
}
function parseWeekdayNumberMonday(d, string, i) {
  var n = numberRe.exec(string.slice(i, i + 1));
  return n ? (d.u = +n[0], i + n[0].length) : -1;
}
function parseWeekNumberSunday(d, string, i) {
  var n = numberRe.exec(string.slice(i, i + 2));
  return n ? (d.U = +n[0], i + n[0].length) : -1;
}
function parseWeekNumberISO(d, string, i) {
  var n = numberRe.exec(string.slice(i, i + 2));
  return n ? (d.V = +n[0], i + n[0].length) : -1;
}
function parseWeekNumberMonday(d, string, i) {
  var n = numberRe.exec(string.slice(i, i + 2));
  return n ? (d.W = +n[0], i + n[0].length) : -1;
}
function parseFullYear(d, string, i) {
  var n = numberRe.exec(string.slice(i, i + 4));
  return n ? (d.y = +n[0], i + n[0].length) : -1;
}
function parseYear(d, string, i) {
  var n = numberRe.exec(string.slice(i, i + 2));
  return n ? (d.y = +n[0] + (+n[0] > 68 ? 1900 : 2e3), i + n[0].length) : -1;
}
function parseZone(d, string, i) {
  var n = /^(Z)|([+-]\d\d)(?::?(\d\d))?/.exec(string.slice(i, i + 6));
  return n ? (d.Z = n[1] ? 0 : -(n[2] + (n[3] || "00")), i + n[0].length) : -1;
}
function parseQuarter(d, string, i) {
  var n = numberRe.exec(string.slice(i, i + 1));
  return n ? (d.q = n[0] * 3 - 3, i + n[0].length) : -1;
}
function parseMonthNumber(d, string, i) {
  var n = numberRe.exec(string.slice(i, i + 2));
  return n ? (d.m = n[0] - 1, i + n[0].length) : -1;
}
function parseDayOfMonth(d, string, i) {
  var n = numberRe.exec(string.slice(i, i + 2));
  return n ? (d.d = +n[0], i + n[0].length) : -1;
}
function parseDayOfYear(d, string, i) {
  var n = numberRe.exec(string.slice(i, i + 3));
  return n ? (d.m = 0, d.d = +n[0], i + n[0].length) : -1;
}
function parseHour24(d, string, i) {
  var n = numberRe.exec(string.slice(i, i + 2));
  return n ? (d.H = +n[0], i + n[0].length) : -1;
}
function parseMinutes(d, string, i) {
  var n = numberRe.exec(string.slice(i, i + 2));
  return n ? (d.M = +n[0], i + n[0].length) : -1;
}
function parseSeconds(d, string, i) {
  var n = numberRe.exec(string.slice(i, i + 2));
  return n ? (d.S = +n[0], i + n[0].length) : -1;
}
function parseMilliseconds(d, string, i) {
  var n = numberRe.exec(string.slice(i, i + 3));
  return n ? (d.L = +n[0], i + n[0].length) : -1;
}
function parseMicroseconds(d, string, i) {
  var n = numberRe.exec(string.slice(i, i + 6));
  return n ? (d.L = Math.floor(n[0] / 1e3), i + n[0].length) : -1;
}
function parseLiteralPercent(d, string, i) {
  var n = percentRe.exec(string.slice(i, i + 1));
  return n ? i + n[0].length : -1;
}
function parseUnixTimestamp(d, string, i) {
  var n = numberRe.exec(string.slice(i));
  return n ? (d.Q = +n[0], i + n[0].length) : -1;
}
function parseUnixTimestampSeconds(d, string, i) {
  var n = numberRe.exec(string.slice(i));
  return n ? (d.s = +n[0], i + n[0].length) : -1;
}
function formatDayOfMonth(d, p) {
  return pad(d.getDate(), p, 2);
}
function formatHour24(d, p) {
  return pad(d.getHours(), p, 2);
}
function formatHour12(d, p) {
  return pad(d.getHours() % 12 || 12, p, 2);
}
function formatDayOfYear(d, p) {
  return pad(1 + timeDay.count(timeYear(d), d), p, 3);
}
function formatMilliseconds(d, p) {
  return pad(d.getMilliseconds(), p, 3);
}
function formatMicroseconds(d, p) {
  return formatMilliseconds(d, p) + "000";
}
function formatMonthNumber(d, p) {
  return pad(d.getMonth() + 1, p, 2);
}
function formatMinutes(d, p) {
  return pad(d.getMinutes(), p, 2);
}
function formatSeconds(d, p) {
  return pad(d.getSeconds(), p, 2);
}
function formatWeekdayNumberMonday(d) {
  var day = d.getDay();
  return day === 0 ? 7 : day;
}
function formatWeekNumberSunday(d, p) {
  return pad(timeSunday.count(timeYear(d) - 1, d), p, 2);
}
function dISO(d) {
  var day = d.getDay();
  return day >= 4 || day === 0 ? timeThursday(d) : timeThursday.ceil(d);
}
function formatWeekNumberISO(d, p) {
  d = dISO(d);
  return pad(timeThursday.count(timeYear(d), d) + (timeYear(d).getDay() === 4), p, 2);
}
function formatWeekdayNumberSunday(d) {
  return d.getDay();
}
function formatWeekNumberMonday(d, p) {
  return pad(timeMonday.count(timeYear(d) - 1, d), p, 2);
}
function formatYear(d, p) {
  return pad(d.getFullYear() % 100, p, 2);
}
function formatYearISO(d, p) {
  d = dISO(d);
  return pad(d.getFullYear() % 100, p, 2);
}
function formatFullYear(d, p) {
  return pad(d.getFullYear() % 1e4, p, 4);
}
function formatFullYearISO(d, p) {
  var day = d.getDay();
  d = day >= 4 || day === 0 ? timeThursday(d) : timeThursday.ceil(d);
  return pad(d.getFullYear() % 1e4, p, 4);
}
function formatZone(d) {
  var z = d.getTimezoneOffset();
  return (z > 0 ? "-" : (z *= -1, "+")) + pad(z / 60 | 0, "0", 2) + pad(z % 60, "0", 2);
}
function formatUTCDayOfMonth(d, p) {
  return pad(d.getUTCDate(), p, 2);
}
function formatUTCHour24(d, p) {
  return pad(d.getUTCHours(), p, 2);
}
function formatUTCHour12(d, p) {
  return pad(d.getUTCHours() % 12 || 12, p, 2);
}
function formatUTCDayOfYear(d, p) {
  return pad(1 + utcDay.count(utcYear(d), d), p, 3);
}
function formatUTCMilliseconds(d, p) {
  return pad(d.getUTCMilliseconds(), p, 3);
}
function formatUTCMicroseconds(d, p) {
  return formatUTCMilliseconds(d, p) + "000";
}
function formatUTCMonthNumber(d, p) {
  return pad(d.getUTCMonth() + 1, p, 2);
}
function formatUTCMinutes(d, p) {
  return pad(d.getUTCMinutes(), p, 2);
}
function formatUTCSeconds(d, p) {
  return pad(d.getUTCSeconds(), p, 2);
}
function formatUTCWeekdayNumberMonday(d) {
  var dow = d.getUTCDay();
  return dow === 0 ? 7 : dow;
}
function formatUTCWeekNumberSunday(d, p) {
  return pad(utcSunday.count(utcYear(d) - 1, d), p, 2);
}
function UTCdISO(d) {
  var day = d.getUTCDay();
  return day >= 4 || day === 0 ? utcThursday(d) : utcThursday.ceil(d);
}
function formatUTCWeekNumberISO(d, p) {
  d = UTCdISO(d);
  return pad(utcThursday.count(utcYear(d), d) + (utcYear(d).getUTCDay() === 4), p, 2);
}
function formatUTCWeekdayNumberSunday(d) {
  return d.getUTCDay();
}
function formatUTCWeekNumberMonday(d, p) {
  return pad(utcMonday.count(utcYear(d) - 1, d), p, 2);
}
function formatUTCYear(d, p) {
  return pad(d.getUTCFullYear() % 100, p, 2);
}
function formatUTCYearISO(d, p) {
  d = UTCdISO(d);
  return pad(d.getUTCFullYear() % 100, p, 2);
}
function formatUTCFullYear(d, p) {
  return pad(d.getUTCFullYear() % 1e4, p, 4);
}
function formatUTCFullYearISO(d, p) {
  var day = d.getUTCDay();
  d = day >= 4 || day === 0 ? utcThursday(d) : utcThursday.ceil(d);
  return pad(d.getUTCFullYear() % 1e4, p, 4);
}
function formatUTCZone() {
  return "+0000";
}
function formatLiteralPercent() {
  return "%";
}
function formatUnixTimestamp(d) {
  return +d;
}
function formatUnixTimestampSeconds(d) {
  return Math.floor(+d / 1e3);
}

// node_modules/d3-time-format/src/defaultLocale.js
var locale2;
var timeFormat;
var timeParse;
var utcFormat;
var utcParse;
defaultLocale2({
  dateTime: "%x, %X",
  date: "%-m/%-d/%Y",
  time: "%-I:%M:%S %p",
  periods: ["AM", "PM"],
  days: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
  shortDays: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
  months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
  shortMonths: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]
});
function defaultLocale2(definition) {
  locale2 = formatLocale(definition);
  timeFormat = locale2.format;
  timeParse = locale2.parse;
  utcFormat = locale2.utcFormat;
  utcParse = locale2.utcParse;
  return locale2;
}

// node_modules/d3-time-format/src/isoFormat.js
var isoSpecifier = "%Y-%m-%dT%H:%M:%S.%LZ";
function formatIsoNative(date) {
  return date.toISOString();
}
var formatIso = Date.prototype.toISOString ? formatIsoNative : utcFormat(isoSpecifier);

// node_modules/d3-time-format/src/isoParse.js
function parseIsoNative(string) {
  var date = new Date(string);
  return isNaN(date) ? null : date;
}
var parseIso = +/* @__PURE__ */ new Date("2000-01-01T00:00:00.000Z") ? parseIsoNative : utcParse(isoSpecifier);

// node_modules/@cloudflare/speedtest/dist/speedtest.js
function _arrayLikeToArray(r, a) {
  (null == a || a > r.length) && (a = r.length);
  for (var e = 0, n = Array(a); e < a; e++) n[e] = r[e];
  return n;
}
function _arrayWithHoles(r) {
  if (Array.isArray(r)) return r;
}
function _arrayWithoutHoles(r) {
  if (Array.isArray(r)) return _arrayLikeToArray(r);
}
function _assertClassBrand(e, t, n) {
  if ("function" == typeof e ? e === t : e.has(t)) return arguments.length < 3 ? t : n;
  throw new TypeError("Private element is not present on this object");
}
function _assertThisInitialized(e) {
  if (void 0 === e) throw new ReferenceError("this hasn't been initialised - super() hasn't been called");
  return e;
}
function _callSuper(t, o, e) {
  return o = _getPrototypeOf(o), _possibleConstructorReturn(t, _isNativeReflectConstruct() ? Reflect.construct(o, e || [], _getPrototypeOf(t).constructor) : o.apply(t, e));
}
function _checkPrivateRedeclaration(e, t) {
  if (t.has(e)) throw new TypeError("Cannot initialize the same private elements twice on an object");
}
function _classCallCheck(a, n) {
  if (!(a instanceof n)) throw new TypeError("Cannot call a class as a function");
}
function _classPrivateFieldGet2(s, a) {
  return s.get(_assertClassBrand(s, a));
}
function _classPrivateFieldInitSpec(e, t, a) {
  _checkPrivateRedeclaration(e, t), t.set(e, a);
}
function _classPrivateFieldSet2(s, a, r) {
  return s.set(_assertClassBrand(s, a), r), r;
}
function _classPrivateMethodInitSpec(e, a) {
  _checkPrivateRedeclaration(e, a), a.add(e);
}
function _defineProperties(e, r) {
  for (var t = 0; t < r.length; t++) {
    var o = r[t];
    o.enumerable = o.enumerable || false, o.configurable = true, "value" in o && (o.writable = true), Object.defineProperty(e, _toPropertyKey(o.key), o);
  }
}
function _createClass(e, r, t) {
  return r && _defineProperties(e.prototype, r), Object.defineProperty(e, "prototype", {
    writable: false
  }), e;
}
function _defineProperty(e, r, t) {
  return (r = _toPropertyKey(r)) in e ? Object.defineProperty(e, r, {
    value: t,
    enumerable: true,
    configurable: true,
    writable: true
  }) : e[r] = t, e;
}
function _get() {
  return _get = "undefined" != typeof Reflect && Reflect.get ? Reflect.get.bind() : function(e, t, r) {
    var p = _superPropBase(e, t);
    if (p) {
      var n = Object.getOwnPropertyDescriptor(p, t);
      return n.get ? n.get.call(arguments.length < 3 ? e : r) : n.value;
    }
  }, _get.apply(null, arguments);
}
function _getPrototypeOf(t) {
  return _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf.bind() : function(t4) {
    return t4.__proto__ || Object.getPrototypeOf(t4);
  }, _getPrototypeOf(t);
}
function _inherits(t, e) {
  if ("function" != typeof e && null !== e) throw new TypeError("Super expression must either be null or a function");
  t.prototype = Object.create(e && e.prototype, {
    constructor: {
      value: t,
      writable: true,
      configurable: true
    }
  }), Object.defineProperty(t, "prototype", {
    writable: false
  }), e && _setPrototypeOf(t, e);
}
function _isNativeReflectConstruct() {
  try {
    var t = !Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function() {
    }));
  } catch (t4) {
  }
  return (_isNativeReflectConstruct = function() {
    return !!t;
  })();
}
function _iterableToArray(r) {
  if ("undefined" != typeof Symbol && null != r[Symbol.iterator] || null != r["@@iterator"]) return Array.from(r);
}
function _iterableToArrayLimit(r, l) {
  var t = null == r ? null : "undefined" != typeof Symbol && r[Symbol.iterator] || r["@@iterator"];
  if (null != t) {
    var e, n, i, u, a = [], f = true, o = false;
    try {
      if (i = (t = t.call(r)).next, 0 === l) {
        if (Object(t) !== t) return;
        f = false;
      } else for (; !(f = (e = i.call(t)).done) && (a.push(e.value), a.length !== l); f = true) ;
    } catch (r2) {
      o = true, n = r2;
    } finally {
      try {
        if (!f && null != t.return && (u = t.return(), Object(u) !== u)) return;
      } finally {
        if (o) throw n;
      }
    }
    return a;
  }
}
function _nonIterableRest() {
  throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");
}
function _nonIterableSpread() {
  throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");
}
function ownKeys(e, r) {
  var t = Object.keys(e);
  if (Object.getOwnPropertySymbols) {
    var o = Object.getOwnPropertySymbols(e);
    r && (o = o.filter(function(r2) {
      return Object.getOwnPropertyDescriptor(e, r2).enumerable;
    })), t.push.apply(t, o);
  }
  return t;
}
function _objectSpread2(e) {
  for (var r = 1; r < arguments.length; r++) {
    var t = null != arguments[r] ? arguments[r] : {};
    r % 2 ? ownKeys(Object(t), true).forEach(function(r2) {
      _defineProperty(e, r2, t[r2]);
    }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(e, Object.getOwnPropertyDescriptors(t)) : ownKeys(Object(t)).forEach(function(r2) {
      Object.defineProperty(e, r2, Object.getOwnPropertyDescriptor(t, r2));
    });
  }
  return e;
}
function _objectWithoutProperties(e, t) {
  if (null == e) return {};
  var o, r, i = _objectWithoutPropertiesLoose(e, t);
  if (Object.getOwnPropertySymbols) {
    var n = Object.getOwnPropertySymbols(e);
    for (r = 0; r < n.length; r++) o = n[r], -1 === t.indexOf(o) && {}.propertyIsEnumerable.call(e, o) && (i[o] = e[o]);
  }
  return i;
}
function _objectWithoutPropertiesLoose(r, e) {
  if (null == r) return {};
  var t = {};
  for (var n in r) if ({}.hasOwnProperty.call(r, n)) {
    if (-1 !== e.indexOf(n)) continue;
    t[n] = r[n];
  }
  return t;
}
function _possibleConstructorReturn(t, e) {
  if (e && ("object" == typeof e || "function" == typeof e)) return e;
  if (void 0 !== e) throw new TypeError("Derived constructors may only return object or undefined");
  return _assertThisInitialized(t);
}
function set(e, r, t, o) {
  return set = "undefined" != typeof Reflect && Reflect.set ? Reflect.set : function(e3, r2, t4, o2) {
    var f, i = _superPropBase(e3, r2);
    if (i) {
      if ((f = Object.getOwnPropertyDescriptor(i, r2)).set) return f.set.call(o2, t4), true;
      if (!f.writable) return false;
    }
    if (f = Object.getOwnPropertyDescriptor(o2, r2)) {
      if (!f.writable) return false;
      f.value = t4, Object.defineProperty(o2, r2, f);
    } else _defineProperty(o2, r2, t4);
    return true;
  }, set(e, r, t, o);
}
function _set(e, r, t, o, f) {
  if (!set(e, r, t, o || e) && f) throw new TypeError("failed to set property");
  return t;
}
function _setPrototypeOf(t, e) {
  return _setPrototypeOf = Object.setPrototypeOf ? Object.setPrototypeOf.bind() : function(t4, e3) {
    return t4.__proto__ = e3, t4;
  }, _setPrototypeOf(t, e);
}
function _slicedToArray(r, e) {
  return _arrayWithHoles(r) || _iterableToArrayLimit(r, e) || _unsupportedIterableToArray(r, e) || _nonIterableRest();
}
function _superPropBase(t, o) {
  for (; !{}.hasOwnProperty.call(t, o) && null !== (t = _getPrototypeOf(t)); ) ;
  return t;
}
function _superPropGet(t, o, e, r) {
  var p = _get(_getPrototypeOf(t.prototype), o, e);
  return 2 & r && "function" == typeof p ? function(t4) {
    return p.apply(e, t4);
  } : p;
}
function _superPropSet(t, e, o, r, p, f) {
  return _set(_getPrototypeOf(t.prototype), e, o, r, p);
}
function _toConsumableArray(r) {
  return _arrayWithoutHoles(r) || _iterableToArray(r) || _unsupportedIterableToArray(r) || _nonIterableSpread();
}
function _toPrimitive(t, r) {
  if ("object" != typeof t || !t) return t;
  var e = t[Symbol.toPrimitive];
  if (void 0 !== e) {
    var i = e.call(t, r);
    if ("object" != typeof i) return i;
    throw new TypeError("@@toPrimitive must return a primitive value.");
  }
  return String(t);
}
function _toPropertyKey(t) {
  var i = _toPrimitive(t, "string");
  return "symbol" == typeof i ? i : i + "";
}
function _unsupportedIterableToArray(r, a) {
  if (r) {
    if ("string" == typeof r) return _arrayLikeToArray(r, a);
    var t = {}.toString.call(r).slice(8, -1);
    return "Object" === t && r.constructor && (t = r.constructor.name), "Map" === t || "Set" === t ? Array.from(r) : "Arguments" === t || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t) ? _arrayLikeToArray(r, a) : void 0;
  }
}
var REL_API_URL = "https://speed.cloudflare.com";
var defaultConfig = {
  // Engine
  autoStart: true,
  // APIs
  downloadApiUrl: "".concat(REL_API_URL, "/__down"),
  uploadApiUrl: "".concat(REL_API_URL, "/__up"),
  logMeasurementApiUrl: null,
  logAimApiUrl: "https://aim.cloudflare.com/__log",
  turnServerUri: "turn.speed.cloudflare.com:50000",
  turnServerCredsApiUrl: "".concat(REL_API_URL, "/turn-creds"),
  turnServerUser: null,
  turnServerPass: null,
  rpkiInvalidHost: "invalid.rpki.cloudflare.com",
  cfTraceUrl: "".concat(REL_API_URL, "/cdn-cgi/trace"),
  includeCredentials: false,
  sessionId: void 0,
  // Measurements
  measurements: [
    {
      type: "latency",
      numPackets: 1
    },
    // initial ttfb estimation
    {
      type: "download",
      bytes: 1e5,
      count: 1,
      bypassMinDuration: true
    },
    // initial download estimation
    {
      type: "latency",
      numPackets: 20
    },
    {
      type: "download",
      bytes: 1e5,
      count: 9
    },
    {
      type: "download",
      bytes: 1e6,
      count: 8
    },
    {
      type: "upload",
      bytes: 1e5,
      count: 8
    },
    {
      type: "packetLoss",
      numPackets: 1e3,
      batchSize: 10,
      batchWaitTime: 10,
      // ms (in between batches)
      responsesWaitTime: 3e3
      // ms (silent time after last sent msg)
    },
    {
      type: "upload",
      bytes: 1e6,
      count: 6
    },
    {
      type: "download",
      bytes: 1e7,
      count: 6
    },
    {
      type: "upload",
      bytes: 1e7,
      count: 4
    },
    {
      type: "download",
      bytes: 25e6,
      count: 4
    },
    {
      type: "upload",
      bytes: 25e6,
      count: 4
    },
    {
      type: "download",
      bytes: 1e8,
      count: 3
    },
    {
      type: "upload",
      bytes: 5e7,
      count: 3
    },
    {
      type: "download",
      bytes: 25e7,
      count: 2
    }
  ],
  measureDownloadLoadedLatency: true,
  measureUploadLoadedLatency: true,
  loadedLatencyThrottle: 400,
  // ms in between loaded latency requests
  bandwidthFinishRequestDuration: 1e3,
  // download/upload duration (ms) to reach for stopping further measurements
  estimatedServerTime: 10,
  // ms to discount from latency calculation (if not present in response headers)
  // Result interpretation
  latencyPercentile: 0.5,
  // Percentile used to calculate latency from a set of measurements
  bandwidthPercentile: 0.9,
  // Percentile used to calculate bandwidth from a set of measurements
  bandwidthMinRequestDuration: 10,
  // minimum duration (ms) to consider a measurement good enough to use in bandwidth calculation
  loadedRequestMinDuration: 250,
  // minimum duration (ms) of a request to consider it to be loading the connection
  loadedLatencyMaxPoints: 20
  // number of data points to keep for loaded latency
};
var internalConfig = {
  // AIM
  aimMeasurementScoring: {
    packetLoss: threshold([0.01, 0.05, 0.25, 0.5], [10, 5, 0, -10, -20]),
    latency: threshold([10, 20, 50, 100, 500], [20, 10, 5, 0, -10, -20]),
    loadedLatencyIncrease: threshold([10, 20, 50, 100, 500], [20, 10, 5, 0, -10, -20]),
    jitter: threshold([10, 20, 100, 500], [10, 5, 0, -10, -20]),
    download: threshold([1e6, 1e7, 5e7, 1e8], [0, 5, 10, 20, 30]),
    upload: threshold([1e6, 1e7, 5e7, 1e8], [0, 5, 10, 20, 30])
  },
  aimExperiencesDefs: {
    streaming: {
      input: ["latency", "packetLoss", "download", "loadedLatencyIncrease"],
      pointThresholds: [15, 20, 40, 60]
    },
    gaming: {
      input: ["latency", "packetLoss", "loadedLatencyIncrease"],
      pointThresholds: [5, 15, 25, 30]
    },
    rtc: {
      input: ["latency", "jitter", "packetLoss", "loadedLatencyIncrease"],
      pointThresholds: [5, 15, 25, 40]
    }
  }
};
var MAX_RETRIES = 20;
var ESTIMATED_HEADER_FRACTION = 5e-3;
var cfGetServerTime = function cfGetServerTime2(r) {
  var serverTiming = r.headers.get("server-timing");
  if (serverTiming) {
    var re2 = serverTiming.match(/dur=([0-9.]+)/);
    if (re2) return +re2[1];
  }
};
var getTtfb = function getTtfb2(perf) {
  return perf.responseStart - perf.requestStart;
};
var gePayloadDownload = function gePayloadDownload2(perf) {
  return perf.responseEnd - perf.responseStart;
};
var calcDownloadDuration = function calcDownloadDuration2(_ref) {
  var ping = _ref.ping, payloadDownloadTime = _ref.payloadDownloadTime;
  return ping + payloadDownloadTime;
};
var calcUploadDuration = function calcUploadDuration2(_ref2) {
  var ttfb = _ref2.ttfb;
  return ttfb;
};
var calcDownloadSpeed = function calcDownloadSpeed2(_ref3, numBytes) {
  var duration = _ref3.duration, transferSize = _ref3.transferSize;
  var bits = 8 * (transferSize || +numBytes * (1 + ESTIMATED_HEADER_FRACTION));
  var secs = duration / 1e3;
  return !secs ? void 0 : bits / secs;
};
var calcUploadSpeed = function calcUploadSpeed2(_ref4, numBytes) {
  var duration = _ref4.duration;
  var bits = 8 * numBytes * (1 + ESTIMATED_HEADER_FRACTION);
  var secs = duration / 1e3;
  return !secs ? void 0 : bits / secs;
};
var genContent = (0, import_lodash.default)(function(numBytes) {
  return "0".repeat(numBytes);
});
var _qsParams = /* @__PURE__ */ new WeakMap();
var _fetchOptions = /* @__PURE__ */ new WeakMap();
var _responseHook = /* @__PURE__ */ new WeakMap();
var _onRunningChange = /* @__PURE__ */ new WeakMap();
var _onNewMeasurementStarted = /* @__PURE__ */ new WeakMap();
var _onMeasurementResult = /* @__PURE__ */ new WeakMap();
var _onFinished$1 = /* @__PURE__ */ new WeakMap();
var _onConnectionError$1 = /* @__PURE__ */ new WeakMap();
var _measurements = /* @__PURE__ */ new WeakMap();
var _downloadApi = /* @__PURE__ */ new WeakMap();
var _uploadApi = /* @__PURE__ */ new WeakMap();
var _running$2 = /* @__PURE__ */ new WeakMap();
var _finished$1 = /* @__PURE__ */ new WeakMap();
var _results$1 = /* @__PURE__ */ new WeakMap();
var _measIdx = /* @__PURE__ */ new WeakMap();
var _counter = /* @__PURE__ */ new WeakMap();
var _retries = /* @__PURE__ */ new WeakMap();
var _minDuration = /* @__PURE__ */ new WeakMap();
var _throttleMs = /* @__PURE__ */ new WeakMap();
var _estimatedServerTime = /* @__PURE__ */ new WeakMap();
var _currentFetchPromise = /* @__PURE__ */ new WeakMap();
var _currentNextMsmTimeoutId = /* @__PURE__ */ new WeakMap();
var _BandwidthMeasurementEngine_brand = /* @__PURE__ */ new WeakSet();
var BandwidthMeasurementEngine = (function() {
  function BandwidthMeasurementEngine2(_measurements2) {
    var _ref5 = arguments.length > 1 && arguments[1] !== void 0 ? arguments[1] : {}, downloadApiUrl = _ref5.downloadApiUrl, uploadApiUrl = _ref5.uploadApiUrl, _ref5$throttleMs = _ref5.throttleMs, throttleMs = _ref5$throttleMs === void 0 ? 0 : _ref5$throttleMs, _ref5$estimatedServer = _ref5.estimatedServerTime, estimatedServerTime = _ref5$estimatedServer === void 0 ? 0 : _ref5$estimatedServer;
    _classCallCheck(this, BandwidthMeasurementEngine2);
    _classPrivateMethodInitSpec(this, _BandwidthMeasurementEngine_brand);
    _classPrivateFieldInitSpec(this, _qsParams, {});
    _classPrivateFieldInitSpec(this, _fetchOptions, {});
    _defineProperty(this, "finishRequestDuration", 1e3);
    _defineProperty(this, "getServerTime", cfGetServerTime);
    _classPrivateFieldInitSpec(this, _responseHook, function(r) {
      return r;
    });
    _classPrivateFieldInitSpec(this, _onRunningChange, function() {
    });
    _classPrivateFieldInitSpec(this, _onNewMeasurementStarted, function() {
    });
    _classPrivateFieldInitSpec(this, _onMeasurementResult, function() {
    });
    _classPrivateFieldInitSpec(this, _onFinished$1, function() {
    });
    _classPrivateFieldInitSpec(this, _onConnectionError$1, function() {
    });
    _classPrivateFieldInitSpec(this, _measurements, void 0);
    _classPrivateFieldInitSpec(this, _downloadApi, void 0);
    _classPrivateFieldInitSpec(this, _uploadApi, void 0);
    _classPrivateFieldInitSpec(this, _running$2, false);
    _classPrivateFieldInitSpec(this, _finished$1, {
      down: false,
      up: false
    });
    _classPrivateFieldInitSpec(this, _results$1, {
      down: {},
      up: {}
    });
    _classPrivateFieldInitSpec(this, _measIdx, 0);
    _classPrivateFieldInitSpec(this, _counter, 0);
    _classPrivateFieldInitSpec(this, _retries, 0);
    _classPrivateFieldInitSpec(this, _minDuration, -Infinity);
    _classPrivateFieldInitSpec(this, _throttleMs, 0);
    _classPrivateFieldInitSpec(this, _estimatedServerTime, 0);
    _classPrivateFieldInitSpec(this, _currentFetchPromise, void 0);
    _classPrivateFieldInitSpec(this, _currentNextMsmTimeoutId, void 0);
    if (!_measurements2) throw new Error("Missing measurements argument");
    if (!downloadApiUrl) throw new Error("Missing downloadApiUrl argument");
    if (!uploadApiUrl) throw new Error("Missing uploadApiUrl argument");
    _classPrivateFieldSet2(_measurements, this, _measurements2);
    _classPrivateFieldSet2(_downloadApi, this, downloadApiUrl);
    _classPrivateFieldSet2(_uploadApi, this, uploadApiUrl);
    _classPrivateFieldSet2(_throttleMs, this, throttleMs);
    _classPrivateFieldSet2(_estimatedServerTime, this, Math.max(0, estimatedServerTime));
  }
  return _createClass(BandwidthMeasurementEngine2, [{
    key: "results",
    get: function get() {
      return _classPrivateFieldGet2(_results$1, this);
    }
  }, {
    key: "qsParams",
    get: (
      // additional query string params to include in the requests
      function get() {
        return _classPrivateFieldGet2(_qsParams, this);
      }
    ),
    set: function set2(v) {
      _classPrivateFieldSet2(_qsParams, this, v);
    }
  }, {
    key: "fetchOptions",
    get: (
      // additional options included in the requests
      function get() {
        return _classPrivateFieldGet2(_fetchOptions, this);
      }
    ),
    set: function set2(v) {
      _classPrivateFieldSet2(_fetchOptions, this, v);
    }
  }, {
    key: "responseHook",
    set: (
      // pipe-through of response objects
      function set2(f) {
        _classPrivateFieldSet2(_responseHook, this, f);
      }
    )
  }, {
    key: "onRunningChange",
    set: (
      // callback invoked when engine starts/stops
      function set2(f) {
        _classPrivateFieldSet2(_onRunningChange, this, f);
      }
    )
  }, {
    key: "onNewMeasurementStarted",
    set: (
      // callback invoked when a new item in the measurement list is started
      function set2(f) {
        _classPrivateFieldSet2(_onNewMeasurementStarted, this, f);
      }
    )
  }, {
    key: "onMeasurementResult",
    set: (
      // callback invoked when a new measurement result arrives
      function set2(f) {
        _classPrivateFieldSet2(_onMeasurementResult, this, f);
      }
    )
  }, {
    key: "onFinished",
    set: (
      // callback invoked when all the measurements are finished
      function set2(f) {
        _classPrivateFieldSet2(_onFinished$1, this, f);
      }
    )
  }, {
    key: "onConnectionError",
    set: (
      // Invoked when unable to get a response from the API
      function set2(f) {
        _classPrivateFieldSet2(_onConnectionError$1, this, f);
      }
    )
    // Public methods
  }, {
    key: "pause",
    value: function pause() {
      clearTimeout(_classPrivateFieldGet2(_currentNextMsmTimeoutId, this));
      _assertClassBrand(_BandwidthMeasurementEngine_brand, this, _cancelCurrentMeasurement).call(this);
      _assertClassBrand(_BandwidthMeasurementEngine_brand, this, _setRunning$2).call(this, false);
    }
  }, {
    key: "play",
    value: function play() {
      if (!_classPrivateFieldGet2(_running$2, this)) {
        _assertClassBrand(_BandwidthMeasurementEngine_brand, this, _setRunning$2).call(this, true);
        _assertClassBrand(_BandwidthMeasurementEngine_brand, this, _nextMeasurement).call(this);
      }
    }
  }]);
})();
function _setRunning$2(running) {
  var _this = this;
  if (running !== _classPrivateFieldGet2(_running$2, this)) {
    _classPrivateFieldSet2(_running$2, this, running);
    setTimeout(function() {
      return _classPrivateFieldGet2(_onRunningChange, _this).call(_this, _classPrivateFieldGet2(_running$2, _this));
    });
  }
}
function _saveMeasurementResults(measIdx, measTiming) {
  var _this2 = this;
  var _classPrivateFieldGet2$1 = _classPrivateFieldGet2(_measurements, this)[measIdx], bytes = _classPrivateFieldGet2$1.bytes, dir = _classPrivateFieldGet2$1.dir;
  var results = _classPrivateFieldGet2(_results$1, this);
  var bytesResult = results[dir].hasOwnProperty(bytes) ? results[dir][bytes] : {
    timings: [],
    // count all measurements with same bytes and direction
    numMeasurements: _classPrivateFieldGet2(_measurements, this).filter(function(_ref6) {
      var b = _ref6.bytes, d = _ref6.dir;
      return bytes === b && dir === d;
    }).map(function(m) {
      return m.count;
    }).reduce(function(agg, cnt) {
      return agg + cnt;
    }, 0)
  };
  !!measTiming && bytesResult.timings.push(measTiming);
  bytesResult.timings = bytesResult.timings.slice(-bytesResult.numMeasurements);
  results[dir][bytes] = bytesResult;
  if (measTiming) {
    setTimeout(function() {
      _classPrivateFieldGet2(_onMeasurementResult, _this2).call(_this2, _objectSpread2({
        type: dir,
        bytes
      }, measTiming), results);
    });
  } else {
    _classPrivateFieldGet2(_onNewMeasurementStarted, this).call(this, _classPrivateFieldGet2(_measurements, this)[measIdx], results);
  }
}
function _nextMeasurement() {
  var _this3 = this;
  var measurements = _classPrivateFieldGet2(_measurements, this);
  var meas = measurements[_classPrivateFieldGet2(_measIdx, this)];
  if (_classPrivateFieldGet2(_counter, this) >= meas.count) {
    var finished = _classPrivateFieldGet2(_finished$1, this);
    if (_classPrivateFieldGet2(_minDuration, this) > this.finishRequestDuration && !meas.bypassMinDuration) {
      var _dir = meas.dir;
      _classPrivateFieldGet2(_finished$1, this)[_dir] = true;
      Object.values(_classPrivateFieldGet2(_finished$1, this)).every(function(finished2) {
        return finished2;
      }) && _classPrivateFieldGet2(_onFinished$1, this).call(this, _classPrivateFieldGet2(_results$1, this));
    }
    _classPrivateFieldSet2(_counter, this, 0);
    _classPrivateFieldSet2(_minDuration, this, -Infinity);
    performance.clearResourceTimings();
    do {
      _classPrivateFieldSet2(_measIdx, this, _classPrivateFieldGet2(_measIdx, this) + 1);
    } while (_classPrivateFieldGet2(_measIdx, this) < measurements.length && finished[measurements[_classPrivateFieldGet2(_measIdx, this)].dir]);
    if (_classPrivateFieldGet2(_measIdx, this) >= measurements.length) {
      _classPrivateFieldSet2(_finished$1, this, {
        down: true,
        up: true
      });
      _assertClassBrand(_BandwidthMeasurementEngine_brand, this, _setRunning$2).call(this, false);
      _classPrivateFieldGet2(_onFinished$1, this).call(this, _classPrivateFieldGet2(_results$1, this));
      return;
    }
    meas = measurements[_classPrivateFieldGet2(_measIdx, this)];
  }
  var measIdx = _classPrivateFieldGet2(_measIdx, this);
  if (_classPrivateFieldGet2(_counter, this) === 0) {
    _assertClassBrand(_BandwidthMeasurementEngine_brand, this, _saveMeasurementResults).call(this, measIdx);
  }
  var _meas = meas, numBytes = _meas.bytes, dir = _meas.dir;
  var isDown = dir === "down";
  var apiUrl = isDown ? _classPrivateFieldGet2(_downloadApi, this) : _classPrivateFieldGet2(_uploadApi, this);
  var qsParams = Object.assign({}, _classPrivateFieldGet2(_qsParams, this));
  isDown && (qsParams.bytes = "".concat(numBytes));
  var url = "".concat(
    apiUrl.startsWith("http") || apiUrl.startsWith("//") ? "" : window.location.origin
    // use abs to match perf timing urls
  ).concat(apiUrl, "?").concat(Object.entries(qsParams).map(function(_ref7) {
    var _ref8 = _slicedToArray(_ref7, 2), k = _ref8[0], v = _ref8[1];
    return "".concat(k, "=").concat(v);
  }).join("&"));
  var fetchOpt = Object.assign({}, isDown ? {} : {
    method: "POST",
    body: genContent(numBytes)
  }, _classPrivateFieldGet2(_fetchOptions, this));
  var serverTime;
  var curPromise = _classPrivateFieldSet2(_currentFetchPromise, this, fetch(url, fetchOpt).then(function(r) {
    if (r.ok) return r;
    throw Error(r.statusText);
  }).then(function(r) {
    _this3.getServerTime && (serverTime = _this3.getServerTime(r));
    return r;
  }).then(function(r) {
    return r.text().then(function(body) {
      _classPrivateFieldGet2(_responseHook, _this3) && _classPrivateFieldGet2(_responseHook, _this3).call(_this3, {
        url,
        headers: r.headers,
        body
      });
      return body;
    });
  }).then(function(_, reject) {
    if (curPromise._cancel) {
      reject("cancelled");
      return;
    }
    var perf = performance.getEntriesByName(url).slice(-1)[0];
    var timing = {
      transferSize: perf.transferSize,
      ttfb: getTtfb(perf),
      payloadDownloadTime: gePayloadDownload(perf),
      serverTime: serverTime || -1,
      measTime: /* @__PURE__ */ new Date()
    };
    timing.ping = Math.max(0.01, timing.ttfb - (serverTime || _classPrivateFieldGet2(_estimatedServerTime, _this3)));
    timing.duration = (isDown ? calcDownloadDuration : calcUploadDuration)(timing);
    timing.bps = (isDown ? calcDownloadSpeed : calcUploadSpeed)(timing, numBytes);
    if (isDown && numBytes) {
      var reqSize = +numBytes;
      if (timing.transferSize && (timing.transferSize < reqSize || timing.transferSize / reqSize > 1.05)) {
        console.warn("Requested ".concat(reqSize, "B but received ").concat(timing.transferSize, "B (").concat(Math.round(timing.transferSize / reqSize * 1e4) / 100, "%)."));
      }
    }
    _assertClassBrand(_BandwidthMeasurementEngine_brand, _this3, _saveMeasurementResults).call(_this3, measIdx, timing);
    var requestDuration = timing.duration;
    _classPrivateFieldSet2(_minDuration, _this3, _classPrivateFieldGet2(_minDuration, _this3) < 0 ? requestDuration : Math.min(_classPrivateFieldGet2(_minDuration, _this3), requestDuration));
    _classPrivateFieldSet2(_counter, _this3, _classPrivateFieldGet2(_counter, _this3) + 1);
    _classPrivateFieldSet2(_retries, _this3, 0);
    if (_classPrivateFieldGet2(_throttleMs, _this3)) {
      _classPrivateFieldSet2(_currentNextMsmTimeoutId, _this3, setTimeout(function() {
        return _assertClassBrand(_BandwidthMeasurementEngine_brand, _this3, _nextMeasurement).call(_this3);
      }, _classPrivateFieldGet2(_throttleMs, _this3)));
    } else {
      _assertClassBrand(_BandwidthMeasurementEngine_brand, _this3, _nextMeasurement).call(_this3);
    }
  })["catch"](function(error) {
    var _this$retries, _this$retries2;
    if (curPromise._cancel) return;
    console.warn("Error fetching ".concat(url, ": ").concat(error));
    if ((_classPrivateFieldSet2(_retries, _this3, (_this$retries = _classPrivateFieldGet2(_retries, _this3), _this$retries2 = _this$retries++, _this$retries)), _this$retries2) < MAX_RETRIES) {
      _assertClassBrand(_BandwidthMeasurementEngine_brand, _this3, _nextMeasurement).call(_this3);
    } else {
      _classPrivateFieldSet2(_retries, _this3, 0);
      _assertClassBrand(_BandwidthMeasurementEngine_brand, _this3, _setRunning$2).call(_this3, false);
      _classPrivateFieldGet2(_onConnectionError$1, _this3).call(_this3, "Connection failed to ".concat(url, ". Gave up after ").concat(MAX_RETRIES, " retries."));
    }
  }));
}
function _cancelCurrentMeasurement() {
  var curPromise = _classPrivateFieldGet2(_currentFetchPromise, this);
  curPromise && (curPromise._cancel = true);
}
var _excluded$5 = ["measureParallelLatency", "parallelLatencyThrottleMs", "downloadApiUrl", "uploadApiUrl", "estimatedServerTime"];
var _latencyEngine = /* @__PURE__ */ new WeakMap();
var _latencyTimeout = /* @__PURE__ */ new WeakMap();
var _BandwidthWithParallelLatencyEngine_brand = /* @__PURE__ */ new WeakSet();
var BandwidthWithParallelLatencyEngine = (function(_BandwidthEngine) {
  function BandwidthWithParallelLatencyEngine2(measurements) {
    var _this;
    var _ref = arguments.length > 1 && arguments[1] !== void 0 ? arguments[1] : {}, _ref$measureParallelL = _ref.measureParallelLatency, measureParallelLatency = _ref$measureParallelL === void 0 ? false : _ref$measureParallelL, _ref$parallelLatencyT = _ref.parallelLatencyThrottleMs, parallelLatencyThrottleMs = _ref$parallelLatencyT === void 0 ? 100 : _ref$parallelLatencyT, downloadApiUrl = _ref.downloadApiUrl, uploadApiUrl = _ref.uploadApiUrl, _ref$estimatedServerT = _ref.estimatedServerTime, estimatedServerTime = _ref$estimatedServerT === void 0 ? 0 : _ref$estimatedServerT, ptProps = _objectWithoutProperties(_ref, _excluded$5);
    _classCallCheck(this, BandwidthWithParallelLatencyEngine2);
    _this = _callSuper(this, BandwidthWithParallelLatencyEngine2, [measurements, _objectSpread2({
      downloadApiUrl,
      uploadApiUrl,
      estimatedServerTime
    }, ptProps)]);
    _classPrivateMethodInitSpec(_this, _BandwidthWithParallelLatencyEngine_brand);
    _classPrivateFieldInitSpec(_this, _latencyEngine, void 0);
    _classPrivateFieldInitSpec(_this, _latencyTimeout, void 0);
    if (measureParallelLatency) {
      _classPrivateFieldSet2(_latencyEngine, _this, new BandwidthMeasurementEngine([{
        dir: "down",
        bytes: 0,
        count: Infinity,
        bypassMinDuration: true
      }], {
        downloadApiUrl,
        uploadApiUrl,
        estimatedServerTime,
        throttleMs: parallelLatencyThrottleMs
      }));
      _classPrivateFieldGet2(_latencyEngine, _this).qsParams = {
        during: "".concat(measurements[0].dir, "load")
      };
      _superPropSet(BandwidthWithParallelLatencyEngine2, "onRunningChange", _assertClassBrand(_BandwidthWithParallelLatencyEngine_brand, _this, _setLatencyRunning), _this, 1);
      _superPropSet(BandwidthWithParallelLatencyEngine2, "onConnectionError", function() {
        return _classPrivateFieldGet2(_latencyEngine, _this).pause();
      }, _this, 1);
    }
    return _this;
  }
  _inherits(BandwidthWithParallelLatencyEngine2, _BandwidthEngine);
  return _createClass(BandwidthWithParallelLatencyEngine2, [{
    key: "latencyResults",
    get: function get() {
      return _classPrivateFieldGet2(_latencyEngine, this) && _classPrivateFieldGet2(_latencyEngine, this).results.down[0].timings;
    }
    // callback invoked when a new parallel latency result arrives
  }, {
    key: "onParallelLatencyResult",
    set: function set2(f) {
      _classPrivateFieldGet2(_latencyEngine, this) && (_classPrivateFieldGet2(_latencyEngine, this).onMeasurementResult = function(res) {
        return f(res);
      });
    }
    // Overridden attributes
  }, {
    key: "fetchOptions",
    get: function get() {
      return _superPropGet(BandwidthWithParallelLatencyEngine2, "fetchOptions", this, 1);
    },
    set: function set2(fetchOptions) {
      _superPropSet(BandwidthWithParallelLatencyEngine2, "fetchOptions", fetchOptions, this, 1);
      _classPrivateFieldGet2(_latencyEngine, this) && (_classPrivateFieldGet2(_latencyEngine, this).fetchOptions = fetchOptions);
    }
  }, {
    key: "onRunningChange",
    set: function set2(onRunningChange) {
      var _this2 = this;
      _superPropSet(BandwidthWithParallelLatencyEngine2, "onRunningChange", function(running) {
        _assertClassBrand(_BandwidthWithParallelLatencyEngine_brand, _this2, _setLatencyRunning).call(_this2, running);
        onRunningChange(running);
      }, this, 1);
    }
  }, {
    key: "onConnectionError",
    set: function set2(onConnectionError) {
      var _this3 = this;
      _superPropSet(BandwidthWithParallelLatencyEngine2, "onConnectionError", function() {
        _classPrivateFieldGet2(_latencyEngine, _this3) && _classPrivateFieldGet2(_latencyEngine, _this3).pause();
        onConnectionError.apply(void 0, arguments);
      }, this, 1);
    }
  }]);
})(BandwidthMeasurementEngine);
function _setLatencyRunning(running) {
  var _this4 = this;
  if (_classPrivateFieldGet2(_latencyEngine, this)) {
    if (!running) {
      clearTimeout(_classPrivateFieldGet2(_latencyTimeout, this));
      _classPrivateFieldGet2(_latencyEngine, this).pause();
    } else {
      _classPrivateFieldSet2(_latencyTimeout, this, setTimeout(function() {
        return _classPrivateFieldGet2(_latencyEngine, _this4).play();
      }, 20));
    }
  }
}
var _excluded$4 = ["measurementId", "logApiUrl", "sessionId"];
var _measurementId$1 = /* @__PURE__ */ new WeakMap();
var _token = /* @__PURE__ */ new WeakMap();
var _requestTime = /* @__PURE__ */ new WeakMap();
var _logApiUrl = /* @__PURE__ */ new WeakMap();
var _sessionId$1 = /* @__PURE__ */ new WeakMap();
var _LoggingBandwidthEngine_brand = /* @__PURE__ */ new WeakSet();
var LoggingBandwidthEngine = (function(_BandwidthEngine) {
  function LoggingBandwidthEngine2(measurements) {
    var _this;
    var _ref = arguments.length > 1 && arguments[1] !== void 0 ? arguments[1] : {}, measurementId = _ref.measurementId, logApiUrl = _ref.logApiUrl, sessionId = _ref.sessionId, ptProps = _objectWithoutProperties(_ref, _excluded$4);
    _classCallCheck(this, LoggingBandwidthEngine2);
    _this = _callSuper(this, LoggingBandwidthEngine2, [measurements, ptProps]);
    _classPrivateMethodInitSpec(_this, _LoggingBandwidthEngine_brand);
    _classPrivateFieldInitSpec(_this, _measurementId$1, void 0);
    _classPrivateFieldInitSpec(_this, _token, void 0);
    _classPrivateFieldInitSpec(_this, _requestTime, void 0);
    _classPrivateFieldInitSpec(_this, _logApiUrl, void 0);
    _classPrivateFieldInitSpec(_this, _sessionId$1, void 0);
    _classPrivateFieldSet2(_measurementId$1, _this, measurementId);
    _classPrivateFieldSet2(_logApiUrl, _this, logApiUrl);
    _classPrivateFieldSet2(_sessionId$1, _this, sessionId);
    _superPropSet(LoggingBandwidthEngine2, "qsParams", logApiUrl ? {
      measId: _classPrivateFieldGet2(_measurementId$1, _this)
    } : {}, _this, 1);
    _superPropSet(LoggingBandwidthEngine2, "responseHook", function(r) {
      return _assertClassBrand(_LoggingBandwidthEngine_brand, _this, _loggingResponseHook).call(_this, r);
    }, _this, 1);
    _superPropSet(LoggingBandwidthEngine2, "onMeasurementResult", function(meas) {
      return _assertClassBrand(_LoggingBandwidthEngine_brand, _this, _logMeasurement).call(_this, meas);
    }, _this, 1);
    return _this;
  }
  _inherits(LoggingBandwidthEngine2, _BandwidthEngine);
  return _createClass(LoggingBandwidthEngine2, [{
    key: "qsParams",
    set: function set2(qsParams) {
      _superPropSet(LoggingBandwidthEngine2, "qsParams", _classPrivateFieldGet2(_logApiUrl, this) ? _objectSpread2({
        measId: _classPrivateFieldGet2(_measurementId$1, this)
      }, qsParams) : qsParams, this, 1);
    }
  }, {
    key: "responseHook",
    set: function set2(responseHook) {
      var _this2 = this;
      _superPropSet(LoggingBandwidthEngine2, "responseHook", function(r) {
        responseHook(r);
        _assertClassBrand(_LoggingBandwidthEngine_brand, _this2, _loggingResponseHook).call(_this2, r);
      }, this, 1);
    }
  }, {
    key: "onMeasurementResult",
    set: function set2(onMeasurementResult) {
      var _this3 = this;
      _superPropSet(LoggingBandwidthEngine2, "onMeasurementResult", function(meas) {
        for (var _len = arguments.length, restArgs = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
          restArgs[_key - 1] = arguments[_key];
        }
        onMeasurementResult.apply(void 0, [meas].concat(restArgs));
        _assertClassBrand(_LoggingBandwidthEngine_brand, _this3, _logMeasurement).call(_this3, meas);
      }, this, 1);
    }
  }]);
})(BandwidthWithParallelLatencyEngine);
function _loggingResponseHook(r) {
  if (!_classPrivateFieldGet2(_logApiUrl, this)) return;
  _classPrivateFieldSet2(_requestTime, this, +r.headers.get("cf-meta-request-time"));
  _classPrivateFieldSet2(_token, this, r.body.slice(-300).split("___").pop());
}
function _logMeasurement(measData) {
  if (!_classPrivateFieldGet2(_logApiUrl, this)) return;
  var logData = {
    type: measData.type,
    bytes: measData.bytes,
    ping: Math.round(measData.ping),
    // round to ms
    ttfb: Math.round(measData.ttfb),
    // round to ms
    payloadDownloadTime: Math.round(measData.payloadDownloadTime),
    duration: Math.round(measData.duration),
    transferSize: Math.round(measData.transferSize),
    serverTime: Math.round(measData.serverTime),
    token: _classPrivateFieldGet2(_token, this),
    requestTime: _classPrivateFieldGet2(_requestTime, this),
    measId: _classPrivateFieldGet2(_measurementId$1, this),
    sessionId: _classPrivateFieldGet2(_sessionId$1, this)
  };
  _classPrivateFieldSet2(_token, this, null);
  _classPrivateFieldSet2(_requestTime, this, null);
  fetch(_classPrivateFieldGet2(_logApiUrl, this), _objectSpread2({
    method: "POST",
    body: JSON.stringify(logData)
  }, this.fetchOptions));
}
var _running$1 = /* @__PURE__ */ new WeakMap();
var _currentPromise = /* @__PURE__ */ new WeakMap();
var _promiseFn = /* @__PURE__ */ new WeakMap();
var _PromiseEngine_brand = /* @__PURE__ */ new WeakSet();
var PromiseEngine = (function() {
  function PromiseEngine2(promiseFn) {
    _classCallCheck(this, PromiseEngine2);
    _classPrivateMethodInitSpec(this, _PromiseEngine_brand);
    _classPrivateFieldInitSpec(this, _running$1, false);
    _classPrivateFieldInitSpec(this, _currentPromise, void 0);
    _classPrivateFieldInitSpec(this, _promiseFn, void 0);
    if (!promiseFn) throw new Error("Missing operation to perform");
    _classPrivateFieldSet2(_promiseFn, this, promiseFn);
    this.play();
  }
  return _createClass(PromiseEngine2, [{
    key: "pause",
    value: function pause() {
      _assertClassBrand(_PromiseEngine_brand, this, _cancelCurrent).call(this);
      _assertClassBrand(_PromiseEngine_brand, this, _setRunning$1).call(this, false);
    }
  }, {
    key: "stop",
    value: function stop() {
      this.pause();
    }
  }, {
    key: "play",
    value: function play() {
      if (!_classPrivateFieldGet2(_running$1, this)) {
        _assertClassBrand(_PromiseEngine_brand, this, _setRunning$1).call(this, true);
        _assertClassBrand(_PromiseEngine_brand, this, _next$1).call(this);
      }
    }
  }]);
})();
function _setRunning$1(running) {
  if (running !== _classPrivateFieldGet2(_running$1, this)) {
    _classPrivateFieldSet2(_running$1, this, running);
  }
}
function _next$1() {
  var _this2 = this;
  var curPromise = _classPrivateFieldSet2(_currentPromise, this, _classPrivateFieldGet2(_promiseFn, this).call(this).then(function() {
    !curPromise._cancel && _assertClassBrand(_PromiseEngine_brand, _this2, _next$1).call(_this2);
  }));
}
function _cancelCurrent() {
  var curPromise = _classPrivateFieldGet2(_currentPromise, this);
  curPromise && (curPromise._cancel = true);
}
var _engines = /* @__PURE__ */ new WeakMap();
var LoadNetworkEngine = (function() {
  function LoadNetworkEngine2() {
    var _this = this;
    var _ref = arguments.length > 0 && arguments[0] !== void 0 ? arguments[0] : {}, download = _ref.download, upload = _ref.upload;
    _classCallCheck(this, LoadNetworkEngine2);
    _defineProperty(this, "qsParams", {});
    _defineProperty(this, "fetchOptions", {});
    _classPrivateFieldInitSpec(this, _engines, []);
    if (!download && !upload) throw new Error("Missing at least one of download/upload config");
    [[download, "download"], [upload, "upload"]].filter(function(_ref2) {
      var _ref3 = _slicedToArray(_ref2, 1), cfg = _ref3[0];
      return cfg;
    }).forEach(function(_ref4) {
      var _ref5 = _slicedToArray(_ref4, 2), cfg = _ref5[0], type = _ref5[1];
      var apiUrl = cfg.apiUrl, chunkSize = cfg.chunkSize;
      if (!apiUrl) throw new Error("Missing ".concat(type, " apiUrl argument"));
      if (!chunkSize) throw new Error("Missing ".concat(type, " chunkSize argument"));
    });
    var getLoadEngine = function getLoadEngine2(_ref6) {
      var apiUrl = _ref6.apiUrl, _ref6$qsParams = _ref6.qsParams, qsParams = _ref6$qsParams === void 0 ? {} : _ref6$qsParams, _ref6$fetchOptions = _ref6.fetchOptions, fetchOptions = _ref6$fetchOptions === void 0 ? {} : _ref6$fetchOptions;
      return new PromiseEngine(function() {
        var fetchQsParams = Object.assign({}, qsParams, _this.qsParams);
        var url = "".concat(
          apiUrl.startsWith("http") || apiUrl.startsWith("//") ? "" : window.location.origin
          // use abs to match perf timing urls
        ).concat(apiUrl, "?").concat(Object.entries(fetchQsParams).map(function(_ref7) {
          var _ref8 = _slicedToArray(_ref7, 2), k = _ref8[0], v = _ref8[1];
          return "".concat(k, "=").concat(v);
        }).join("&"));
        var fetchOpt = Object.assign({}, fetchOptions, _this.fetchOptions);
        return fetch(url, fetchOpt).then(function(r) {
          if (r.ok) return r;
          throw Error(r.statusText);
        }).then(function(r) {
          return r.text();
        });
      });
    };
    download && _classPrivateFieldGet2(_engines, this).push(getLoadEngine({
      apiUrl: download.apiUrl,
      qsParams: {
        bytes: "".concat(download.chunkSize)
      }
    }));
    upload && _classPrivateFieldGet2(_engines, this).push(getLoadEngine({
      apiUrl: upload.apiUrl,
      fetchOptions: {
        method: "POST",
        body: "0".repeat(upload.chunkSize)
      }
    }));
  }
  return _createClass(LoadNetworkEngine2, [{
    key: "pause",
    value: (
      // additional options included in the requests
      // Public methods
      function pause() {
        _classPrivateFieldGet2(_engines, this).forEach(function(engine) {
          return engine.pause();
        });
      }
    )
  }, {
    key: "stop",
    value: function stop() {
      this.pause();
    }
  }, {
    key: "play",
    value: function play() {
      _classPrivateFieldGet2(_engines, this).forEach(function(engine) {
        return engine.play();
      });
    }
  }]);
})();
var _excluded$3 = ["iceServers", "acceptIceCandidate", "dataChannelCfg"];
var _established = /* @__PURE__ */ new WeakMap();
var _sender = /* @__PURE__ */ new WeakMap();
var _receiver = /* @__PURE__ */ new WeakMap();
var _senderDc = /* @__PURE__ */ new WeakMap();
var _receiverDc = /* @__PURE__ */ new WeakMap();
var SelfWebRtcDataConnection = (function() {
  function SelfWebRtcDataConnection2() {
    var _this = this;
    var _ref = arguments.length > 0 && arguments[0] !== void 0 ? arguments[0] : {}, _ref$iceServers = _ref.iceServers, iceServers = _ref$iceServers === void 0 ? [] : _ref$iceServers, _ref$acceptIceCandida = _ref.acceptIceCandidate, acceptIceCandidate = _ref$acceptIceCandida === void 0 ? function(candidate) {
      var protocol = candidate.protocol || "";
      if (!protocol && candidate.candidate) {
        var sdpAttrs = candidate.candidate.split(" ");
        sdpAttrs.length >= 3 && (protocol = sdpAttrs[2]);
      }
      return protocol.toLowerCase() === "udp";
    } : _ref$acceptIceCandida, _ref$dataChannelCfg = _ref.dataChannelCfg, dataChannelCfg = _ref$dataChannelCfg === void 0 ? {
      ordered: false,
      maxRetransmits: 0
    } : _ref$dataChannelCfg, rtcPeerConnectionCfg = _objectWithoutProperties(_ref, _excluded$3);
    _classCallCheck(this, SelfWebRtcDataConnection2);
    _defineProperty(this, "onOpen", function() {
    });
    _defineProperty(this, "onClose", function() {
    });
    _defineProperty(this, "onMessageReceived", function() {
    });
    _classPrivateFieldInitSpec(this, _established, false);
    _classPrivateFieldInitSpec(this, _sender, void 0);
    _classPrivateFieldInitSpec(this, _receiver, void 0);
    _classPrivateFieldInitSpec(this, _senderDc, void 0);
    _classPrivateFieldInitSpec(this, _receiverDc, void 0);
    var sender = new RTCPeerConnection(_objectSpread2({
      iceServers
    }, rtcPeerConnectionCfg));
    var receiver = new RTCPeerConnection(_objectSpread2({
      iceServers
    }, rtcPeerConnectionCfg));
    var senderDc = sender.createDataChannel("channel", dataChannelCfg);
    senderDc.onopen = function() {
      _classPrivateFieldSet2(_established, _this, true);
      _this.onOpen();
    };
    senderDc.onclose = function() {
      return _this.close();
    };
    receiver.ondatachannel = function(e) {
      var dc = e.channel;
      dc.onclose = function() {
        return _this.close();
      };
      dc.onmessage = function(msg) {
        return _this.onMessageReceived(msg.data);
      };
      _classPrivateFieldSet2(_receiverDc, _this, dc);
    };
    sender.onicecandidate = function(e) {
      e.candidate && acceptIceCandidate(e.candidate) && receiver.addIceCandidate(e.candidate);
    };
    receiver.onicecandidate = function(e) {
      e.candidate && acceptIceCandidate(e.candidate) && sender.addIceCandidate(e.candidate);
    };
    sender.createOffer().then(function(offer) {
      return sender.setLocalDescription(offer);
    }).then(function() {
      return receiver.setRemoteDescription(sender.localDescription);
    }).then(function() {
      return receiver.createAnswer();
    }).then(function(answer) {
      return receiver.setLocalDescription(answer);
    }).then(function() {
      return sender.setRemoteDescription(receiver.localDescription);
    });
    _classPrivateFieldSet2(_sender, this, sender);
    _classPrivateFieldSet2(_receiver, this, receiver);
    _classPrivateFieldSet2(_senderDc, this, senderDc);
    _classPrivateFieldSet2(_established, this, false);
  }
  return _createClass(SelfWebRtcDataConnection2, [{
    key: "send",
    value: (
      // callback invoked when a new message is received from the TURN server
      // Public methods
      function send(msg) {
        return _classPrivateFieldGet2(_senderDc, this).send(msg);
      }
    )
  }, {
    key: "close",
    value: function close() {
      _classPrivateFieldGet2(_sender, this) && _classPrivateFieldGet2(_sender, this).close();
      _classPrivateFieldGet2(_receiver, this) && _classPrivateFieldGet2(_receiver, this).close();
      _classPrivateFieldGet2(_senderDc, this) && _classPrivateFieldGet2(_senderDc, this).close();
      _classPrivateFieldGet2(_receiverDc, this) && _classPrivateFieldGet2(_receiverDc, this).close();
      _classPrivateFieldGet2(_established, this) && this.onClose();
      _classPrivateFieldSet2(_established, this, false);
      return this;
    }
  }]);
})();
var _onCredentialsFailure = /* @__PURE__ */ new WeakMap();
var _onConnectionError = /* @__PURE__ */ new WeakMap();
var _onFinished = /* @__PURE__ */ new WeakMap();
var _msgTracker = /* @__PURE__ */ new WeakMap();
var _webRtcConnection = /* @__PURE__ */ new WeakMap();
var _numMsgs = /* @__PURE__ */ new WeakMap();
var PacketLossEngine = (function() {
  function PacketLossEngine2() {
    var _this = this;
    var _ref = arguments.length > 0 && arguments[0] !== void 0 ? arguments[0] : {}, turnServerUri = _ref.turnServerUri, turnServerCredsApi = _ref.turnServerCredsApi, _ref$turnServerCredsA = _ref.turnServerCredsApiParser, turnServerCredsApiParser = _ref$turnServerCredsA === void 0 ? function(_ref2) {
      var username = _ref2.username, credential = _ref2.credential, server = _ref2.server;
      return {
        turnServerUser: username,
        turnServerPass: credential,
        turnServerUri: server
      };
    } : _ref$turnServerCredsA, _ref$turnServerCredsA2 = _ref.turnServerCredsApiIncludeCredentials, turnServerCredsApiIncludeCredentials = _ref$turnServerCredsA2 === void 0 ? false : _ref$turnServerCredsA2, turnServerUser = _ref.turnServerUser, turnServerPass = _ref.turnServerPass, _ref$numMsgs = _ref.numMsgs, numMsgs = _ref$numMsgs === void 0 ? 100 : _ref$numMsgs, _ref$batchSize = _ref.batchSize, batchSize = _ref$batchSize === void 0 ? 10 : _ref$batchSize, _ref$batchWaitTime = _ref.batchWaitTime, batchWaitTime = _ref$batchWaitTime === void 0 ? 10 : _ref$batchWaitTime, _ref$responsesWaitTim = _ref.responsesWaitTime, responsesWaitTime = _ref$responsesWaitTim === void 0 ? 5e3 : _ref$responsesWaitTim, _ref$connectionTimeou = _ref.connectionTimeout, connectionTimeout = _ref$connectionTimeou === void 0 ? 5e3 : _ref$connectionTimeou;
    _classCallCheck(this, PacketLossEngine2);
    _classPrivateFieldInitSpec(this, _onCredentialsFailure, function() {
    });
    _classPrivateFieldInitSpec(this, _onConnectionError, function() {
    });
    _classPrivateFieldInitSpec(this, _onFinished, function() {
    });
    _defineProperty(this, "onMsgSent", function() {
    });
    _defineProperty(this, "onAllMsgsSent", function() {
    });
    _defineProperty(this, "onMsgReceived", function() {
    });
    _classPrivateFieldInitSpec(this, _msgTracker, {});
    _classPrivateFieldInitSpec(this, _webRtcConnection, void 0);
    _classPrivateFieldInitSpec(this, _numMsgs, void 0);
    if (!turnServerUri && !turnServerCredsApi) throw new Error("Missing turnServerCredsApi or turnServerUri argument");
    if ((!turnServerUser || !turnServerPass) && !turnServerCredsApi) throw new Error("Missing either turnServerCredsApi or turnServerUser+turnServerPass arguments");
    _classPrivateFieldSet2(_numMsgs, this, numMsgs);
    (!turnServerUser || !turnServerPass ? (
      // Get TURN credentials from API endpoint if not statically supplied
      fetch(turnServerCredsApi, {
        credentials: turnServerCredsApiIncludeCredentials ? "include" : void 0
      }).then(function(r) {
        return r.json();
      }).then(function(d) {
        if (d.error) throw d.error;
        return d;
      }).then(turnServerCredsApiParser)
    ) : Promise.resolve({
      turnServerUser,
      turnServerPass
    }))["catch"](function(e) {
      return _classPrivateFieldGet2(_onCredentialsFailure, _this).call(_this, e);
    }).then(function(_ref3) {
      var turnServerUser2 = _ref3.turnServerUser, turnServerPass2 = _ref3.turnServerPass, credsApiTurnServerUri = _ref3.turnServerUri;
      var c = _classPrivateFieldSet2(_webRtcConnection, _this, new SelfWebRtcDataConnection({
        iceServers: [{
          urls: "turn:".concat(credsApiTurnServerUri || turnServerUri, "?transport=udp"),
          username: turnServerUser2,
          credential: turnServerPass2
        }],
        iceTransportPolicy: "relay"
      }));
      var connectionSuccess = false;
      setTimeout(function() {
        if (!connectionSuccess) {
          c.close();
          _classPrivateFieldGet2(_onConnectionError, _this).call(_this, "ICE connection timeout!");
        }
      }, connectionTimeout);
      var msgTracker = _classPrivateFieldGet2(_msgTracker, _this);
      c.onOpen = function() {
        connectionSuccess = true;
        var self2 = _this;
        (function sendNum(n) {
          if (n <= numMsgs) {
            var i = n;
            while (i <= Math.min(numMsgs, n + batchSize - 1)) {
              msgTracker[i] = false;
              c.send(i);
              self2.onMsgSent(i);
              i++;
            }
            setTimeout(function() {
              return sendNum(i);
            }, batchWaitTime);
          } else {
            self2.onAllMsgsSent(Object.keys(msgTracker).length);
            var finishFn = function finishFn2() {
              c.close();
              _classPrivateFieldGet2(_onFinished, self2).call(self2, self2.results);
            };
            var finishTimeout = setTimeout(finishFn, responsesWaitTime);
            var missingMsgs = Object.values(_classPrivateFieldGet2(_msgTracker, self2)).filter(function(recv) {
              return !recv;
            }).length;
            c.onMessageReceived = function(msg) {
              clearTimeout(finishTimeout);
              msgTracker[msg] = true;
              self2.onMsgReceived(msg);
              missingMsgs--;
              if (missingMsgs <= 0 && Object.values(_classPrivateFieldGet2(_msgTracker, self2)).every(function(recv) {
                return recv;
              })) {
                finishFn();
              } else {
                finishTimeout = setTimeout(finishFn, responsesWaitTime);
              }
            };
          }
        })(1);
      };
      c.onMessageReceived = function(msg) {
        msgTracker[msg] = true;
        _this.onMsgReceived(msg);
      };
    })["catch"](function(e) {
      return _classPrivateFieldGet2(_onConnectionError, _this).call(_this, e.toString());
    });
  }
  return _createClass(PacketLossEngine2, [{
    key: "onCredentialsFailure",
    set: (
      // Invoked when unable to fetch TURN server credentials
      function set2(f) {
        _classPrivateFieldSet2(_onCredentialsFailure, this, f);
      }
    )
  }, {
    key: "onConnectionError",
    set: (
      // Invoked when unable to establish a connection with TURN server
      function set2(f) {
        _classPrivateFieldSet2(_onConnectionError, this, f);
      }
    )
  }, {
    key: "onFinished",
    set: (
      // Invoked when the packet loss measurement is complete
      function set2(f) {
        _classPrivateFieldSet2(_onFinished, this, f);
      }
    )
  }, {
    key: "results",
    get: (
      // Invoked when receiving a new message from the TURN server
      function get() {
        var totalMessages = _classPrivateFieldGet2(_numMsgs, this);
        var numMessagesSent = Object.keys(_classPrivateFieldGet2(_msgTracker, this)).length;
        var lostMessages = Object.entries(_classPrivateFieldGet2(_msgTracker, this)).filter(function(_ref4) {
          var _ref5 = _slicedToArray(_ref4, 2), recv = _ref5[1];
          return !recv;
        }).map(function(_ref6) {
          var _ref7 = _slicedToArray(_ref6, 1), n = _ref7[0];
          return +n;
        });
        var packetLoss = lostMessages.length / numMessagesSent;
        return {
          totalMessages,
          numMessagesSent,
          packetLoss,
          lostMessages
        };
      }
    )
  }]);
})();
var _excluded$2 = ["downloadChunkSize", "uploadChunkSize", "downloadApiUrl", "uploadApiUrl"];
var _loadEngine = /* @__PURE__ */ new WeakMap();
var PacketLossUnderLoadEngine = (function(_PacketLossEngine) {
  function PacketLossUnderLoadEngine2() {
    var _this;
    var _ref = arguments.length > 0 && arguments[0] !== void 0 ? arguments[0] : {}, downloadChunkSize = _ref.downloadChunkSize, uploadChunkSize = _ref.uploadChunkSize, downloadApiUrl = _ref.downloadApiUrl, uploadApiUrl = _ref.uploadApiUrl, ptProps = _objectWithoutProperties(_ref, _excluded$2);
    _classCallCheck(this, PacketLossUnderLoadEngine2);
    _this = _callSuper(this, PacketLossUnderLoadEngine2, [ptProps]);
    _classPrivateFieldInitSpec(_this, _loadEngine, void 0);
    if (downloadChunkSize || uploadChunkSize) {
      _classPrivateFieldSet2(_loadEngine, _this, new LoadNetworkEngine({
        download: downloadChunkSize ? {
          apiUrl: downloadApiUrl,
          chunkSize: downloadChunkSize
        } : null,
        upload: uploadChunkSize ? {
          apiUrl: uploadApiUrl,
          chunkSize: uploadChunkSize
        } : null
      }));
      _superPropSet(PacketLossUnderLoadEngine2, "onCredentialsFailure", _superPropSet(PacketLossUnderLoadEngine2, "onConnectionError", _superPropSet(PacketLossUnderLoadEngine2, "onFinished", function() {
        return _classPrivateFieldGet2(_loadEngine, _this).stop();
      }, _this, 1, 1), _this, 1, 1), _this, 1);
    }
    return _this;
  }
  _inherits(PacketLossUnderLoadEngine2, _PacketLossEngine);
  return _createClass(PacketLossUnderLoadEngine2, [{
    key: "qsParams",
    set: function set2(qsParams) {
      _classPrivateFieldGet2(_loadEngine, this) && (_classPrivateFieldGet2(_loadEngine, this).qsParams = qsParams);
    }
  }, {
    key: "fetchOptions",
    set: function set2(fetchOptions) {
      _classPrivateFieldGet2(_loadEngine, this) && (_classPrivateFieldGet2(_loadEngine, this).fetchOptions = fetchOptions);
    }
  }, {
    key: "onCredentialsFailure",
    set: function set2(onCredentialsFailure) {
      var _this2 = this;
      _superPropSet(PacketLossUnderLoadEngine2, "onCredentialsFailure", function() {
        onCredentialsFailure.apply(void 0, arguments);
        _classPrivateFieldGet2(_loadEngine, _this2) && _classPrivateFieldGet2(_loadEngine, _this2).stop();
      }, this, 1);
    }
  }, {
    key: "onConnectionError",
    set: function set2(onConnectionError) {
      var _this3 = this;
      _superPropSet(PacketLossUnderLoadEngine2, "onConnectionError", function() {
        onConnectionError.apply(void 0, arguments);
        _classPrivateFieldGet2(_loadEngine, _this3) && _classPrivateFieldGet2(_loadEngine, _this3).stop();
      }, this, 1);
    }
  }, {
    key: "onFinished",
    set: function set2(onFinished) {
      var _this4 = this;
      _superPropSet(PacketLossUnderLoadEngine2, "onFinished", function() {
        onFinished.apply(void 0, arguments);
        _classPrivateFieldGet2(_loadEngine, _this4) && _classPrivateFieldGet2(_loadEngine, _this4).stop();
      }, this, 1);
    }
  }]);
})(PacketLossEngine);
var _excluded$1 = ["reachable"];
var ReachabilityEngine = _createClass(function ReachabilityEngine2(targetUrl) {
  var _this = this;
  var _ref = arguments.length > 1 && arguments[1] !== void 0 ? arguments[1] : {}, _ref$timeout = _ref.timeout, timeout = _ref$timeout === void 0 ? -1 : _ref$timeout, _ref$fetchOptions = _ref.fetchOptions, fetchOptions = _ref$fetchOptions === void 0 ? {} : _ref$fetchOptions;
  _classCallCheck(this, ReachabilityEngine2);
  _defineProperty(this, "onFinished", function() {
  });
  var finished = false;
  var finish = function finish2(_ref2) {
    var reachable = _ref2.reachable, rest = _objectWithoutProperties(_ref2, _excluded$1);
    if (finished) return;
    finished = true;
    _this.onFinished(_objectSpread2({
      targetUrl,
      reachable
    }, rest));
  };
  fetch(targetUrl, fetchOptions).then(function(response) {
    finish({
      reachable: true,
      response
    });
  })["catch"](function(error) {
    finish({
      reachable: false,
      error
    });
  });
  timeout > 0 && setTimeout(function() {
    return finish({
      reachable: false,
      error: "Request timeout"
    });
  }, timeout);
});
var sum2 = function sum3(vals) {
  return vals.reduce(function(agg, val) {
    return agg + val;
  }, 0);
};
var percentile = function percentile2(vals) {
  var perc = arguments.length > 1 && arguments[1] !== void 0 ? arguments[1] : 0.5;
  if (!vals.length) return 0;
  var sortedVals = vals.slice().sort(function(a, b) {
    return a - b;
  });
  var idx = (vals.length - 1) * perc;
  var rem = idx % 1;
  if (rem === 0) return sortedVals[Math.round(idx)];
  var edges = [Math.floor, Math.ceil].map(function(rndFn) {
    return sortedVals[rndFn(idx)];
  });
  return edges[0] + (edges[1] - edges[0]) * rem;
};
var _config$3 = /* @__PURE__ */ new WeakMap();
var _extractLoadedLatencies = /* @__PURE__ */ new WeakMap();
var MeasurementCalculations = (function() {
  function MeasurementCalculations2(config) {
    var _this = this;
    _classCallCheck(this, MeasurementCalculations2);
    _defineProperty(this, "getLatencyPoints", function(latencyResults) {
      return latencyResults.timings.map(function(d) {
        return d.ping;
      });
    });
    _defineProperty(this, "getLatency", function(latencyResults) {
      return percentile(_this.getLatencyPoints(latencyResults), _classPrivateFieldGet2(_config$3, _this).latencyPercentile);
    });
    _defineProperty(this, "getBandwidthPoints", function(bandwidthResults) {
      return Object.entries(bandwidthResults).map(function(_ref) {
        var _ref2 = _slicedToArray(_ref, 2), bytes = _ref2[0], timings = _ref2[1].timings;
        return timings.map(function(_ref3) {
          var bps = _ref3.bps, duration = _ref3.duration, ping = _ref3.ping, measTime = _ref3.measTime, serverTime = _ref3.serverTime, transferSize = _ref3.transferSize;
          return {
            bytes: +bytes,
            bps,
            duration,
            ping,
            measTime,
            serverTime,
            transferSize
          };
        });
      }).flat();
    });
    _defineProperty(this, "getBandwidth", function(bandwidthResults) {
      return percentile(_this.getBandwidthPoints(bandwidthResults).filter(function(d) {
        return d.duration >= _classPrivateFieldGet2(_config$3, _this).bandwidthMinRequestDuration;
      }).map(function(d) {
        return d.bps;
      }).filter(function(bps) {
        return bps;
      }), _classPrivateFieldGet2(_config$3, _this).bandwidthPercentile);
    });
    _defineProperty(this, "getLoadedLatency", function(loadedResults) {
      return _this.getLatency({
        timings: _classPrivateFieldGet2(_extractLoadedLatencies, _this).call(_this, loadedResults)
      });
    });
    _defineProperty(this, "getLoadedJitter", function(loadedResults) {
      return _this.getJitter({
        timings: _classPrivateFieldGet2(_extractLoadedLatencies, _this).call(_this, loadedResults)
      });
    });
    _defineProperty(this, "getLoadedLatencyPoints", function(loadedResults) {
      return _this.getLatencyPoints({
        timings: _classPrivateFieldGet2(_extractLoadedLatencies, _this).call(_this, loadedResults)
      });
    });
    _defineProperty(this, "getPacketLoss", function(plResults) {
      return plResults.packetLoss;
    });
    _defineProperty(this, "getPacketLossDetails", function(plResults) {
      return plResults;
    });
    _defineProperty(this, "getReachability", function(reachabilityResults) {
      return !!reachabilityResults.reachable;
    });
    _defineProperty(this, "getReachabilityDetails", function(d) {
      return {
        host: d.host,
        reachable: d.reachable
      };
    });
    _classPrivateFieldInitSpec(this, _config$3, void 0);
    _classPrivateFieldInitSpec(this, _extractLoadedLatencies, function(loadedResults) {
      return Object.values(loadedResults).filter(
        // keep only file sizes that saturated the connection
        function(d) {
          return d.timings.length && Math.min.apply(Math, _toConsumableArray(d.timings.map(function(d2) {
            return d2.duration;
          }))) >= _classPrivateFieldGet2(_config$3, _this).loadedRequestMinDuration;
        }
      ).map(function(d) {
        return d.sideLatency || [];
      }).flat().slice(-_classPrivateFieldGet2(_config$3, _this).loadedLatencyMaxPoints);
    });
    _classPrivateFieldSet2(_config$3, this, config);
  }
  return _createClass(MeasurementCalculations2, [{
    key: "getJitter",
    value: function getJitter(latencyResults) {
      var pings = this.getLatencyPoints(latencyResults);
      return pings.length < 2 ? null : pings.reduce(function(_ref4, latency) {
        var _ref4$sumDeltas = _ref4.sumDeltas, sumDeltas = _ref4$sumDeltas === void 0 ? 0 : _ref4$sumDeltas, prevLatency = _ref4.prevLatency;
        return {
          sumDeltas: sumDeltas + (prevLatency !== void 0 ? Math.abs(prevLatency - latency) : 0),
          prevLatency: latency
        };
      }, {}).sumDeltas / (pings.length - 1);
    }
    // last measurements are most accurate
  }]);
})();
var classificationNames = ["bad", "poor", "average", "good", "great"];
var customResultTypes = {
  loadedLatencyIncrease: function loadedLatencyIncrease(measurements) {
    return measurements.latency && (measurements.downLoadedLatency || measurements.upLoadedLatency) ? Math.max(measurements.downLoadedLatency, measurements.upLoadedLatency) - measurements.latency : void 0;
  }
};
var defaultPoints = {
  packetLoss: 0
};
var _config$2 = /* @__PURE__ */ new WeakMap();
var ScoresCalculations = (function() {
  function ScoresCalculations2(config) {
    _classCallCheck(this, ScoresCalculations2);
    _classPrivateFieldInitSpec(this, _config$2, void 0);
    _classPrivateFieldSet2(_config$2, this, config);
  }
  return _createClass(ScoresCalculations2, [{
    key: "getScores",
    value: function getScores(measurements) {
      var scores = Object.assign.apply(Object, _toConsumableArray(Object.entries(_classPrivateFieldGet2(_config$2, this).aimMeasurementScoring).map(function(_ref) {
        var _ref2 = _slicedToArray(_ref, 2), type = _ref2[0], fn = _ref2[1];
        var val = customResultTypes.hasOwnProperty(type) ? customResultTypes[type](measurements) : measurements[type];
        return val === void 0 ? defaultPoints.hasOwnProperty(type) ? _defineProperty({}, type, defaultPoints[type]) : {} : _defineProperty({}, type, val === void 0 ? 0 : +fn(val));
      })));
      return Object.assign.apply(Object, [{}].concat(_toConsumableArray(Object.entries(_classPrivateFieldGet2(_config$2, this).aimExperiencesDefs).filter(function(_ref5) {
        var _ref6 = _slicedToArray(_ref5, 2), input = _ref6[1].input;
        return input.every(function(k) {
          return scores.hasOwnProperty(k);
        });
      }).map(function(_ref7) {
        var _ref8 = _slicedToArray(_ref7, 2), k = _ref8[0], _ref8$ = _ref8[1], input = _ref8$.input, pointThresholds = _ref8$.pointThresholds;
        var sumPoints = Math.max(0, sum2(input.map(function(k2) {
          return scores[k2];
        })));
        var classificationIdx = threshold(pointThresholds, [0, 1, 2, 3, 4])(sumPoints);
        var classificationName = classificationNames[classificationIdx];
        return _defineProperty({}, k, {
          points: sumPoints,
          classificationIdx,
          classificationName
        });
      }))));
    }
  }]);
})();
var _config$1 = /* @__PURE__ */ new WeakMap();
var _measCalc = /* @__PURE__ */ new WeakMap();
var _scoresCalc = /* @__PURE__ */ new WeakMap();
var _calcGetter = /* @__PURE__ */ new WeakMap();
var _getV4Reachability = /* @__PURE__ */ new WeakMap();
var _getV4ReachabilityDetails = /* @__PURE__ */ new WeakMap();
var _getV6Reachability = /* @__PURE__ */ new WeakMap();
var _getV6ReachabilityDetails = /* @__PURE__ */ new WeakMap();
var Results = (function() {
  function Results2(config) {
    var _this = this;
    _classCallCheck(this, Results2);
    _defineProperty(this, "raw", void 0);
    _defineProperty(this, "getUnloadedLatency", function() {
      return _classPrivateFieldGet2(_calcGetter, _this).call(_this, "getLatency", "latency");
    });
    _defineProperty(this, "getUnloadedJitter", function() {
      return _classPrivateFieldGet2(_calcGetter, _this).call(_this, "getJitter", "latency");
    });
    _defineProperty(this, "getUnloadedLatencyPoints", function() {
      return _classPrivateFieldGet2(_calcGetter, _this).call(_this, "getLatencyPoints", "latency", []);
    });
    _defineProperty(this, "getDownLoadedLatency", function() {
      return _classPrivateFieldGet2(_calcGetter, _this).call(_this, "getLoadedLatency", "download");
    });
    _defineProperty(this, "getDownLoadedJitter", function() {
      return _classPrivateFieldGet2(_calcGetter, _this).call(_this, "getLoadedJitter", "download");
    });
    _defineProperty(this, "getDownLoadedLatencyPoints", function() {
      return _classPrivateFieldGet2(_calcGetter, _this).call(_this, "getLoadedLatencyPoints", "download", []);
    });
    _defineProperty(this, "getUpLoadedLatency", function() {
      return _classPrivateFieldGet2(_calcGetter, _this).call(_this, "getLoadedLatency", "upload");
    });
    _defineProperty(this, "getUpLoadedJitter", function() {
      return _classPrivateFieldGet2(_calcGetter, _this).call(_this, "getLoadedJitter", "upload");
    });
    _defineProperty(this, "getUpLoadedLatencyPoints", function() {
      return _classPrivateFieldGet2(_calcGetter, _this).call(_this, "getLoadedLatencyPoints", "upload", []);
    });
    _defineProperty(this, "getDownloadBandwidth", function() {
      return _classPrivateFieldGet2(_calcGetter, _this).call(_this, "getBandwidth", "download");
    });
    _defineProperty(this, "getDownloadBandwidthPoints", function() {
      return _classPrivateFieldGet2(_calcGetter, _this).call(_this, "getBandwidthPoints", "download", []);
    });
    _defineProperty(this, "getUploadBandwidth", function() {
      return _classPrivateFieldGet2(_calcGetter, _this).call(_this, "getBandwidth", "upload");
    });
    _defineProperty(this, "getUploadBandwidthPoints", function() {
      return _classPrivateFieldGet2(_calcGetter, _this).call(_this, "getBandwidthPoints", "upload", []);
    });
    _defineProperty(this, "getPacketLoss", function() {
      return _classPrivateFieldGet2(_calcGetter, _this).call(_this, "getPacketLoss", "packetLoss");
    });
    _defineProperty(this, "getPacketLossDetails", function() {
      return _classPrivateFieldGet2(_calcGetter, _this).call(_this, "getPacketLossDetails", "packetLoss", void 0, true);
    });
    _defineProperty(this, "getScores", function() {
      return _classPrivateFieldGet2(_scoresCalc, _this).getScores(_this.getSummary());
    });
    _classPrivateFieldInitSpec(this, _config$1, void 0);
    _classPrivateFieldInitSpec(this, _measCalc, void 0);
    _classPrivateFieldInitSpec(this, _scoresCalc, void 0);
    _classPrivateFieldInitSpec(this, _calcGetter, function(calcFn, resKey) {
      var defaultVal = arguments.length > 2 && arguments[2] !== void 0 ? arguments[2] : void 0;
      var surfaceError = arguments.length > 3 && arguments[3] !== void 0 ? arguments[3] : false;
      return !_this.raw.hasOwnProperty(resKey) || !_this.raw[resKey].started ? defaultVal : surfaceError && _this.raw[resKey].error ? {
        error: _this.raw[resKey].error
      } : _classPrivateFieldGet2(_measCalc, _this)[calcFn](_this.raw[resKey].results);
    });
    _classPrivateFieldInitSpec(this, _getV4Reachability, function() {
      return _classPrivateFieldGet2(_calcGetter, _this).call(_this, "getReachability", "v4Reachability");
    });
    _classPrivateFieldInitSpec(this, _getV4ReachabilityDetails, function() {
      return _classPrivateFieldGet2(_calcGetter, _this).call(_this, "getReachabilityDetails", "v4Reachability");
    });
    _classPrivateFieldInitSpec(this, _getV6Reachability, function() {
      return _classPrivateFieldGet2(_calcGetter, _this).call(_this, "getReachability", "v6Reachability");
    });
    _classPrivateFieldInitSpec(this, _getV6ReachabilityDetails, function() {
      return _classPrivateFieldGet2(_calcGetter, _this).call(_this, "getReachabilityDetails", "v6Reachability");
    });
    _classPrivateFieldSet2(_config$1, this, config);
    this.clear();
    _classPrivateFieldSet2(_measCalc, this, new MeasurementCalculations(_classPrivateFieldGet2(_config$1, this)));
    _classPrivateFieldSet2(_scoresCalc, this, new ScoresCalculations(_classPrivateFieldGet2(_config$1, this)));
  }
  return _createClass(Results2, [{
    key: "isFinished",
    get: function get() {
      return Object.values(this.raw).every(function(d) {
        return d.finished;
      });
    }
    // Public methods
  }, {
    key: "clear",
    value: function clear() {
      this.raw = Object.assign.apply(Object, [{}].concat(_toConsumableArray(_toConsumableArray(new Set(_classPrivateFieldGet2(_config$1, this).measurements.map(function(m) {
        return m.type;
      }))).map(function(m) {
        return _defineProperty({}, m, {
          started: false,
          finished: false,
          results: {}
        });
      }))));
    }
  }, {
    key: "getSummary",
    value: function getSummary() {
      var items = {
        download: this.getDownloadBandwidth,
        upload: this.getUploadBandwidth,
        latency: this.getUnloadedLatency,
        jitter: this.getUnloadedJitter,
        downLoadedLatency: this.getDownLoadedLatency,
        downLoadedJitter: this.getDownLoadedJitter,
        upLoadedLatency: this.getUpLoadedLatency,
        upLoadedJitter: this.getUpLoadedJitter,
        packetLoss: this.getPacketLoss,
        v4Reachability: _classPrivateFieldGet2(_getV4Reachability, this),
        v6Reachability: _classPrivateFieldGet2(_getV6Reachability, this)
      };
      return Object.assign.apply(Object, _toConsumableArray(Object.entries(items).map(function(_ref2) {
        var _ref3 = _slicedToArray(_ref2, 2), key = _ref3[0], fn = _ref3[1];
        var val = fn();
        return val === void 0 ? {} : _defineProperty({}, key, val);
      })));
    }
  }]);
})();
var round = function round2(num) {
  var decimals = arguments.length > 1 && arguments[1] !== void 0 ? arguments[1] : 0;
  return !num ? num : Math.round(num * Math.pow(10, decimals)) / Math.pow(10, decimals);
};
var latencyPointsParser = function latencyPointsParser2(durations) {
  return durations.map(function(d) {
    return round(d, 2);
  });
};
var bpsPointsParser = function bpsPointsParser2(pnts) {
  return pnts.map(function(d) {
    return {
      bytes: +d.bytes,
      bps: round(d.bps)
    };
  });
};
var packetLossParser = function packetLossParser2(d) {
  return d.error ? void 0 : {
    numMessages: d.numMessagesSent,
    lossRatio: round(d.packetLoss, 4)
  };
};
var resultsParsers = {
  latencyMs: ["getUnloadedLatencyPoints", latencyPointsParser],
  download: ["getDownloadBandwidthPoints", bpsPointsParser],
  upload: ["getUploadBandwidthPoints", bpsPointsParser],
  downLoadedLatencyMs: ["getDownLoadedLatencyPoints", latencyPointsParser],
  upLoadedLatencyMs: ["getUpLoadedLatencyPoints", latencyPointsParser],
  packetLoss: ["getPacketLossDetails", packetLossParser]
  // v4Reachability: ['getV4ReachabilityDetails'],
  // v6Reachability: ['getV6ReachabilityDetails']
};
var scoreParser = function scoreParser2(d) {
  return {
    points: d.points,
    classification: d.classificationName
  };
};
var logAimResults = function logAimResults2(results, _ref) {
  var apiUrl = _ref.apiUrl, sessionId = _ref.sessionId;
  var logData = {
    sessionId
  };
  Object.entries(resultsParsers).forEach(function(_ref2) {
    var _ref3 = _slicedToArray(_ref2, 2), logK = _ref3[0], _ref3$ = _slicedToArray(_ref3[1], 2), fn = _ref3$[0], _ref3$$ = _ref3$[1], parser = _ref3$$ === void 0 ? function(d) {
      return d;
    } : _ref3$$;
    var val = results[fn]();
    val && (logData[logK] = parser(val));
  });
  var scores = results.getScores();
  scores && (logData.scores = Object.assign.apply(Object, [{}].concat(_toConsumableArray(Object.entries(scores).map(function(_ref4) {
    var _ref5 = _slicedToArray(_ref4, 2), k = _ref5[0], score = _ref5[1];
    return _defineProperty({}, k, scoreParser(score));
  })))));
  fetch(apiUrl, {
    method: "POST",
    body: JSON.stringify(logData)
  });
};
var _excluded = ["type"];
var _excluded2 = ["numPackets"];
var _excluded3 = ["bytes"];
var DEFAULT_OPTIMAL_DOWNLOAD_SIZE = 1e6;
var DEFAULT_OPTIMAL_UPLOAD_SIZE = 1e6;
var OPTIMAL_SIZE_RATIO = 0.5;
var pausableTypes = ["latency", "latencyUnderLoad", "download", "upload"];
var genMeasId = function genMeasId2() {
  return "".concat(Math.round(Math.random() * 1e16));
};
var _onFinish = /* @__PURE__ */ new WeakMap();
var _onError = /* @__PURE__ */ new WeakMap();
var _config = /* @__PURE__ */ new WeakMap();
var _results = /* @__PURE__ */ new WeakMap();
var _measurementId = /* @__PURE__ */ new WeakMap();
var _curMsmIdx = /* @__PURE__ */ new WeakMap();
var _curEngine = /* @__PURE__ */ new WeakMap();
var _optimalDownloadChunkSize = /* @__PURE__ */ new WeakMap();
var _optimalUploadChunkSize = /* @__PURE__ */ new WeakMap();
var _running = /* @__PURE__ */ new WeakMap();
var _finished = /* @__PURE__ */ new WeakMap();
var _MeasurementEngine_brand = /* @__PURE__ */ new WeakSet();
var MeasurementEngine = (function() {
  function MeasurementEngine2() {
    var userConfig = arguments.length > 0 && arguments[0] !== void 0 ? arguments[0] : {};
    _classCallCheck(this, MeasurementEngine2);
    _classPrivateMethodInitSpec(this, _MeasurementEngine_brand);
    _defineProperty(this, "onRunningChange", function() {
    });
    _defineProperty(this, "onResultsChange", function() {
    });
    _classPrivateFieldInitSpec(this, _onFinish, function() {
    });
    _classPrivateFieldInitSpec(this, _onError, function() {
    });
    _classPrivateFieldInitSpec(this, _config, void 0);
    _classPrivateFieldInitSpec(this, _results, void 0);
    _classPrivateFieldInitSpec(this, _measurementId, genMeasId());
    _classPrivateFieldInitSpec(this, _curMsmIdx, -1);
    _classPrivateFieldInitSpec(this, _curEngine, void 0);
    _classPrivateFieldInitSpec(this, _optimalDownloadChunkSize, DEFAULT_OPTIMAL_DOWNLOAD_SIZE);
    _classPrivateFieldInitSpec(this, _optimalUploadChunkSize, DEFAULT_OPTIMAL_UPLOAD_SIZE);
    _classPrivateFieldInitSpec(this, _running, false);
    _classPrivateFieldInitSpec(this, _finished, false);
    _classPrivateFieldSet2(_config, this, Object.assign({}, defaultConfig, userConfig, internalConfig));
    _classPrivateFieldSet2(_results, this, new Results(_classPrivateFieldGet2(_config, this)));
    _classPrivateFieldGet2(_config, this).autoStart && this.play();
  }
  return _createClass(MeasurementEngine2, [{
    key: "results",
    get: function get() {
      return _classPrivateFieldGet2(_results, this);
    }
  }, {
    key: "isRunning",
    get: function get() {
      return _classPrivateFieldGet2(_running, this);
    }
  }, {
    key: "isFinished",
    get: function get() {
      return _classPrivateFieldGet2(_finished, this);
    }
  }, {
    key: "onFinish",
    set: (
      // callback invoked when all the measurements are finished
      function set2(f) {
        _classPrivateFieldSet2(_onFinish, this, f);
      }
    )
  }, {
    key: "onError",
    set: (
      // callback invoked if an error occurs during measurement
      function set2(f) {
        _classPrivateFieldSet2(_onError, this, f);
      }
    )
    // Public methods
  }, {
    key: "pause",
    value: function pause() {
      pausableTypes.includes(_assertClassBrand(_MeasurementEngine_brand, this, _curType).call(this)) && _classPrivateFieldGet2(_curEngine, this).pause();
      _assertClassBrand(_MeasurementEngine_brand, this, _setRunning).call(this, false);
    }
  }, {
    key: "play",
    value: function play() {
      if (!_classPrivateFieldGet2(_running, this)) {
        _assertClassBrand(_MeasurementEngine_brand, this, _setRunning).call(this, true);
        _assertClassBrand(_MeasurementEngine_brand, this, _next).call(this);
      }
    }
  }, {
    key: "restart",
    value: function restart() {
      _assertClassBrand(_MeasurementEngine_brand, this, _clear).call(this);
      this.play();
    }
  }]);
})();
function _setRunning(running) {
  if (running !== _classPrivateFieldGet2(_running, this)) {
    _classPrivateFieldSet2(_running, this, running);
    this.onRunningChange(_classPrivateFieldGet2(_running, this));
  }
}
function _setFinished(finished) {
  var _this3 = this;
  if (finished !== _classPrivateFieldGet2(_finished, this)) {
    _classPrivateFieldSet2(_finished, this, finished);
    finished && setTimeout(function() {
      return _classPrivateFieldGet2(_onFinish, _this3).call(_this3, _this3.results);
    });
  }
}
function _curType() {
  return _classPrivateFieldGet2(_curMsmIdx, this) < 0 || _classPrivateFieldGet2(_curMsmIdx, this) >= _classPrivateFieldGet2(_config, this).measurements.length ? null : _classPrivateFieldGet2(_config, this).measurements[_classPrivateFieldGet2(_curMsmIdx, this)].type;
}
function _curTypeResults() {
  return _classPrivateFieldGet2(_results, this).raw[_assertClassBrand(_MeasurementEngine_brand, this, _curType).call(this)] || void 0;
}
function _clear() {
  _assertClassBrand(_MeasurementEngine_brand, this, _destroyCurEngine).call(this);
  _classPrivateFieldSet2(_measurementId, this, genMeasId());
  _classPrivateFieldSet2(_curMsmIdx, this, -1);
  _classPrivateFieldSet2(_curEngine, this, void 0);
  _assertClassBrand(_MeasurementEngine_brand, this, _setRunning).call(this, false);
  _assertClassBrand(_MeasurementEngine_brand, this, _setFinished).call(this, false);
  _classPrivateFieldGet2(_results, this).clear();
}
function _destroyCurEngine() {
  var engine = _classPrivateFieldGet2(_curEngine, this);
  if (!engine) return;
  engine.onFinished = engine.onConnectionError = engine.onFail = engine.onMsgReceived = engine.onCredentialsFailure = engine.onMeasurementResult = function() {
  };
  pausableTypes.includes(_assertClassBrand(_MeasurementEngine_brand, this, _curType).call(this)) && engine.pause();
}
function _next() {
  var _this4 = this;
  var _this$curMsmIdx;
  if (pausableTypes.includes(_assertClassBrand(_MeasurementEngine_brand, this, _curType).call(this)) && _assertClassBrand(_MeasurementEngine_brand, this, _curTypeResults).call(this) && _assertClassBrand(_MeasurementEngine_brand, this, _curTypeResults).call(this).started && !_assertClassBrand(_MeasurementEngine_brand, this, _curTypeResults).call(this).finished && !_assertClassBrand(_MeasurementEngine_brand, this, _curTypeResults).call(this).finishedCurrentRound && !_assertClassBrand(_MeasurementEngine_brand, this, _curTypeResults).call(this).error) {
    _classPrivateFieldGet2(_curEngine, this).play();
    return;
  }
  _classPrivateFieldSet2(_curMsmIdx, this, (_this$curMsmIdx = _classPrivateFieldGet2(_curMsmIdx, this), _this$curMsmIdx++, _this$curMsmIdx));
  if (_classPrivateFieldGet2(_curMsmIdx, this) >= _classPrivateFieldGet2(_config, this).measurements.length) {
    _assertClassBrand(_MeasurementEngine_brand, this, _setRunning).call(this, false);
    _assertClassBrand(_MeasurementEngine_brand, this, _setFinished).call(this, true);
    return;
  }
  var _classPrivateFieldGet2$1 = _classPrivateFieldGet2(_config, this).measurements[_classPrivateFieldGet2(_curMsmIdx, this)], type = _classPrivateFieldGet2$1.type, msmConfig = _objectWithoutProperties(_classPrivateFieldGet2$1, _excluded);
  var msmResults = _assertClassBrand(_MeasurementEngine_brand, this, _curTypeResults).call(this);
  var _classPrivateFieldGet3 = _classPrivateFieldGet2(_config, this), downloadApiUrl = _classPrivateFieldGet3.downloadApiUrl, uploadApiUrl = _classPrivateFieldGet3.uploadApiUrl, estimatedServerTime = _classPrivateFieldGet3.estimatedServerTime;
  var engine;
  switch (type) {
    case "v4Reachability":
    case "v6Reachability":
      engine = new ReachabilityEngine("https://".concat(msmConfig.host), {
        fetchOptions: {
          method: "GET",
          mode: "no-cors"
        }
      });
      engine.onFinished = function(result) {
        msmResults.finished = true;
        msmResults.results = _objectSpread2({
          host: msmConfig.host
        }, result);
        _this4.onResultsChange({
          type
        });
        _assertClassBrand(_MeasurementEngine_brand, _this4, _next).call(_this4);
      };
      break;
    case "rpki":
      engine = new ReachabilityEngine("https://".concat(_classPrivateFieldGet2(_config, this).rpkiInvalidHost), {
        timeout: 5e3
      });
      engine.onFinished = function(result) {
        (result.response ? result.response.json() : Promise.resolve()).then(function(response) {
          msmResults.finished = true;
          msmResults.results = _objectSpread2({
            host: _classPrivateFieldGet2(_config, _this4).rpkiInvalidHost,
            filteringInvalids: !result.reachable
          }, response ? {
            asn: response.asn,
            name: response.name
          } : {});
          _this4.onResultsChange({
            type
          });
          _assertClassBrand(_MeasurementEngine_brand, _this4, _next).call(_this4);
        });
      };
      break;
    case "nxdomain":
      engine = new ReachabilityEngine("https://".concat(msmConfig.nxhost), {
        fetchOptions: {
          mode: "no-cors"
        }
      });
      engine.onFinished = function(result) {
        msmResults.finished = true;
        msmResults.results = {
          host: msmConfig.nxhost,
          reachable: result.reachable
        };
        _this4.onResultsChange({
          type
        });
        _assertClassBrand(_MeasurementEngine_brand, _this4, _next).call(_this4);
      };
      break;
    case "packetLoss":
    case "packetLossUnderLoad":
      {
        msmResults.finished = false;
        var numMsgs = msmConfig.numPackets, ptCfg = _objectWithoutProperties(msmConfig, _excluded2);
        var _classPrivateFieldGet4 = _classPrivateFieldGet2(_config, this), turnServerUri = _classPrivateFieldGet4.turnServerUri, turnServerCredsApi = _classPrivateFieldGet4.turnServerCredsApiUrl, turnServerUser = _classPrivateFieldGet4.turnServerUser, turnServerPass = _classPrivateFieldGet4.turnServerPass, includeCredentials = _classPrivateFieldGet4.includeCredentials;
        engine = new PacketLossUnderLoadEngine(_objectSpread2({
          turnServerUri,
          turnServerCredsApi,
          turnServerCredsApiIncludeCredentials: includeCredentials,
          turnServerUser,
          turnServerPass,
          numMsgs,
          // if under load
          downloadChunkSize: msmConfig.loadDown ? _classPrivateFieldGet2(_optimalDownloadChunkSize, this) : void 0,
          uploadChunkSize: msmConfig.loadUp ? _classPrivateFieldGet2(_optimalUploadChunkSize, this) : void 0,
          downloadApiUrl,
          uploadApiUrl
        }, ptCfg));
      }
      engine.onMsgReceived = function() {
        msmResults.results = Object.assign({}, engine.results);
        _this4.onResultsChange({
          type
        });
      };
      engine.onFinished = function() {
        msmResults.finished = true;
        _this4.onResultsChange({
          type
        });
        _assertClassBrand(_MeasurementEngine_brand, _this4, _next).call(_this4);
      };
      engine.onConnectionError = function(e) {
        msmResults.error = e;
        _this4.onResultsChange({
          type
        });
        _classPrivateFieldGet2(_onError, _this4).call(_this4, "Connection error while measuring packet loss: ".concat(e));
        _assertClassBrand(_MeasurementEngine_brand, _this4, _next).call(_this4);
      };
      engine.onCredentialsFailure = function() {
        msmResults.error = "unable to get turn server credentials";
        _this4.onResultsChange({
          type
        });
        _classPrivateFieldGet2(_onError, _this4).call(_this4, "Error while measuring packet loss: unable to get turn server credentials.");
        _assertClassBrand(_MeasurementEngine_brand, _this4, _next).call(_this4);
      };
      break;
    case "latency":
    case "latencyUnderLoad":
      msmResults.finished = false;
      engine = new LoggingBandwidthEngine([{
        dir: "down",
        bytes: 0,
        count: msmConfig.numPackets,
        bypassMinDuration: true
      }], {
        downloadApiUrl,
        uploadApiUrl,
        estimatedServerTime,
        logApiUrl: _classPrivateFieldGet2(_config, this).logMeasurementApiUrl,
        measurementId: _classPrivateFieldGet2(_measurementId, this),
        sessionId: _classPrivateFieldGet2(_config, this).sessionId,
        // if under load
        downloadChunkSize: msmConfig.loadDown ? _classPrivateFieldGet2(_optimalDownloadChunkSize, this) : void 0,
        uploadChunkSize: msmConfig.loadUp ? _classPrivateFieldGet2(_optimalUploadChunkSize, this) : void 0
      });
      engine.fetchOptions = {
        credentials: _classPrivateFieldGet2(_config, this).includeCredentials ? "include" : void 0
      };
      engine.onMeasurementResult = engine.onNewMeasurementStarted = function(meas, results) {
        msmResults.results = Object.assign({}, results.down[0]);
        _this4.onResultsChange({
          type
        });
      };
      engine.onFinished = function() {
        msmResults.finished = true;
        _this4.onResultsChange({
          type
        });
        _classPrivateFieldGet2(_running, _this4) && _assertClassBrand(_MeasurementEngine_brand, _this4, _next).call(_this4);
      };
      engine.onConnectionError = function(e) {
        msmResults.error = e;
        _this4.onResultsChange({
          type
        });
        _classPrivateFieldGet2(_onError, _this4).call(_this4, "Connection error while measuring latency: ".concat(e));
        _assertClassBrand(_MeasurementEngine_brand, _this4, _next).call(_this4);
      };
      engine.play();
      break;
    case "download":
    case "upload":
      if (msmResults.finished || msmResults.error) {
        _assertClassBrand(_MeasurementEngine_brand, this, _next).call(this);
      } else {
        delete msmResults.finishedCurrentRound;
        var measureParallelLatency = _classPrivateFieldGet2(_config, this)["measure".concat(type === "download" ? "Down" : "Up", "loadLoadedLatency")];
        engine = new LoggingBandwidthEngine([_objectSpread2({
          dir: type === "download" ? "down" : "up"
        }, msmConfig)], {
          downloadApiUrl,
          uploadApiUrl,
          estimatedServerTime,
          logApiUrl: _classPrivateFieldGet2(_config, this).logMeasurementApiUrl,
          measurementId: _classPrivateFieldGet2(_measurementId, this),
          measureParallelLatency,
          parallelLatencyThrottleMs: _classPrivateFieldGet2(_config, this).loadedLatencyThrottle,
          sessionId: _classPrivateFieldGet2(_config, this).sessionId
        });
        engine.fetchOptions = {
          credentials: _classPrivateFieldGet2(_config, this).includeCredentials ? "include" : void 0
        };
        engine.finishRequestDuration = _classPrivateFieldGet2(_config, this).bandwidthFinishRequestDuration;
        engine.onNewMeasurementStarted = function(_ref) {
          var count2 = _ref.count, bytes = _ref.bytes;
          var res = msmResults.results = Object.assign({}, msmResults.results);
          !res.hasOwnProperty(bytes) && (res[bytes] = {
            timings: [],
            numMeasurements: 0,
            sideLatency: measureParallelLatency ? [] : void 0
          });
          if (res[bytes].numMeasurements - res[bytes].timings.length !== count2) {
            res[bytes].numMeasurements += count2;
            _this4.onResultsChange({
              type
            });
          }
        };
        engine.onMeasurementResult = function(_ref2) {
          var bytes = _ref2.bytes, timing = _objectWithoutProperties(_ref2, _excluded3);
          msmResults.results[bytes].timings.push(timing);
          msmResults.results = Object.assign({}, msmResults.results);
          _this4.onResultsChange({
            type
          });
        };
        engine.onParallelLatencyResult = function(res) {
          msmResults.results[msmConfig.bytes].sideLatency.push(res);
          msmResults.results = Object.assign({}, msmResults.results);
          _this4.onResultsChange({
            type
          });
        };
        engine.onFinished = function(results) {
          var isLastMsmOfType = !_classPrivateFieldGet2(_config, _this4).measurements.slice(_classPrivateFieldGet2(_curMsmIdx, _this4) + 1).map(function(d) {
            return d.type;
          }).includes(type);
          var minDuration = Math.min.apply(Math, _toConsumableArray(Object.values(type === "download" ? results.down : results.up).slice(-1)[0].timings.map(function(d) {
            return d.duration;
          })));
          var reachedEndOfMsmType = isLastMsmOfType || !msmConfig.bypassMinDuration && minDuration > _classPrivateFieldGet2(_config, _this4).bandwidthFinishRequestDuration;
          if (!reachedEndOfMsmType) {
            msmResults.finishedCurrentRound = true;
          } else {
            msmResults.finished = true;
            _this4.onResultsChange({
              type
            });
            var largestSize = Object.keys(msmResults.results).map(function(n) {
              return +n;
            }).sort(function(a, b) {
              return b - a;
            })[0];
            var optimalSize = largestSize * OPTIMAL_SIZE_RATIO;
            type === "download" && _classPrivateFieldSet2(_optimalDownloadChunkSize, _this4, optimalSize);
            type === "upload" && _classPrivateFieldSet2(_optimalUploadChunkSize, _this4, optimalSize);
          }
          _classPrivateFieldGet2(_running, _this4) && _assertClassBrand(_MeasurementEngine_brand, _this4, _next).call(_this4);
        };
        engine.onConnectionError = function(e) {
          msmResults.error = e;
          _this4.onResultsChange({
            type
          });
          _classPrivateFieldGet2(_onError, _this4).call(_this4, "Connection error while measuring ".concat(type, ": ").concat(e));
          _assertClassBrand(_MeasurementEngine_brand, _this4, _next).call(_this4);
        };
        engine.play();
      }
      break;
  }
  _classPrivateFieldSet2(_curEngine, this, engine);
  msmResults.started = true;
  this.onResultsChange({
    type
  });
}
var _logAimApiUrl = /* @__PURE__ */ new WeakMap();
var _sessionId = /* @__PURE__ */ new WeakMap();
var _logFinalResults = /* @__PURE__ */ new WeakMap();
var LoggingMeasurementEngine = (function(_MeasurementEngine2) {
  function LoggingMeasurementEngine2(userConfig) {
    var _this;
    _classCallCheck(this, LoggingMeasurementEngine2);
    for (var _len = arguments.length, pt = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
      pt[_key - 1] = arguments[_key];
    }
    _this = _callSuper(this, LoggingMeasurementEngine2, [userConfig].concat(pt));
    _classPrivateFieldInitSpec(_this, _logAimApiUrl, void 0);
    _classPrivateFieldInitSpec(_this, _sessionId, void 0);
    _classPrivateFieldInitSpec(_this, _logFinalResults, function(results) {
      _classPrivateFieldGet2(_logAimApiUrl, _this) && logAimResults(results, {
        apiUrl: _classPrivateFieldGet2(_logAimApiUrl, _this),
        sessionId: _classPrivateFieldGet2(_sessionId, _this)
      });
    });
    _superPropSet(LoggingMeasurementEngine2, "onFinish", _classPrivateFieldGet2(_logFinalResults, _this), _this, 1);
    var config = Object.assign({}, defaultConfig, userConfig, internalConfig);
    _classPrivateFieldSet2(_logAimApiUrl, _this, config.logAimApiUrl);
    _classPrivateFieldSet2(_sessionId, _this, config.sessionId);
    return _this;
  }
  _inherits(LoggingMeasurementEngine2, _MeasurementEngine2);
  return _createClass(LoggingMeasurementEngine2, [{
    key: "onFinish",
    set: function set2(onFinish) {
      var _this2 = this;
      _superPropSet(LoggingMeasurementEngine2, "onFinish", function(results) {
        onFinish(results);
        _classPrivateFieldGet2(_logFinalResults, _this2).call(_this2, results);
      }, this, 1);
    }
  }]);
})(MeasurementEngine);
export {
  LoggingMeasurementEngine as default
};
//# sourceMappingURL=@cloudflare_speedtest.js.map
